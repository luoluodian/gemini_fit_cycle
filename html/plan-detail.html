<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¡åˆ’è¯¦æƒ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        .hero-title {
            font-family: 'Noto Serif SC', serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-tab {
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background: #10b981;
            color: white;
        }
        .day-card {
            transition: all 0.3s ease;
        }
        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .phase-card {
            transition: all 0.3s ease;
        }
        .template-preview {
            transition: all 0.2s ease;
        }
        .template-preview:hover {
            background-color: rgba(16, 185, 129, 0.05);
        }
        .meal-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="goBack()" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="ml-2">
                        <h1 class="hero-title text-xl font-bold text-gray-800" id="planName">è®¡åˆ’è¯¦æƒ…</h1>
                        <p class="text-sm text-gray-500" id="planSubtitle">æŸ¥çœ‹å’Œç®¡ç†ä½ çš„é¥®é£Ÿè®¡åˆ’</p>
                    </div>
                </div>
                <button onclick="showPlanOptions()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-6 space-y-6">
        <!-- è®¡åˆ’æ¦‚è§ˆå¡ç‰‡ - æ–°è®¾è®¡ -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
            <!-- ç¬¬ä¸€è¡Œï¼šçŠ¶æ€æ ‡ç­¾ + è¿›åº¦ç™¾åˆ†æ¯” -->
            <div class="flex items-center justify-between mb-4">
                <span id="planStatus" class="inline-flex items-center px-2.5 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full">
                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5"></span>
                    è¿›è¡Œä¸­
                </span>
                <span class="text-2xl font-bold text-emerald-600" id="progressPercent">40%</span>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šå¤©æ•°å¤§æ•°å­— + è®¡åˆ’ç±»å‹ä¿¡æ¯ -->
            <div class="flex items-end justify-between mb-5">
                <div>
                    <div class="flex items-baseline">
                        <span class="text-5xl font-bold text-gray-800" id="daysCompleted">12</span>
                        <span class="text-xl text-gray-400 ml-1">/<span id="totalDays">21</span>å¤©</span>
                    </div>
                    <div class="text-sm text-gray-500 mt-1">å·²å®Œæˆ</div>
                </div>
                <div class="text-right pb-1">
                    <div class="text-sm text-gray-600" id="planType">å¸¸è§„è®¡åˆ’</div>
                    <div class="text-xs text-gray-400 mt-0.5" id="cycleInfo">7å¤© Ã— 3å‘¨æœŸ</div>
                </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="w-full bg-gray-100 rounded-full h-2.5 mb-5">
                <div id="progressBar" class="bg-gradient-to-r from-emerald-500 to-emerald-400 h-2.5 rounded-full transition-all duration-500" style="width: 40%"></div>
            </div>

            <!-- è®¡åˆ’æ—¥ç¨‹ - æŒ‰å‘¨æœŸåˆ†ç»„æ˜¾ç¤º -->
            <div class="bg-gray-50 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-gray-700">è®¡åˆ’æ—¥ç¨‹</span>
                    <span class="text-xs text-emerald-600" id="remainingDaysText">è¿˜å‰© 9 å¤©</span>
                </div>
                
                <!-- å‘¨æœŸåˆ—è¡¨å®¹å™¨ -->
                <div id="scheduleContainer" class="space-y-4 max-h-64 overflow-y-auto">
                    <!-- åŠ¨æ€ç”Ÿæˆå‘¨æœŸå†…å®¹ -->
                </div>
                
                <!-- å›¾ä¾‹ -->
                <div class="mt-3 pt-3 border-t border-gray-200 flex items-center justify-center space-x-4 text-xs">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded bg-emerald-500 mr-1"></div>
                        <span class="text-gray-500">å·²å®Œæˆ</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded bg-white border-2 border-emerald-500 mr-1"></div>
                        <span class="text-gray-500">ä»Šå¤©</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded bg-gray-200 mr-1"></div>
                        <span class="text-gray-500">å¾…å®Œæˆ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¢³å¾ªç¯é…ç½®ï¼ˆä»…ç¢³å¾ªç¯è®¡åˆ’æ˜¾ç¤ºï¼‰ -->
        <div id="carbCycleSection" class="glass-card rounded-2xl p-5 shadow-lg hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">ç¢³å¾ªç¯é…ç½®</h3>
                <span class="text-xs text-gray-500">åŸºäºä½“é‡è®¡ç®—</span>
            </div>
            
            <!-- ä½“é‡ä¸è¥å…»ç´ åŸºå‡† -->
            <div class="bg-white rounded-xl p-4 mb-4 border border-emerald-100 shadow-sm">
                <!-- ç¬¬ä¸€è¡Œï¼šä½“é‡ -->
                <div class="flex items-center justify-center mb-4 pb-3 border-b border-gray-100">
                    <div class="text-center">
                        <div class="flex items-center justify-center mb-1">
                            <svg class="w-4 h-4 text-emerald-500 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                            </svg>
                            <span class="text-xs text-gray-500">å½“å‰ä½“é‡</span>
                        </div>
                        <div class="flex items-baseline justify-center">
                            <span class="text-3xl font-bold text-gray-800" id="bodyWeight">70</span>
                            <span class="text-base text-gray-500 ml-1">kg</span>
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬äºŒè¡Œï¼šè¥å…»ç´ åŸºå‡† -->
                <div>
                    <div class="text-xs text-gray-400 text-center mb-2">è¥å…»ç´ é…æ¯”ï¼ˆæ¯kgä½“é‡ï¼‰</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center p-2 bg-blue-50 rounded-lg">
                            <div class="text-xs text-blue-500 mb-0.5">è›‹ç™½è´¨</div>
                            <div class="text-sm font-semibold text-blue-700" id="proteinBase">2.0g</div>
                        </div>
                        <div class="text-center p-2 bg-yellow-50 rounded-lg">
                            <div class="text-xs text-yellow-500 mb-0.5">ç¢³æ°´</div>
                            <div class="text-sm font-semibold text-yellow-700" id="carbsBase">3.0g</div>
                        </div>
                        <div class="text-center p-2 bg-red-50 rounded-lg">
                            <div class="text-xs text-red-500 mb-0.5">è„‚è‚ª</div>
                            <div class="text-sm font-semibold text-red-700" id="fatBase">0.8g</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é˜¶æ®µåˆ†é… -->
            <div class="space-y-3" id="phaseList">
                <!-- é«˜ç¢³æ—¥ -->
                <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center mr-2">
                                <span class="text-base">ğŸ”¥</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">é«˜ç¢³æ—¥</h4>
                                <div class="text-xs text-yellow-600">é«˜ç¢³æ°´é…ç½®</div>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="highDays">2å¤©/å‘¨æœŸ</span>
                    </div>
                    <div class="bg-white/70 rounded-lg p-2 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div class="text-xs text-gray-400">è›‹ç™½è´¨</div><div class="font-semibold text-blue-600">140g</div></div>
                        <div><div class="text-xs text-gray-400">ç¢³æ°´</div><div class="font-semibold text-yellow-600">315g</div></div>
                        <div><div class="text-xs text-gray-400">è„‚è‚ª</div><div class="font-semibold text-red-600">39g</div></div>
                        <div><div class="text-xs text-gray-400">çƒ­é‡</div><div class="font-semibold text-gray-700">2151</div></div>
                    </div>
                </div>

                <!-- ä¸­ç¢³æ—¥ -->
                <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center mr-2">
                                <span class="text-base">âš–ï¸</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">ä¸­ç¢³æ—¥</h4>
                                <div class="text-xs text-emerald-600">åŸºå‡†é…ç½®</div>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="mediumDays">3å¤©/å‘¨æœŸ</span>
                    </div>
                    <div class="bg-white/70 rounded-lg p-2 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div class="text-xs text-gray-400">è›‹ç™½è´¨</div><div class="font-semibold text-blue-600">140g</div></div>
                        <div><div class="text-xs text-gray-400">ç¢³æ°´</div><div class="font-semibold text-emerald-600">210g</div></div>
                        <div><div class="text-xs text-gray-400">è„‚è‚ª</div><div class="font-semibold text-red-600">56g</div></div>
                        <div><div class="text-xs text-gray-400">çƒ­é‡</div><div class="font-semibold text-gray-700">1804</div></div>
                    </div>
                </div>

                <!-- ä½ç¢³æ—¥ -->
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                                <span class="text-base">â„ï¸</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">ä½ç¢³æ—¥</h4>
                                <div class="text-xs text-blue-600">ä½ç¢³æ°´é…ç½®</div>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="lowDays">2å¤©/å‘¨æœŸ</span>
                    </div>
                    <div class="bg-white/70 rounded-lg p-2 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div class="text-xs text-gray-400">è›‹ç™½è´¨</div><div class="font-semibold text-blue-600">140g</div></div>
                        <div><div class="text-xs text-gray-400">ç¢³æ°´</div><div class="font-semibold text-blue-600">105g</div></div>
                        <div><div class="text-xs text-gray-400">è„‚è‚ª</div><div class="font-semibold text-red-600">56g</div></div>
                        <div><div class="text-xs text-gray-400">çƒ­é‡</div><div class="font-semibold text-gray-700">1456</div></div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- è®¡åˆ’é€‰é¡¹å¼¹æ¡† -->
    <div id="planOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-end justify-center min-h-screen p-0">
            <div class="bg-white rounded-t-3xl w-full p-6">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">è®¡åˆ’é€‰é¡¹</h3>
                <div class="space-y-3">
                    <button onclick="editPlan()" class="w-full flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span class="text-gray-800">ç¼–è¾‘è®¡åˆ’</span>
                    </button>
                    <button onclick="sharePlan()" class="w-full flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                        </svg>
                        <span class="text-gray-800">åˆ†äº«è®¡åˆ’</span>
                    </button>
                    <button onclick="exportPlan()" class="w-full flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span class="text-gray-800">å¯¼å‡ºè®¡åˆ’</span>
                    </button>
                    <button onclick="pausePlanFromOptions()" id="optionsPauseBtn" class="w-full flex items-center p-4 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition-colors">
                        <svg class="w-5 h-5 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-yellow-700">æš‚åœè®¡åˆ’</span>
                    </button>
                    <button onclick="resumePlanFromOptions()" id="optionsResumeBtn" class="w-full flex items-center p-4 bg-emerald-50 rounded-xl hover:bg-emerald-100 transition-colors hidden">
                        <svg class="w-5 h-5 text-emerald-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-emerald-700">ç»§ç»­è®¡åˆ’</span>
                    </button>
                    <button onclick="showDeleteConfirmFromOptions()" class="w-full flex items-center p-4 bg-red-50 rounded-xl hover:bg-red-100 transition-colors">
                        <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span class="text-red-700">åˆ é™¤è®¡åˆ’</span>
                    </button>
                </div>
                <button onclick="closePlanOptions()" class="w-full mt-4 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹æ¡† -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">ç¡®è®¤åˆ é™¤</h3>
                    <p class="text-sm text-gray-500 mt-2">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¥®é£Ÿè®¡åˆ’å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeDeleteConfirm()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmDeletePlan()" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                        ç¡®è®¤åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å– URL å‚æ•°
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // è®¡åˆ’æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰- ä¸åˆ›å»ºæµç¨‹å¯¹åº”çš„æ•°æ®ç»“æ„
        const planData = {
            plan1: {
                name: '6å‘¨å‡è„‚è®¡åˆ’',
                type: 'carb-cycle',  // carb-cycle æˆ– normal
                typeName: 'ç¢³å¾ªç¯',
                status: 'active',
                cycleDays: 7,
                cycleCount: 6,
                totalDays: 42,
                completedDays: 17,
                dailyCalories: 1800,
                remainingDays: 25,
                startDate: '2025-01-01',
                // ç¢³å¾ªç¯é…ç½®
                carbCycle: {
                    bodyWeight: 70,
                    proteinPerKg: 2.0,
                    carbsPerKg: 3.0,
                    fatPerKg: 0.8,
                    phases: {
                        high: { name: 'é«˜ç¢³æ—¥', days: 2, proteinRatio: 1.0, carbRatio: 1.5, fatRatio: 0.7, color: 'yellow' },
                        medium: { name: 'ä¸­ç¢³æ—¥', days: 3, proteinRatio: 1.0, carbRatio: 1.0, fatRatio: 1.0, color: 'emerald' },
                        low: { name: 'ä½ç¢³æ—¥', days: 2, proteinRatio: 1.0, carbRatio: 0.5, fatRatio: 1.3, color: 'blue' }
                    }
                },
                // å¸¸è§„è®¡åˆ’é…ç½®
                normal: {
                    carbs: 180,
                    protein: 120,
                    fat: 50
                },
                // æ—¥æ¨¡æ¿
                templates: [
                    { day: 1, cycle: 1, phase: 'high', calories: 2151, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 2, cycle: 1, phase: 'medium', calories: 1804, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 3, cycle: 1, phase: 'low', calories: 1456, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 4, cycle: 1, phase: 'high', calories: 2151, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 5, cycle: 1, phase: 'medium', calories: 1804, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 6, cycle: 1, phase: 'medium', calories: 1804, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 7, cycle: 1, phase: 'low', calories: 1456, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] }
                ]
            },
            plan2: {
                name: 'å¢è‚Œè®­ç»ƒè®¡åˆ’',
                type: 'normal',
                typeName: 'å¸¸è§„',
                status: 'paused',
                cycleDays: 7,
                cycleCount: 8,
                totalDays: 56,
                completedDays: 18,
                dailyCalories: 2200,
                remainingDays: 38,
                startDate: '2024-12-01',
                carbCycle: null,
                normal: {
                    carbs: 250,
                    protein: 150,
                    fat: 70
                },
                templates: [
                    { day: 1, cycle: 1, phase: null, calories: 2200, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 2, cycle: 1, phase: null, calories: 2200, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] },
                    { day: 3, cycle: 1, phase: null, calories: 2200, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] }
                ]
            },
            plan3: {
                name: '21å¤©è½»æ–­é£Ÿ',
                type: 'normal',
                typeName: 'å¸¸è§„',
                status: 'completed',
                cycleDays: 7,
                cycleCount: 3,
                totalDays: 21,
                completedDays: 21,
                dailyCalories: 1600,
                remainingDays: 0,
                startDate: '2024-11-01',
                carbCycle: null,
                normal: {
                    carbs: 150,
                    protein: 100,
                    fat: 45
                },
                templates: [
                    { day: 1, cycle: 1, phase: null, calories: 2200, meals: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'åŠ é¤'] }
                ]
            }
        };

        let currentPlanId = null;
        let currentPlan = null;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            currentPlanId = getUrlParam('id');
            if (!currentPlanId || !planData[currentPlanId]) {
                goBack();
                return;
            }
            
            currentPlan = planData[currentPlanId];
            renderPlanDetail();
        });

        // æ¸²æŸ“è®¡åˆ’è¯¦æƒ…
        function renderPlanDetail() {
            // è®¾ç½®æ ‡é¢˜
            document.getElementById('planName').textContent = currentPlan.name;
            document.getElementById('planSubtitle').textContent = `${currentPlan.typeName}è®¡åˆ’ Â· ${currentPlan.totalDays}å¤©`;
            
            // è®¾ç½®çŠ¶æ€
            const statusEl = document.getElementById('planStatus');
            const statusMap = {
                'active': { text: 'è¿›è¡Œä¸­', class: 'bg-emerald-100 text-emerald-700' },
                'paused': { text: 'å·²æš‚åœ', class: 'bg-yellow-100 text-yellow-700' },
                'completed': { text: 'å·²å®Œæˆ', class: 'bg-green-100 text-green-700' }
            };
            const status = statusMap[currentPlan.status];
            statusEl.innerHTML = `<span class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5"></span>${status.text}`;
            statusEl.className = `inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full ${status.class}`;
            
            // è®¾ç½®ç±»å‹
            document.getElementById('planType').textContent = currentPlan.typeName + 'è®¡åˆ’';
            document.getElementById('cycleInfo').textContent = `${currentPlan.cycleDays}å¤© Ã— ${currentPlan.cycleCount}å‘¨æœŸ`;
            
            // è®¡ç®—è¿›åº¦
            const progress = Math.round((currentPlan.completedDays / currentPlan.totalDays) * 100);
            document.getElementById('progressPercent').textContent = progress + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            
            // è®¾ç½®å¤©æ•°
            document.getElementById('daysCompleted').textContent = currentPlan.completedDays;
            document.getElementById('totalDays').textContent = currentPlan.totalDays;
            
            // è®¾ç½®å‰©ä½™å¤©æ•°
            document.getElementById('remainingDaysText').textContent = `è¿˜å‰© ${currentPlan.remainingDays} å¤©`;
            
            // æ ¹æ®è®¡åˆ’ç±»å‹æ˜¾ç¤ºä¸åŒé…ç½®
            if (currentPlan.type === 'carb-cycle' && currentPlan.carbCycle) {
                document.getElementById('carbCycleSection').classList.remove('hidden');
                renderCarbCycleConfig();
            } else {
                document.getElementById('carbCycleSection').classList.add('hidden');
            }
            
            // æ¸²æŸ“è®¡åˆ’æ—¥ç¨‹
            renderSchedule();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateActionButtons();
        }

        // æ¸²æŸ“è®¡åˆ’å®Œæ•´æ—¥ç¨‹ - æŒ‰å‘¨æœŸåˆ†ç»„æ˜¾ç¤º
        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            
            const todayDay = currentPlan.completedDays + 1; // ä»Šå¤©åº”è¯¥æ‰§è¡Œçš„å¤©æ•°
            
            // æŒ‰å‘¨æœŸç”Ÿæˆæ—¥ç¨‹
            for (let cycle = 1; cycle <= currentPlan.cycleCount; cycle++) {
                const cycleStartDay = (cycle - 1) * currentPlan.cycleDays + 1;
                const cycleEndDay = cycle * currentPlan.cycleDays;
                
                // åˆ¤æ–­è¯¥å‘¨æœŸçŠ¶æ€
                let cycleStatus = 'pending';
                if (currentPlan.completedDays >= cycleEndDay) {
                    cycleStatus = 'completed';
                } else if (currentPlan.completedDays >= cycleStartDay - 1) {
                    cycleStatus = 'current';
                }
                
                // åˆ›å»ºå‘¨æœŸå¡ç‰‡
                const cycleCard = document.createElement('div');
                cycleCard.className = 'bg-white rounded-lg p-3 border border-gray-100';
                
                // å‘¨æœŸæ ‡é¢˜
                const cycleHeader = document.createElement('div');
                cycleHeader.className = 'flex items-center justify-between mb-2';
                const statusBadge = cycleStatus === 'completed'
                    ? '<span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">å·²å®Œæˆ</span>'
                    : cycleStatus === 'current'
                        ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">è¿›è¡Œä¸­</span>'
                        : '<span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">å¾…å¼€å§‹</span>';
                cycleHeader.innerHTML = `
                    <span class="text-sm font-medium text-gray-700">ç¬¬ ${cycle} å‘¨æœŸ</span>
                    ${statusBadge}
                `;
                cycleCard.appendChild(cycleHeader);
                
                // å¤©æ•°ç½‘æ ¼
                const daysGrid = document.createElement('div');
                daysGrid.className = 'grid grid-cols-7 gap-1.5';
                
                // ç”Ÿæˆè¯¥å‘¨æœŸçš„æ¯å¤©
                for (let dayInCycle = 1; dayInCycle <= currentPlan.cycleDays; dayInCycle++) {
                    const dayNumber = cycleStartDay + dayInCycle - 1;
                    const templateIndex = (dayInCycle - 1) % currentPlan.templates.length;
                    const template = currentPlan.templates[templateIndex];
                    
                    // åˆ¤æ–­å¤©æ•°çŠ¶æ€
                    let dayStatus = 'pending';
                    if (dayNumber <= currentPlan.completedDays) {
                        dayStatus = 'completed';
                    } else if (dayNumber === todayDay) {
                        dayStatus = 'today';
                    }
                    
                    // è·å–ç¢³å¾ªç¯é˜¶æ®µæ ‡è¯†
                    let phaseIndicator = '';
                    if (currentPlan.type === 'carb-cycle' && template && template.phase) {
                        const phaseColors = { high: 'bg-yellow-400', medium: 'bg-emerald-400', low: 'bg-blue-400' };
                        const color = phaseColors[template.phase] || 'bg-gray-300';
                        phaseIndicator = `<div class="absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full ${color}"></div>`;
                    }
                    
                    // å¤©æ•°æ ·å¼
                    let dayClass = 'aspect-square rounded-lg flex items-center justify-center text-xs font-medium relative cursor-pointer transition-all hover:scale-105';
                    if (dayStatus === 'completed') {
                        dayClass += ' bg-emerald-500 text-white';
                    } else if (dayStatus === 'today') {
                        dayClass += ' bg-white text-emerald-600 border-2 border-emerald-500 ring-2 ring-emerald-100';
                    } else {
                        dayClass += ' bg-gray-100 text-gray-500';
                    }
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = dayClass;
                    dayEl.innerHTML = `<span>${dayNumber}</span>${phaseIndicator}`;
                    dayEl.onclick = () => viewDayTemplate(templateIndex);
                    
                    daysGrid.appendChild(dayEl);
                }
                
                cycleCard.appendChild(daysGrid);
                container.appendChild(cycleCard);
            }
        }

        // æ¸²æŸ“ç¢³å¾ªç¯é…ç½® - ä½¿ç”¨ä¸æ–°å¢è®¡åˆ’æ—¶ä¸€è‡´çš„è®¡ç®—é€»è¾‘
        function renderCarbCycleConfig() {
            const cc = currentPlan.carbCycle;
            document.getElementById('bodyWeight').textContent = cc.bodyWeight;
            
            // ä½¿ç”¨ä¸ carb-cycle-setup.html ç›¸åŒçš„è®¡ç®—é€»è¾‘
            const result = calculateCarbCycleDistribution(
                cc.bodyWeight,
                cc.proteinPerKg,
                cc.carbsPerKg,
                cc.fatPerKg,
                currentPlan.cycleDays,
                cc.phases
            );
            
            // æ›´æ–°è¥å…»ç´ åŸºå‡†æ˜¾ç¤º
            const proteinBase = document.getElementById('proteinBase');
            const carbsBase = document.getElementById('carbsBase');
            const fatBase = document.getElementById('fatBase');
            if (proteinBase) {
                proteinBase.textContent = cc.proteinPerKg + 'g';
            }
            if (carbsBase) {
                carbsBase.textContent = cc.carbsPerKg + 'g';
            }
            if (fatBase) {
                fatBase.textContent = cc.fatPerKg + 'g';
            }
            
            // æ›´æ–°å„é˜¶æ®µæ˜¾ç¤º
            const phaseConfig = {
                high: { name: 'é«˜ç¢³æ—¥', daysEl: 'highDays', color: 'yellow' },
                medium: { name: 'ä¸­ç¢³æ—¥', daysEl: 'mediumDays', color: 'emerald' },
                low: { name: 'ä½ç¢³æ—¥', daysEl: 'lowDays', color: 'blue' }
            };
            
            Object.keys(phaseConfig).forEach(phase => {
                const config = phaseConfig[phase];
                const data = result.phases[phase];
                
                // æ›´æ–°å¤©æ•°
                document.getElementById(config.daysEl).textContent = cc.phases[phase].days + 'å¤©/å‘¨æœŸ';
                
                // æ›´æ–°è¥å…»ç´ æ•°å€¼ï¼ˆç›´æ¥ä¿®æ”¹DOMä¸­çš„æ•°å€¼æ˜¾ç¤ºï¼‰
                const phaseCards = document.querySelectorAll('#phaseList > div');
                phaseCards.forEach(card => {
                    const titleEl = card.querySelector('h4');
                    if (titleEl && titleEl.textContent === config.name) {
                        const valueDivs = card.querySelectorAll('.bg-white\\/70.rounded-lg > div');
                        if (valueDivs.length >= 4) {
                            valueDivs[0].querySelector('.font-semibold').textContent = data.protein + 'g';
                            valueDivs[1].querySelector('.font-semibold').textContent = data.carbs + 'g';
                            valueDivs[2].querySelector('.font-semibold').textContent = data.fat + 'g';
                            valueDivs[3].querySelector('.font-semibold').textContent = data.calories.toLocaleString();
                        }
                    }
                });
            });
        }

        // ç¢³å¾ªç¯è¥å…»ç´ åˆ†é…ç®—æ³• - ä¸ carb-cycle-setup.html ä¿æŒä¸€è‡´
        function calculateCarbCycleDistribution(weight, proteinPerKg, carbsPerKg, fatPerKg, cycleDays, phases) {
            // 1. è®¡ç®—å‘¨æœŸæ€»è¥å…»ç´ 
            const totalProtein = weight * proteinPerKg * cycleDays;
            const totalCarbs = weight * carbsPerKg * cycleDays;
            const totalFat = weight * fatPerKg * cycleDays;

            // 2. è®¡ç®—å„é˜¶æ®µç³»æ•°å’Œ
            let proteinRatioSum = 0, carbRatioSum = 0, fatRatioSum = 0;
            
            ['high', 'medium', 'low'].forEach(phase => {
                proteinRatioSum += phases[phase].proteinRatio || 1;
                carbRatioSum += phases[phase].carbRatio || 1;
                fatRatioSum += phases[phase].fatRatio || 1;
            });

            const result = {
                total: { protein: Math.round(totalProtein), carbs: Math.round(totalCarbs), fat: Math.round(totalFat) },
                phases: {}
            };

            // 3. æŒ‰å…¬å¼åˆ†é…å„é˜¶æ®µæ¯å¤©çš„è¥å…»ç´ 
            // å…¬å¼ï¼šæŸé˜¶æ®µæ¯å¤©è¥å…»ç´  = æ€»é‡ / (é«˜ç³»æ•°+ä¸­ç³»æ•°+ä½ç³»æ•°) Ã— é˜¶æ®µç³»æ•° / é˜¶æ®µå¤©æ•°
            ['high', 'medium', 'low'].forEach(phase => {
                const days = phases[phase].days || 0;
                if (days === 0) {
                    result.phases[phase] = { protein: 0, carbs: 0, fat: 0, calories: 0 };
                    return;
                }

                const pRatio = phases[phase].proteinRatio || 1;
                const cRatio = phases[phase].carbRatio || 1;
                const fRatio = phases[phase].fatRatio || 1;

                const protein = proteinRatioSum > 0 ? Math.round(totalProtein / proteinRatioSum * pRatio / days) : 0;
                const carbs = carbRatioSum > 0 ? Math.round(totalCarbs / carbRatioSum * cRatio / days) : 0;
                const fat = fatRatioSum > 0 ? Math.round(totalFat / fatRatioSum * fRatio / days) : 0;
                const calories = protein * 4 + carbs * 4 + fat * 9;

                result.phases[phase] = { protein, carbs, fat, calories };
            });

            return result;
        }

        // æ›´æ–°æ“ä½œæŒ‰é’®
        function updateActionButtons() {
            const optionsPauseBtn = document.getElementById('optionsPauseBtn');
            const optionsResumeBtn = document.getElementById('optionsResumeBtn');
            
            if (optionsPauseBtn) optionsPauseBtn.classList.add('hidden');
            if (optionsResumeBtn) optionsResumeBtn.classList.add('hidden');
            
            if (currentPlan.status === 'active') {
                if (optionsPauseBtn) optionsPauseBtn.classList.remove('hidden');
            } else if (currentPlan.status === 'paused') {
                if (optionsResumeBtn) optionsResumeBtn.classList.remove('hidden');
            }
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.location.href = 'plan.html';
        }

        // æ˜¾ç¤ºè®¡åˆ’é€‰é¡¹
        function showPlanOptions() {
            document.getElementById('planOptionsModal').classList.remove('hidden');
        }

        // å…³é—­è®¡åˆ’é€‰é¡¹
        function closePlanOptions() {
            document.getElementById('planOptionsModal').classList.add('hidden');
        }

        // ç¼–è¾‘è®¡åˆ’
        function editPlan() {
            closePlanOptions();
            window.location.href = `new-plan.html?edit=${currentPlanId}`;
        }

        // åˆ†äº«è®¡åˆ’
        function sharePlan() {
            closePlanOptions();
            const shareCode = 'PLAN-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            alert(`åˆ†äº«ç ï¼š${shareCode}\n\nå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œåˆ†äº«ç»™ä½ çš„æœ‹å‹å§ï¼`);
        }

        // å¯¼å‡ºè®¡åˆ’
        function exportPlan() {
            closePlanOptions();
            alert('è®¡åˆ’å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }

        // æŸ¥çœ‹æ—¥æ¨¡æ¿
        function viewDayTemplate(index) {
            // å¦‚æœæ˜¯ç¢³å¾ªç¯è®¡åˆ’ï¼Œå…ˆä¿å­˜é…ç½®åˆ° localStorage
            if (currentPlan.type === 'carb-cycle' && currentPlan.carbCycle) {
                const cc = currentPlan.carbCycle;
                const result = calculateCarbCycleDistribution(
                    cc.bodyWeight,
                    cc.proteinPerKg,
                    cc.carbsPerKg,
                    cc.fatPerKg,
                    currentPlan.cycleDays,
                    cc.phases
                );
                
                const config = {
                    weight: cc.bodyWeight,
                    proteinPerKg: cc.proteinPerKg,
                    carbsPerKg: cc.carbsPerKg,
                    fatPerKg: cc.fatPerKg,
                    cycleDays: currentPlan.cycleDays,
                    total: result.total,
                    phases: {
                        high: { ...cc.phases.high, ...result.phases.high },
                        medium: { ...cc.phases.medium, ...result.phases.medium },
                        low: { ...cc.phases.low, ...result.phases.low }
                    }
                };
                localStorage.setItem('carbCycleConfig', JSON.stringify(config));
            }
            
            const typeParam = currentPlan.type === 'carb-cycle' ? '&type=carb-cycle' : '';
            window.location.href = `edit-template.html?planId=${currentPlanId}&dayIndex=${index}${typeParam}`;
        }

        // æŸ¥çœ‹ä»Šæ—¥è¯¦æƒ…
        function viewTodayDetail() {
            const today = currentPlan.completedDays + 1;
            window.location.href = `daily-plan.html?planId=${currentPlanId}&day=${today}`;
        }

        // å¼€å§‹è®¡åˆ’
        function startPlan() {
            alert('å¼€å§‹æ‰§è¡Œä»Šæ—¥è®¡åˆ’ï¼');
        }

        // æš‚åœè®¡åˆ’
        function pausePlan() {
            currentPlan.status = 'paused';
            renderPlanDetail();
            alert('è®¡åˆ’å·²æš‚åœ');
        }

        // ç»§ç»­è®¡åˆ’
        function resumePlan() {
            currentPlan.status = 'active';
            renderPlanDetail();
            alert('è®¡åˆ’å·²ç»§ç»­');
        }

        // ä»é€‰é¡¹å¼¹æ¡†æš‚åœè®¡åˆ’
        function pausePlanFromOptions() {
            closePlanOptions();
            pausePlan();
        }

        // ä»é€‰é¡¹å¼¹æ¡†ç»§ç»­è®¡åˆ’
        function resumePlanFromOptions() {
            closePlanOptions();
            resumePlan();
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤
        function showDeleteConfirm() {
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        // ä»é€‰é¡¹å¼¹æ¡†æ˜¾ç¤ºåˆ é™¤ç¡®è®¤
        function showDeleteConfirmFromOptions() {
            closePlanOptions();
            showDeleteConfirm();
        }

        // å…³é—­åˆ é™¤ç¡®è®¤
        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }

        // ç¡®è®¤åˆ é™¤è®¡åˆ’
        function confirmDeletePlan() {
            closeDeleteConfirm();
            alert('è®¡åˆ’å·²åˆ é™¤');
            goBack();
        }

        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹æ¡†
        document.getElementById('planOptionsModal').addEventListener('click', function(e) {
            if (e.target === this) closePlanOptions();
        });
        document.getElementById('deleteConfirmModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteConfirm();
        });
    </script>
</body>
</html>
