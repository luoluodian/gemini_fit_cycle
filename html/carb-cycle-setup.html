<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢³å¾ªç¯è®¡åˆ’è®¾ç½®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); }
        .hero-title { font-family: 'Noto Serif SC', serif; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="min-h-screen pb-24">
    <div class="bg-white shadow-sm">
        <div class="px-4 py-6">
            <div class="flex items-center">
                <button onclick="goBack()" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="hero-title text-xl font-bold text-gray-800 ml-2">ç¢³å¾ªç¯è®¾ç½®</h1>
            </div>
        </div>
    </div>

    <div class="px-4 py-6 space-y-6">
        <!-- åŸºç¡€ä¿¡æ¯ -->
        <div class="glass-card rounded-2xl p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">å½“å‰ä½“é‡</h3>
                        <p class="text-xs text-gray-500">ç”¨äºè®¡ç®—è¥å…»ç´ æ‘„å…¥é‡</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <input type="number" id="bodyWeight" class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-lg text-center" value="70" min="1" max="300" step="0.1" oninput="updateAll()">
                    <span class="ml-2 text-gray-600 font-medium">kg</span>
                </div>
            </div>
        </div>

        <!-- è¥å…»ç´ é…æ¯” -->
        <div class="glass-card rounded-2xl p-4 shadow-lg">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">è¥å…»ç´ é…æ¯”</h3>
                <span class="text-xs text-gray-500">æ¯kgä½“é‡ / å¤©</span>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-blue-50 rounded-xl p-3 text-center">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-2">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <label class="block text-xs font-medium text-blue-700 mb-1">è›‹ç™½è´¨</label>
                    <input type="number" id="proteinPerKg" class="w-16 px-2 py-1 border border-blue-200 rounded text-center text-sm" value="2.0" min="0.5" max="5" step="0.1" oninput="updateAll()">
                </div>
                <div class="bg-yellow-50 rounded-xl p-3 text-center">
                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center mx-auto mb-2">
                        <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <label class="block text-xs font-medium text-yellow-700 mb-1">ç¢³æ°´</label>
                    <input type="number" id="carbsPerKg" class="w-16 px-2 py-1 border border-yellow-200 rounded text-center text-sm" value="3.0" min="0.5" max="10" step="0.1" oninput="updateAll()">
                </div>
                <div class="bg-red-50 rounded-xl p-3 text-center">
                    <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-2">
                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                        </svg>
                    </div>
                    <label class="block text-xs font-medium text-red-700 mb-1">è„‚è‚ª</label>
                    <input type="number" id="fatPerKg" class="w-16 px-2 py-1 border border-red-200 rounded text-center text-sm" value="0.8" min="0.3" max="3" step="0.1" oninput="updateAll()">
                </div>
            </div>
            <div class="mt-3 p-2 bg-gray-50 rounded-lg text-center text-xs text-gray-500">
                æœ¬å‘¨æœŸ(<span id="cycleDaysDisplay">7</span>å¤©)æ€»é‡ï¼šè›‹ç™½è´¨ <span id="totalCycleProtein" class="font-semibold text-gray-800">0</span>g Â· ç¢³æ°´ <span id="totalCycleCarbs" class="font-semibold text-gray-800">0</span>g Â· è„‚è‚ª <span id="totalCycleFat" class="font-semibold text-gray-800">0</span>g
            </div>
        </div>

        <!-- é˜¶æ®µåˆ†é… -->
        <div class="glass-card rounded-2xl p-4 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">é˜¶æ®µåˆ†é…</h3>
                <span class="text-xs text-gray-500">è®¾ç½®å„é˜¶æ®µç³»æ•°å’Œå¤©æ•°</span>
            </div>

            <div class="space-y-4" id="cyclePhases">
                <!-- é«˜ç¢³æ—¥ -->
                <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200" data-phase="high">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center mr-2">
                                <span class="text-lg">ğŸ”¥</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">é«˜ç¢³æ—¥</h4>
                                <div class="text-xs text-yellow-600">é«˜ç¢³æ°´é…ç½®</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">å¤©æ•°</span>
                            <input type="number" class="phase-days w-12 px-1 py-1 border border-yellow-300 rounded text-center text-sm bg-white" value="2" min="0" max="7" oninput="updateAll()">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">è›‹ç™½è´¨Ã—</span>
                            <input type="number" class="phase-protein-ratio w-full px-1 py-1 border border-blue-200 rounded text-center text-sm bg-white" value="1.0" min="0.1" max="2" step="0.1" oninput="updateAll()">
                        </div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">ç¢³æ°´Ã—</span>
                            <input type="number" class="phase-carb-ratio w-full px-1 py-1 border border-yellow-300 rounded text-center text-sm bg-white" value="1.5" min="0.1" max="3" step="0.1" oninput="updateAll()">
                        </div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">è„‚è‚ªÃ—</span>
                            <input type="number" class="phase-fat-ratio w-full px-1 py-1 border border-red-200 rounded text-center text-sm bg-white" value="0.7" min="0.1" max="2" step="0.1" oninput="updateAll()">
                        </div>
                    </div>
                    <div class="bg-white/70 rounded-lg p-2 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div class="text-xs text-gray-400">è›‹ç™½è´¨</div><div class="font-semibold text-blue-600"><span class="phase-protein">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">ç¢³æ°´</div><div class="font-semibold text-yellow-600"><span class="phase-carbs">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">è„‚è‚ª</div><div class="font-semibold text-red-600"><span class="phase-fat">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">çƒ­é‡</div><div class="font-semibold text-gray-700"><span class="phase-calories">0</span></div></div>
                    </div>
                </div>

                <!-- ä¸­ç¢³æ—¥ -->
                <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200" data-phase="medium">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center mr-2">
                                <span class="text-lg">âš–ï¸</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">ä¸­ç¢³æ—¥</h4>
                                <div class="text-xs text-emerald-600">åŸºå‡†é…ç½®</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">å¤©æ•°</span>
                            <input type="number" class="phase-days w-12 px-1 py-1 border border-emerald-300 rounded text-center text-sm bg-white" value="3" min="0" max="7" oninput="updateAll()">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">è›‹ç™½è´¨Ã—</span>
                            <input type="number" class="phase-protein-ratio w-full px-1 py-1 border border-blue-200 rounded text-center text-sm bg-white" value="1.0" min="0.1" max="2" step="0.1" oninput="updateAll()">
                        </div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">ç¢³æ°´Ã—</span>
                            <input type="number" class="phase-carb-ratio w-full px-1 py-1 border border-emerald-300 rounded text-center text-sm bg-white" value="1.0" min="0.1" max="3" step="0.1" oninput="updateAll()">
                        </div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">è„‚è‚ªÃ—</span>
                            <input type="number" class="phase-fat-ratio w-full px-1 py-1 border border-red-200 rounded text-center text-sm bg-white" value="1.0" min="0.1" max="2" step="0.1" oninput="updateAll()">
                        </div>
                    </div>
                    <div class="bg-white/70 rounded-lg p-2 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div class="text-xs text-gray-400">è›‹ç™½è´¨</div><div class="font-semibold text-blue-600"><span class="phase-protein">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">ç¢³æ°´</div><div class="font-semibold text-emerald-600"><span class="phase-carbs">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">è„‚è‚ª</div><div class="font-semibold text-red-600"><span class="phase-fat">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">çƒ­é‡</div><div class="font-semibold text-gray-700"><span class="phase-calories">0</span></div></div>
                    </div>
                </div>

                <!-- ä½ç¢³æ—¥ -->
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200" data-phase="low">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                                <span class="text-lg">â„ï¸</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">ä½ç¢³æ—¥</h4>
                                <div class="text-xs text-blue-600">ä½ç¢³æ°´é…ç½®</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">å¤©æ•°</span>
                            <input type="number" class="phase-days w-12 px-1 py-1 border border-blue-300 rounded text-center text-sm bg-white" value="2" min="0" max="7" oninput="updateAll()">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">è›‹ç™½è´¨Ã—</span>
                            <input type="number" class="phase-protein-ratio w-full px-1 py-1 border border-blue-200 rounded text-center text-sm bg-white" value="1.0" min="0.1" max="2" step="0.1" oninput="updateAll()">
                        </div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">ç¢³æ°´Ã—</span>
                            <input type="number" class="phase-carb-ratio w-full px-1 py-1 border border-blue-300 rounded text-center text-sm bg-white" value="0.5" min="0.1" max="3" step="0.1" oninput="updateAll()">
                        </div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 block mb-1">è„‚è‚ªÃ—</span>
                            <input type="number" class="phase-fat-ratio w-full px-1 py-1 border border-red-200 rounded text-center text-sm bg-white" value="1.3" min="0.1" max="2" step="0.1" oninput="updateAll()">
                        </div>
                    </div>
                    <div class="bg-white/70 rounded-lg p-2 grid grid-cols-4 gap-2 text-center text-sm">
                        <div><div class="text-xs text-gray-400">è›‹ç™½è´¨</div><div class="font-semibold text-blue-600"><span class="phase-protein">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">ç¢³æ°´</div><div class="font-semibold text-blue-600"><span class="phase-carbs">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">è„‚è‚ª</div><div class="font-semibold text-red-600"><span class="phase-fat">0</span>g</div></div>
                        <div><div class="text-xs text-gray-400">çƒ­é‡</div><div class="font-semibold text-gray-700"><span class="phase-calories">0</span></div></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-3 rounded-lg text-center text-sm" id="daysCheck">
                <span class="text-gray-600">å·²é…ç½® </span>
                <span id="configuredDays" class="font-semibold">0</span>
                <span class="text-gray-600"> / </span>
                <span id="totalCycleDays" class="font-semibold">0</span>
                <span class="text-gray-600"> å¤©</span>
                <div id="daysCheckMessage" class="mt-1 text-xs"></div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3">
        <div class="flex space-x-3">
            <button onclick="goBack()" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-200">ä¸Šä¸€æ­¥</button>
            <button onclick="goToTemplates()" class="flex-1 bg-emerald-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-emerald-700">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <script>
        function getPlanData() {
            const params = new URLSearchParams(window.location.search);
            return {
                name: params.get('name') || 'ç¢³å¾ªç¯è®¡åˆ’',
                cycleDays: parseInt(params.get('cycleDays')) || 7,
                cycleCount: parseInt(params.get('cycleCount')) || 3,
                type: params.get('type') || 'carb-cycle'
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            const plan = getPlanData();
            document.getElementById('totalCycleDays').textContent = plan.cycleDays;
            document.getElementById('cycleDaysDisplay').textContent = plan.cycleDays;
            updateAll();
            anime({ targets: '.glass-card', translateY: [20, 0], opacity: [0, 1], delay: anime.stagger(100), duration: 600, easing: 'easeOutQuart' });
        });

        // æ ¸å¿ƒç®—æ³•ï¼šæ ¹æ®å„é˜¶æ®µç³»æ•°åˆ†é…å‘¨æœŸæ€»é‡
        function calculateDistribution(weight, proteinPerKg, carbsPerKg, fatPerKg, cycleDays, phases) {
            // 1. è®¡ç®—å‘¨æœŸæ€»è¥å…»ç´ 
            const totalProtein = weight * proteinPerKg * cycleDays;
            const totalCarbs = weight * carbsPerKg * cycleDays;
            const totalFat = weight * fatPerKg * cycleDays;

            // 2. è®¡ç®—å„é˜¶æ®µç³»æ•°å’Œ
            let proteinRatioSum = 0, carbRatioSum = 0, fatRatioSum = 0;
            
            ['high', 'medium', 'low'].forEach(phase => {
                proteinRatioSum += phases[phase].proteinRatio || 1;
                carbRatioSum += phases[phase].carbRatio || 1;
                fatRatioSum += phases[phase].fatRatio || 1;
            });

            const result = {
                total: { protein: Math.round(totalProtein), carbs: Math.round(totalCarbs), fat: Math.round(totalFat) },
                phases: {}
            };

            // 3. æŒ‰æ–°å…¬å¼åˆ†é…å„é˜¶æ®µæ¯å¤©çš„è¥å…»ç´ 
            // å…¬å¼ï¼šæŸé˜¶æ®µæ¯å¤©è¥å…»ç´  = æ€»é‡ / (é«˜ç³»æ•°+ä¸­ç³»æ•°+ä½ç³»æ•°) Ã— é˜¶æ®µç³»æ•° / é˜¶æ®µå¤©æ•°
            ['high', 'medium', 'low'].forEach(phase => {
                const days = phases[phase].days || 0;
                if (days === 0) {
                    result.phases[phase] = { protein: 0, carbs: 0, fat: 0, calories: 0 };
                    return;
                }

                const pRatio = phases[phase].proteinRatio || 1;
                const cRatio = phases[phase].carbRatio || 1;
                const fRatio = phases[phase].fatRatio || 1;

                const protein = proteinRatioSum > 0 ? Math.round(totalProtein / proteinRatioSum * pRatio / days) : 0;
                const carbs = carbRatioSum > 0 ? Math.round(totalCarbs / carbRatioSum * cRatio / days) : 0;
                const fat = fatRatioSum > 0 ? Math.round(totalFat / fatRatioSum * fRatio / days) : 0;
                const calories = protein * 4 + carbs * 4 + fat * 9;

                result.phases[phase] = { protein, carbs, fat, calories };
            });

            return result;
        }

        function updateAll() {
            const weight = parseFloat(document.getElementById('bodyWeight').value) || 0;
            const proteinPerKg = parseFloat(document.getElementById('proteinPerKg').value) || 0;
            const carbsPerKg = parseFloat(document.getElementById('carbsPerKg').value) || 0;
            const fatPerKg = parseFloat(document.getElementById('fatPerKg').value) || 0;
            const plan = getPlanData();

            // è·å–å„é˜¶æ®µé…ç½®
            const phases = {};
            let totalDays = 0;
            document.querySelectorAll('#cyclePhases [data-phase]').forEach(card => {
                const phase = card.dataset.phase;
                phases[phase] = {
                    days: parseInt(card.querySelector('.phase-days').value) || 0,
                    proteinRatio: parseFloat(card.querySelector('.phase-protein-ratio').value) || 1,
                    carbRatio: parseFloat(card.querySelector('.phase-carb-ratio').value) || 1,
                    fatRatio: parseFloat(card.querySelector('.phase-fat-ratio').value) || 1
                };
                totalDays += phases[phase].days;
            });

            if (weight > 0 && totalDays > 0) {
                const result = calculateDistribution(weight, proteinPerKg, carbsPerKg, fatPerKg, plan.cycleDays, phases);

                // æ›´æ–°å‘¨æœŸæ€»é‡
                document.getElementById('totalCycleProtein').textContent = result.total.protein.toLocaleString();
                document.getElementById('totalCycleCarbs').textContent = result.total.carbs.toLocaleString();
                document.getElementById('totalCycleFat').textContent = result.total.fat.toLocaleString();

                // æ›´æ–°å„é˜¶æ®µæ˜¾ç¤º
                document.querySelectorAll('#cyclePhases [data-phase]').forEach(card => {
                    const phase = card.dataset.phase;
                    const n = result.phases[phase];
                    card.querySelector('.phase-protein').textContent = n.protein;
                    card.querySelector('.phase-carbs').textContent = n.carbs;
                    card.querySelector('.phase-fat').textContent = n.fat;
                    card.querySelector('.phase-calories').textContent = n.calories.toLocaleString();
                });
            } else {
                document.getElementById('totalCycleProtein').textContent = '0';
                document.getElementById('totalCycleCarbs').textContent = '0';
                document.getElementById('totalCycleFat').textContent = '0';
                document.querySelectorAll('#cyclePhases [data-phase]').forEach(card => {
                    card.querySelector('.phase-protein').textContent = '0';
                    card.querySelector('.phase-carbs').textContent = '0';
                    card.querySelector('.phase-fat').textContent = '0';
                    card.querySelector('.phase-calories').textContent = '0';
                });
            }

            // æ›´æ–°å¤©æ•°æ£€æŸ¥
            document.getElementById('configuredDays').textContent = totalDays;
            const daysCheck = document.getElementById('daysCheck');
            const msg = document.getElementById('daysCheckMessage');
            if (totalDays === plan.cycleDays) {
                daysCheck.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-emerald-100';
                msg.textContent = 'âœ“ é˜¶æ®µå¤©æ•°ä¸å‘¨æœŸå¤©æ•°åŒ¹é…';
                msg.className = 'mt-1 text-xs text-emerald-600';
            } else if (totalDays < plan.cycleDays) {
                daysCheck.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-yellow-100';
                msg.textContent = `è¿˜éœ€é…ç½® ${plan.cycleDays - totalDays} å¤©`;
                msg.className = 'mt-1 text-xs text-yellow-600';
            } else {
                daysCheck.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-red-100';
                msg.textContent = `è¶…å‡º ${totalDays - plan.cycleDays} å¤©ï¼Œè¯·è°ƒæ•´`;
                msg.className = 'mt-1 text-xs text-red-600';
            }
        }

        function goToTemplates() {
            const weight = parseFloat(document.getElementById('bodyWeight').value) || 0;
            if (!weight || weight <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½“é‡'); return; }

            const plan = getPlanData();
            const phases = {};
            let totalDays = 0;
            document.querySelectorAll('#cyclePhases [data-phase]').forEach(card => {
                const phase = card.dataset.phase;
                phases[phase] = {
                    days: parseInt(card.querySelector('.phase-days').value) || 0,
                    proteinRatio: parseFloat(card.querySelector('.phase-protein-ratio').value) || 1,
                    carbRatio: parseFloat(card.querySelector('.phase-carb-ratio').value) || 1,
                    fatRatio: parseFloat(card.querySelector('.phase-fat-ratio').value) || 1
                };
                totalDays += phases[phase].days;
            });

            if (totalDays !== plan.cycleDays) { alert(`é˜¶æ®µå¤©æ•°æ€»å’Œ(${totalDays}å¤©)å¿…é¡»ä¸å‘¨æœŸå¤©æ•°(${plan.cycleDays}å¤©)åŒ¹é…`); return; }

            const proteinPerKg = parseFloat(document.getElementById('proteinPerKg').value) || 0;
            const carbsPerKg = parseFloat(document.getElementById('carbsPerKg').value) || 0;
            const fatPerKg = parseFloat(document.getElementById('fatPerKg').value) || 0;
            const result = calculateDistribution(weight, proteinPerKg, carbsPerKg, fatPerKg, plan.cycleDays, phases);

            const config = {
                weight, proteinPerKg, carbsPerKg, fatPerKg, cycleDays: plan.cycleDays,
                total: result.total,
                phases: {
                    high: { ...phases.high, ...result.phases.high },
                    medium: { ...phases.medium, ...result.phases.medium },
                    low: { ...phases.low, ...result.phases.low }
                }
            };
            localStorage.setItem('carbCycleConfig', JSON.stringify(config));

            const params = new URLSearchParams({ name: plan.name, type: plan.type, cycleDays: plan.cycleDays, cycleCount: plan.cycleCount, weight, config: 'carb-cycle' });
            window.location.href = 'plan-templates.html?' + params.toString();
        }

        function goBack() { window.history.back(); }
    </script>
</body>
</html>
