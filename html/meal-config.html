<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È§êÊ¨°ÈÖçÁΩÆ - È•ÆÈ£üËÆ°Âàí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        .hero-title {
            font-family: 'Noto Serif SC', serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .food-item {
            transition: all 0.2s ease;
        }
        .food-item:hover {
            transform: translateX(4px);
        }
    </style>
</head>
<body class="min-h-screen pb-24">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="px-4 py-6">
            <div class="flex items-center">
                <button onclick="goBack()" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="hero-title text-xl font-bold text-gray-800 ml-2" id="pageTitle">Êó©È§ê</h1>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-6 space-y-6">
        <!-- È§êÊ¨°Ëê•ÂÖªÊ±áÊÄª -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
            <h3 class="text-base font-semibold text-gray-800 mb-4">Êú¨È§êËê•ÂÖª</h3>
            <div class="grid grid-cols-4 gap-3 text-center">
                <div class="bg-emerald-50 rounded-xl p-3">
                    <div class="text-xs text-gray-500 mb-1">ÁÉ≠Èáè</div>
                    <div class="text-lg font-bold text-emerald-600" id="mealCalories">0</div>
                    <div class="text-xs text-gray-400">kcal</div>
                </div>
                <div class="bg-blue-50 rounded-xl p-3">
                    <div class="text-xs text-gray-500 mb-1">Á¢≥Ê∞¥</div>
                    <div class="text-lg font-bold text-blue-600" id="mealCarbs">0</div>
                    <div class="text-xs text-gray-400">g</div>
                </div>
                <div class="bg-red-50 rounded-xl p-3">
                    <div class="text-xs text-gray-500 mb-1">ËõãÁôΩË¥®</div>
                    <div class="text-lg font-bold text-red-600" id="mealProtein">0</div>
                    <div class="text-xs text-gray-400">g</div>
                </div>
                <div class="bg-yellow-50 rounded-xl p-3">
                    <div class="text-xs text-gray-500 mb-1">ËÑÇËÇ™</div>
                    <div class="text-lg font-bold text-yellow-600" id="mealFat">0</div>
                    <div class="text-xs text-gray-400">g</div>
                </div>
            </div>
        </div>

        <!-- È£üÁâ©ÂàóË°® -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base font-semibold text-gray-800">È£üÁâ©ÂàóË°®</h3>
                <span class="text-sm text-gray-500" id="foodCount">0 ‰∏™È£üÁâ©</span>
            </div>
            <div id="foodList" class="space-y-3">
                <!-- È£üÁâ©È°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÊ∏≤Êüì -->
            </div>
        </div>

        <!-- Ê∑ªÂä†È£üÁâ©ÊåâÈíÆ -->
        <button onclick="openFoodSelector()" class="w-full py-4 bg-emerald-500 rounded-2xl text-white font-medium shadow-lg shadow-emerald-200 active:scale-95 transition-transform flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>Ê∑ªÂä†È£üÁâ©</span>
        </button>
    </div>

    <!-- Â∫ïÈÉ®‰øùÂ≠òÊ†è -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3">
        <button onclick="saveAndGoBack()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-medium hover:bg-emerald-700 transition-colors">
            ‰øùÂ≠ò
        </button>
    </div>

    <!-- È£üÁâ©ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
    <div id="foodModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 h-[70vh] flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">ÈÄâÊã©È£üÁâ©</h3>
                    <button onclick="closeFoodModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="foodSearchInput" placeholder="ÊêúÁ¥¢È£üÁâ©..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" oninput="filterFoodList()">
                </div>
                <!-- ÂàÜÁ±ªÁ≠õÈÄâ -->
                <div class="flex space-x-2 overflow-x-auto pb-2 mb-4" id="categoryFilters">
                    <button class="category-btn active px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-emerald-100 text-emerald-700" data-category="all">ÂÖ®ÈÉ®</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="grains">‰∏ªÈ£ü</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="protein">ËõãÁôΩË¥®</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="vegetables">Ëî¨Ëèú</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="fruits">Ê∞¥Êûú</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="nuts">ÂùöÊûú</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="dairy">‰π≥Âà∂ÂìÅ</button>
                </div>
                <div class="space-y-2 flex-1 overflow-y-auto" id="foodListModal">
                    <!-- Food items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Êï∞ÈáèËæìÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div id="quantityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Ê∑ªÂä†È£üÁâ©</h3>
                    <p class="text-sm text-gray-500" id="foodName">È£üÁâ©ÂêçÁß∞</p>
                </div>
                <div class="mb-4 flex items-center">
                    <label class="text-sm font-medium text-gray-700 mr-3 whitespace-nowrap">Êï∞Èáè</label>
                    <div class="flex items-center flex-1">
                        <input type="number" id="foodQuantity" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="ËØ∑ËæìÂÖ•Êï∞Èáè" value="100">
                        <span class="ml-3 text-sm text-gray-600">g</span>
                    </div>
                </div>
                <!-- Ëê•ÂÖªÊàêÂàÜÈ¢ÑËßà -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="text-xs text-gray-500 mb-2">Ëê•ÂÖªÊàêÂàÜÈ¢ÑËßà</div>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div>
                            <div class="text-xs text-gray-500">Á¢≥Ê∞¥</div>
                            <div class="text-sm font-medium text-yellow-600" id="previewCarbs">0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">ËõãÁôΩË¥®</div>
                            <div class="text-sm font-medium text-red-600" id="previewProtein">0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">ËÑÇËÇ™</div>
                            <div class="text-sm font-medium text-blue-600" id="previewFat">0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">ËÉΩÈáè</div>
                            <div class="text-sm font-medium text-emerald-600" id="previewCalories">0 kcal</div>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeQuantityModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        ÂèñÊ∂à
                    </button>
                    <button onclick="confirmAddFood()" class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                        Á°ÆËÆ§Ê∑ªÂä†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // È£üÁâ©Ëê•ÂÖªÊï∞ÊçÆÂ∫ì (ÊØè100g)
        const foodNutritionDB = {
            'ÁáïÈ∫¶Á≤•': { carbs: 60, protein: 12, fat: 6, calories: 360 },
            'ÁâõÂ•∂': { carbs: 4.8, protein: 3.2, fat: 3.2, calories: 54 },
            'È¶ôËïâ': { carbs: 23, protein: 1.1, fat: 0.3, calories: 89 },
            'È∏°ËÉ∏ËÇâ': { carbs: 0, protein: 31, fat: 3.6, calories: 165 },
            'Á≥ôÁ±≥È•≠': { carbs: 23, protein: 2.6, fat: 0.9, calories: 111 },
            'Ë•øÂÖ∞Ëä±': { carbs: 7, protein: 2.8, fat: 0.4, calories: 34 },
            'ËÉ°ËêùÂçú': { carbs: 9.6, protein: 0.9, fat: 0.2, calories: 41 },
            'Ê©ÑÊ¶ÑÊ≤π': { carbs: 0, protein: 0, fat: 100, calories: 884 },
            '‰∏âÊñáÈ±º': { carbs: 0, protein: 20, fat: 13, calories: 208 },
            'Ëí∏Ëõã': { carbs: 0.6, protein: 13, fat: 10, calories: 143 },
            'Ëè†Ëèú': { carbs: 3.6, protein: 2.9, fat: 0.4, calories: 23 },
            'Á¥´ËñØ': { carbs: 20, protein: 1.6, fat: 0.2, calories: 86 },
            'ÈÖ∏Â•∂': { carbs: 4.7, protein: 10, fat: 0.5, calories: 59 },
            'Êùè‰ªÅ': { carbs: 21.6, protein: 21.2, fat: 49.4, calories: 579 },
            'ËãπÊûú': { carbs: 13.8, protein: 0.3, fat: 0.2, calories: 52 },
            'È∏°Ëõã': { carbs: 1, protein: 13, fat: 11, calories: 155 },
            'ÂÖ®È∫¶Èù¢ÂåÖ': { carbs: 41, protein: 13, fat: 4, calories: 247 },
            'ÁâõÊ≤πÊûú': { carbs: 8.5, protein: 2, fat: 14.7, calories: 160 },
            'ËìùËéì': { carbs: 14.5, protein: 0.7, fat: 0.3, calories: 57 },
            'Ê†∏Ê°É': { carbs: 4, protein: 4, fat: 18, calories: 185 }
        };

        // È£üÁâ©ÈÄâÊã©Êï∞ÊçÆÂ∫ì
        const foodDatabase = [
            { name: 'ÁáïÈ∫¶Á≤•', calories: 180, protein: 6, fat: 3, carbs: 30, unit: '50g', category: 'grains' },
            { name: 'ÁâõÂ•∂', calories: 120, protein: 6, fat: 6, carbs: 9, unit: '200ml', category: 'dairy' },
            { name: 'È¶ôËïâ', calories: 80, protein: 1, fat: 0, carbs: 20, unit: '1Ê†π', category: 'fruits' },
            { name: 'È∏°ËÉ∏ËÇâ', calories: 250, protein: 46, fat: 5, carbs: 0, unit: '150g', category: 'protein' },
            { name: 'Á≥ôÁ±≥È•≠', calories: 180, protein: 4, fat: 2, carbs: 36, unit: '100g', category: 'grains' },
            { name: 'Ë•øÂÖ∞Ëä±', calories: 35, protein: 3, fat: 0, carbs: 7, unit: '100g', category: 'vegetables' },
            { name: 'ËÉ°ËêùÂçú', calories: 30, protein: 1, fat: 0, carbs: 7, unit: '80g', category: 'vegetables' },
            { name: 'Ê©ÑÊ¶ÑÊ≤π', calories: 85, protein: 0, fat: 9, carbs: 0, unit: '1Âã∫', category: 'protein' },
            { name: '‰∏âÊñáÈ±º', calories: 280, protein: 25, fat: 18, carbs: 0, unit: '120g', category: 'protein' },
            { name: 'Ëí∏Ëõã', calories: 140, protein: 12, fat: 10, carbs: 1, unit: '2‰∏™', category: 'protein' },
            { name: 'Ëè†Ëèú', calories: 25, protein: 3, fat: 0, carbs: 4, unit: '100g', category: 'vegetables' },
            { name: 'Á¥´ËñØ', calories: 85, protein: 2, fat: 0, carbs: 20, unit: '100g', category: 'grains' },
            { name: 'ÈÖ∏Â•∂', calories: 80, protein: 4, fat: 0, carbs: 12, unit: '150g', category: 'dairy' },
            { name: 'Êùè‰ªÅ', calories: 20, protein: 1, fat: 2, carbs: 1, unit: '10È¢ó', category: 'nuts' },
            { name: 'ËãπÊûú', calories: 52, protein: 0, fat: 0, carbs: 14, unit: '1‰∏™', category: 'fruits' },
            { name: 'È∏°Ëõã', calories: 155, protein: 13, fat: 11, carbs: 1, unit: '2‰∏™', category: 'protein' },
            { name: 'ÂÖ®È∫¶Èù¢ÂåÖ', calories: 120, protein: 4, fat: 2, carbs: 20, unit: '1Áâá', category: 'grains' },
            { name: 'ÁâõÊ≤πÊûú', calories: 160, protein: 2, fat: 15, carbs: 9, unit: 'Âçä‰∏™', category: 'fruits' },
            { name: 'ËìùËéì', calories: 42, protein: 1, fat: 0, carbs: 11, unit: '100g', category: 'fruits' },
            { name: 'Ê†∏Ê°É', calories: 185, protein: 4, fat: 18, carbs: 4, unit: '30g', category: 'nuts' }
        ];

        let currentCategory = 'all';
        let templateIndex = 0;
        let currentMeal = '';
        let currentFood = null;
        let editingIndex = -1;
        let mealFoods = [];
        let templateData = null;

        const mealNames = {
            breakfast: 'Êó©È§ê',
            lunch: 'ÂçàÈ§ê',
            dinner: 'ÊôöÈ§ê',
            snacks: 'Âä†È§ê'
        };

        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            templateIndex = params.get('index') || 0;
            currentMeal = params.get('meal') || 'breakfast';
            
            document.getElementById('pageTitle').textContent = mealNames[currentMeal] || 'È§êÊ¨°ÈÖçÁΩÆ';
            loadMealData();
        });

        function loadMealData() {
            const saved = localStorage.getItem(`template_${templateIndex}`);
            if (saved) {
                templateData = JSON.parse(saved);
                // ËΩ¨Êç¢ÊóßÊï∞ÊçÆÊ†ºÂºè
                mealFoods = (templateData.meals[currentMeal] || []).map(food => ({
                    name: food.name,
                    quantity: food.quantity || 100,
                    unit: food.unit || 'g',
                    calories: food.calories || 0,
                    protein: food.protein || 0,
                    fat: food.fat || 0,
                    carbs: food.carbs || 0
                }));
            } else {
                templateData = {
                    name: '',
                    targetCalories: 0,
                    targetProtein: 0,
                    targetFat: 0,
                    targetCarbs: 0,
                    meals: { breakfast: [], lunch: [], dinner: [], snacks: [] }
                };
                mealFoods = [];
            }
            renderFoodList();
            calculateNutrition();
        }

        function renderFoodList() {
            const container = document.getElementById('foodList');
            document.getElementById('foodCount').textContent = `${mealFoods.length} ‰∏™È£üÁâ©`;
            
            if (mealFoods.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <div class="text-4xl mb-3">üçΩÔ∏è</div>
                        <p>ËøòÊ≤°ÊúâÊ∑ªÂä†È£üÁâ©</p>
                        <p class="text-sm mt-1">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = mealFoods.map((food, index) => {
                return `
                    <div class="food-item flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-800">${food.name}</div>
                            <div class="text-xs text-gray-500">${food.quantity}${food.unit}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${food.calories} kcal</span>
                            <button class="text-gray-400 hover:text-gray-600" onclick="editFoodItem(${index})">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button class="text-red-400 hover:text-red-600" onclick="deleteFoodItem(${index})">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateNutrition() {
            let totalCalories = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
            
            mealFoods.forEach(food => {
                totalCalories += food.calories || 0;
                totalProtein += food.protein || 0;
                totalFat += food.fat || 0;
                totalCarbs += food.carbs || 0;
            });
            
            document.getElementById('mealCalories').textContent = Math.round(totalCalories);
            document.getElementById('mealCarbs').textContent = Math.round(totalCarbs);
            document.getElementById('mealProtein').textContent = Math.round(totalProtein);
            document.getElementById('mealFat').textContent = Math.round(totalFat);
        }

        // Ê∑ªÂä†È£üÁâ©
        function openFoodSelector() {
            editingIndex = -1;
            renderFoodListModal();
            document.getElementById('foodModal').classList.remove('hidden');
        }

        function renderFoodListModal(filterText = '') {
            const foodList = document.getElementById('foodListModal');
            foodList.innerHTML = '';
            
            let filteredFoods = foodDatabase;
            
            // ÊåâÂàÜÁ±ªÁ≠õÈÄâ
            if (currentCategory !== 'all') {
                filteredFoods = filteredFoods.filter(food => food.category === currentCategory);
            }
            
            // ÊåâÊêúÁ¥¢ÊñáÊú¨Á≠õÈÄâ
            if (filterText) {
                filteredFoods = filteredFoods.filter(food => food.name.includes(filterText));
            }
            
            filteredFoods.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-emerald-50 transition-colors';
                foodItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold text-gray-800 text-base">${food.name}</div>
                        <div class="text-lg font-bold text-emerald-600">${food.calories} <span class="text-xs font-normal text-gray-400">kcal</span></div>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">ÊØè${food.unit}</span>
                        <div class="flex items-center gap-3 text-gray-500">
                            <span>üçû ${food.carbs}g</span>
                            <span>ü•© ${food.protein}g</span>
                            <span>ü•ë ${food.fat}g</span>
                        </div>
                    </div>
                `;
                foodItem.onclick = () => selectFood(food);
                foodList.appendChild(foodItem);
            });
        }

        function filterFoodList() {
            const searchText = document.getElementById('foodSearchInput').value;
            renderFoodListModal(searchText);
        }

        // ÂàÜÁ±ªÁ≠õÈÄâ‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('category-btn')) {
                // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-emerald-100', 'text-emerald-700');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                });
                e.target.classList.remove('bg-gray-100', 'text-gray-600');
                e.target.classList.add('active', 'bg-emerald-100', 'text-emerald-700');
                
                // Êõ¥Êñ∞ÂΩìÂâçÂàÜÁ±ªÂπ∂ÈáçÊñ∞Ê∏≤Êüì
                currentCategory = e.target.dataset.category;
                const searchText = document.getElementById('foodSearchInput').value;
                renderFoodListModal(searchText);
            }
        });

        function closeFoodModal() {
            document.getElementById('foodModal').classList.add('hidden');
        }

        function selectFood(food) {
            currentFood = food;
            closeFoodModal();
            showQuantityModal(food);
        }

        function showQuantityModal(food) {
            const modal = document.getElementById('quantityModal');
            document.getElementById('foodName').textContent = food.name;
            document.getElementById('foodQuantity').value = editingIndex >= 0 ? mealFoods[editingIndex].quantity : 100;
            
            // ÊòæÁ§∫Ëê•ÂÖªÊàêÂàÜÈ¢ÑËßà
            updatePreview(food.name, editingIndex >= 0 ? mealFoods[editingIndex].quantity : 100);
            
            modal.classList.remove('hidden');
        }

        function updatePreview(foodName, quantity) {
            const nutrition = foodNutritionDB[foodName];
            if (!nutrition) return;
            
            const ratio = quantity / 100;
            const carbs = (nutrition.carbs * ratio).toFixed(1);
            const protein = (nutrition.protein * ratio).toFixed(1);
            const fat = (nutrition.fat * ratio).toFixed(1);
            const calories = Math.round(nutrition.calories * ratio);
            
            document.getElementById('previewCarbs').textContent = carbs + 'g';
            document.getElementById('previewProtein').textContent = protein + 'g';
            document.getElementById('previewFat').textContent = fat + 'g';
            document.getElementById('previewCalories').textContent = calories + ' kcal';
        }

        // ÁõëÂê¨Êï∞ÈáèÂèòÂåñ
        document.getElementById('foodQuantity').addEventListener('input', function() {
            const foodName = document.getElementById('foodName').textContent;
            const quantity = parseFloat(this.value) || 0;
            updatePreview(foodName, quantity);
        });

        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.add('hidden');
            editingIndex = -1;
        }

        function confirmAddFood() {
            const quantity = parseFloat(document.getElementById('foodQuantity').value);
            
            if (!quantity || quantity <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Èáè');
                return;
            }
            
            // ËÆ°ÁÆóÂÆûÈôÖËê•ÂÖªÂÄº
            const ratio = quantity / 100;
            const actualCalories = Math.round(currentFood.calories * ratio);
            const actualProtein = Math.round(currentFood.protein * ratio * 10) / 10;
            const actualFat = Math.round(currentFood.fat * ratio * 10) / 10;
            const actualCarbs = Math.round(currentFood.carbs * ratio * 10) / 10;
            
            const foodItem = {
                name: currentFood.name,
                quantity: quantity,
                unit: 'g',
                calories: actualCalories,
                protein: actualProtein,
                fat: actualFat,
                carbs: actualCarbs
            };
            
            if (editingIndex >= 0) {
                mealFoods[editingIndex] = foodItem;
            } else {
                mealFoods.push(foodItem);
            }
            
            closeQuantityModal();
            renderFoodList();
            calculateNutrition();
        }

        function editFoodItem(index) {
            editingIndex = index;
            const food = mealFoods[index];
            // ‰ªé foodDatabase Êü•ÊâæÂØπÂ∫îÁöÑÈ£üÁâ©
            const dbFood = foodDatabase.find(f => f.name === food.name);
            if (dbFood) {
                currentFood = dbFood;
                showQuantityModal(dbFood);
            }
        }

        function deleteFoodItem(index) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™È£üÁâ©ÂêóÔºü')) {
                mealFoods.splice(index, 1);
                renderFoodList();
                calculateNutrition();
            }
        }

        function saveAndGoBack() {
            if (!templateData) {
                templateData = {
                    name: '',
                    targetCalories: 0,
                    targetProtein: 0,
                    targetFat: 0,
                    targetCarbs: 0,
                    meals: { breakfast: [], lunch: [], dinner: [], snacks: [] }
                };
            }
            templateData.meals[currentMeal] = mealFoods;
            localStorage.setItem(`template_${templateIndex}`, JSON.stringify(templateData));
            goBack();
        }

        function goBack() {
            window.history.back();
        }

        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ÂºπÊ°Ü
        document.getElementById('foodModal').addEventListener('click', function(e) {
            if (e.target === this) closeFoodModal();
        });
        document.getElementById('quantityModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuantityModal();
        });
    </script>
</body>
</html>
