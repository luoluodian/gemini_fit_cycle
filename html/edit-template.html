<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘æ—¥æ¨¡æ¿ - é¥®é£Ÿè®¡åˆ’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        .hero-title {
            font-family: 'Noto Serif SC', serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .meal-card {
            transition: all 0.3s ease;
        }
        .meal-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen pb-24">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="goBack()" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="hero-title text-xl font-bold text-gray-800 ml-2" id="pageTitle">ç¼–è¾‘ Day 1</h1>
                </div>
                <button onclick="deleteTemplate()" class="text-red-600 text-sm font-medium hover:text-red-700">
                    åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-6 space-y-6">
        <!-- æ¨¡æ¿åç§° -->
        <div class="glass-card rounded-2xl p-4 shadow-lg" id="templateNameContainer">
            <div class="flex items-center space-x-3">
                <label class="text-sm font-medium text-gray-700 whitespace-nowrap">æ¨¡æ¿åç§°</label>
                <input type="text" id="templateName" maxlength="6" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent whitespace-nowrap overflow-hidden text-ellipsis" placeholder="ä¾‹å¦‚ï¼šè®­ç»ƒæ—¥">
                <span class="text-xs text-gray-400 whitespace-nowrap"><span id="nameCharCount">0</span>/6</span>
            </div>
        </div>

        <!-- ç¢³å¾ªç¯é˜¶æ®µä¸ç›®æ ‡ï¼ˆå¸¦è¿›åº¦æ˜¾ç¤ºï¼‰ -->
        <div id="phaseBadge" class="glass-card rounded-xl p-4 shadow-sm hidden">
            <!-- æ ‡é¢˜æ  -->
            <div class="flex items-center justify-between mb-3 text-xs">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-400">å½“æ—¥ç›®æ ‡</span>
                    <span id="phaseIcon">âš–ï¸</span>
                    <h3 id="phaseName" class="font-medium text-gray-800">ä¸­ç¢³æ—¥</h3>
                    <span id="phaseTag" class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-emerald-50 text-emerald-600 border border-emerald-100">åŸºå‡†</span>
                </div>
                <!-- çƒ­é‡ -->
                <div class="flex items-center space-x-1">
                    <span class="text-gray-400">çƒ­é‡</span>
                    <span class="font-semibold text-emerald-600"><span id="targetCalories">0</span></span>
                    <span class="text-gray-400">kcal</span>
                </div>
            </div>

            <!-- è¥å…»ç›®æ ‡ç½‘æ ¼ -->
            <div class="grid grid-cols-3 gap-2">
                <!-- è›‹ç™½è´¨ -->
                <div class="bg-blue-50 rounded-lg p-2.5">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-[10px] text-blue-600">è›‹ç™½</span>
                        <span class="text-[10px] text-blue-400"><span id="currentProtein">0</span>g</span>
                    </div>
                    <div class="text-sm font-semibold text-blue-700 mb-1"><span id="targetProtein">0</span>g</div>
                    <div class="w-full bg-blue-200 rounded-full h-1">
                        <div id="proteinProgressBar" class="h-1 rounded-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <!-- ç¢³æ°´ -->
                <div class="bg-yellow-50 rounded-lg p-2.5">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-[10px] text-yellow-600">ç¢³æ°´</span>
                        <span class="text-[10px] text-yellow-500"><span id="currentCarbs">0</span>g</span>
                    </div>
                    <div class="text-sm font-semibold text-yellow-700 mb-1"><span id="targetCarbs">0</span>g</div>
                    <div class="w-full bg-yellow-200 rounded-full h-1">
                        <div id="carbsProgressBar" class="h-1 rounded-full bg-yellow-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <!-- è„‚è‚ª -->
                <div class="bg-red-50 rounded-lg p-2.5">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-[10px] text-red-600">è„‚è‚ª</span>
                        <span class="text-[10px] text-red-400"><span id="currentFat">0</span>g</span>
                    </div>
                    <div class="text-sm font-semibold text-red-700 mb-1"><span id="targetFat">0</span>g</div>
                    <div class="w-full bg-red-200 rounded-full h-1">
                        <div id="fatProgressBar" class="h-1 rounded-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ™®é€šè®¡åˆ’ç›®æ ‡æ˜¾ç¤º -->
        <div id="normalTarget" class="glass-card rounded-2xl p-4 shadow-lg">
            <h3 class="text-base font-semibold text-gray-800 mb-3">å½“æ—¥ç›®æ ‡</h3>
            <div class="grid grid-cols-4 gap-2">
                <div class="bg-gray-50 rounded-lg p-2 text-center">
                    <div class="text-xs text-gray-500">çƒ­é‡</div>
                    <div class="text-sm font-semibold text-gray-800"><span id="normalTargetCalories">0</span></div>
                    <div class="text-xs text-gray-400">kcal</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-2 text-center">
                    <div class="text-xs text-blue-600">è›‹ç™½è´¨</div>
                    <div class="text-sm font-semibold text-blue-700"><span id="normalTargetProtein">0</span></div>
                    <div class="text-xs text-blue-400">g</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-2 text-center">
                    <div class="text-xs text-yellow-600">ç¢³æ°´</div>
                    <div class="text-sm font-semibold text-yellow-700"><span id="normalTargetCarbs">0</span></div>
                    <div class="text-xs text-yellow-400">g</div>
                </div>
                <div class="bg-red-50 rounded-lg p-2 text-center">
                    <div class="text-xs text-red-600">è„‚è‚ª</div>
                    <div class="text-sm font-semibold text-red-700"><span id="normalTargetFat">0</span></div>
                    <div class="text-xs text-red-400">g</div>
                </div>
            </div>
        </div>

        <!-- å½“æ—¥é¤å• - åˆ—è¡¨å½¢å¼ -->
        <div class="glass-card rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-800">å½“æ—¥é¤å•</h3>
                <span class="text-xs text-gray-400" id="mealCount">0 ä¸ªé£Ÿç‰©</span>
            </div>
            
            <div class="space-y-3" id="mealList">
                <!-- é¤æ¬¡åˆ—è¡¨ç”± JS åŠ¨æ€æ¸²æŸ“ -->
            </div>
            
            <!-- æ·»åŠ é¤æ¬¡æŒ‰é’®ï¼ˆä»…ç¢³å¾ªç¯ç‰ˆæœ¬æ˜¾ç¤ºï¼‰ -->
            <button id="addMealBtn" onclick="showAddMealModal()" class="hidden w-full mt-3 py-2.5 border border-dashed border-gray-300 rounded-lg text-sm text-gray-500 hover:border-emerald-400 hover:text-emerald-600 transition-colors flex items-center justify-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                æ·»åŠ é¤æ¬¡
            </button>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3">
        <div class="flex space-x-3">
            <button onclick="goBack()" class="flex-1 bg-gray-100 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                å–æ¶ˆ
            </button>
            <button onclick="saveTemplate()" class="flex-1 bg-emerald-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                ä¿å­˜æ¨¡æ¿
            </button>
        </div>
    </div>

    <!-- é£Ÿç‰©é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="foodModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-end justify-center min-h-screen">
            <div class="bg-white rounded-t-3xl w-full max-w-md p-6 h-[70vh] flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">é€‰æ‹©é£Ÿç‰©</h3>
                    <button onclick="closeFoodModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="foodSearchInput" placeholder="æœç´¢é£Ÿç‰©..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" oninput="filterFoodList()">
                </div>
                <!-- åˆ†ç±»ç­›é€‰ -->
                <div class="flex space-x-2 overflow-x-auto pb-2 mb-4" id="categoryFilters">
                    <button class="category-btn active px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-emerald-100 text-emerald-700" data-category="all">å…¨éƒ¨</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="grains">ä¸»é£Ÿ</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="protein">è›‹ç™½è´¨</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="vegetables">è”¬èœ</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="fruits">æ°´æœ</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="nuts">åšæœ</button>
                    <button class="category-btn px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap bg-gray-100 text-gray-600" data-category="dairy">ä¹³åˆ¶å“</button>
                </div>
                <div class="space-y-2 flex-1 overflow-y-auto" id="foodListModal">
                    <!-- é£Ÿç‰©åˆ—è¡¨ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°é‡è¾“å…¥æ¨¡æ€æ¡† -->
    <div id="quantityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">æ·»åŠ é£Ÿç‰©</h3>
                    <p class="text-sm text-gray-500" id="foodName">é£Ÿç‰©åç§°</p>
                </div>
                <div class="mb-4 flex items-center">
                    <label class="text-sm font-medium text-gray-700 mr-3 whitespace-nowrap">æ•°é‡</label>
                    <div class="flex items-center flex-1">
                        <input type="number" id="foodQuantity" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" placeholder="è¯·è¾“å…¥æ•°é‡" value="100">
                        <span class="ml-3 text-sm text-gray-600">g</span>
                    </div>
                </div>
                <!-- è¥å…»æˆåˆ†é¢„è§ˆ -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="text-xs text-gray-500 mb-2">è¥å…»æˆåˆ†é¢„è§ˆ</div>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div>
                            <div class="text-xs text-gray-500">ç¢³æ°´</div>
                            <div class="text-sm font-medium text-yellow-600" id="previewCarbs">0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">è›‹ç™½è´¨</div>
                            <div class="text-sm font-medium text-red-600" id="previewProtein">0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">è„‚è‚ª</div>
                            <div class="text-sm font-medium text-blue-600" id="previewFat">0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">èƒ½é‡</div>
                            <div class="text-sm font-medium text-emerald-600" id="previewCalories">0 kcal</div>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeQuantityModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmAddFood()" class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                        ç¡®è®¤æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é¤æ¬¡æ¨¡æ€æ¡† -->
    <div id="addMealModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-sm p-5">
                <div class="text-center mb-4">
                    <h3 class="text-base font-medium text-gray-800">æ·»åŠ é¤æ¬¡</h3>
                    <p class="text-xs text-gray-500 mt-1">æ·»åŠ ä¸€ä¸ªæ–°çš„é¤æ¬¡åˆ°ä»Šå¤©çš„é¥®é£Ÿè®¡åˆ’</p>
                </div>
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 mb-1.5">é¤æ¬¡åç§°</label>
                    <input type="text" id="newMealName" maxlength="10" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-sm" placeholder="ä¾‹å¦‚ï¼šä¸ŠåˆèŒ¶ã€æ¶ˆå¤œ">
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeAddMealModal()" class="flex-1 bg-gray-100 text-gray-700 py-2.5 px-4 rounded-lg font-medium text-sm hover:bg-gray-200 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmAddMeal()" class="flex-1 bg-emerald-600 text-white py-2.5 px-4 rounded-lg font-medium text-sm hover:bg-emerald-700 transition-colors">
                        ç¡®è®¤æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFood = null;
        let currentCategory = 'all';
        let templateData = {
            name: '',
            targetCalories: 0,
            targetProtein: 0,
            targetFat: 0,
            targetCarbs: 0,
            meals: {
                breakfast: [],
                lunch: [],
                dinner: [],
                snacks: []
            },
            mealOrder: ['breakfast', 'lunch', 'dinner', 'snacks'] // ç¢³å¾ªç¯ç‰ˆæœ¬ç”¨äºå­˜å‚¨é¤æ¬¡é¡ºåº
        };

        // é¤æ¬¡é…ç½®
        const mealConfig = {
            breakfast: { name: 'æ—©é¤', icon: 'ğŸŒ…' },
            lunch: { name: 'åˆé¤', icon: 'â˜€ï¸' },
            dinner: { name: 'æ™šé¤', icon: 'ğŸŒ™' },
            snacks: { name: 'åŠ é¤', icon: 'ğŸ' }
        };

        // é£Ÿç‰©è¥å…»æ•°æ®åº“ (æ¯100g)
        const foodNutritionDB = {
            'ç‡•éº¦ç²¥': { carbs: 60, protein: 12, fat: 6, calories: 360 },
            'ç‰›å¥¶': { carbs: 4.8, protein: 3.2, fat: 3.2, calories: 54 },
            'é¦™è•‰': { carbs: 23, protein: 1.1, fat: 0.3, calories: 89 },
            'é¸¡èƒ¸è‚‰': { carbs: 0, protein: 31, fat: 3.6, calories: 165 },
            'ç³™ç±³é¥­': { carbs: 23, protein: 2.6, fat: 0.9, calories: 111 },
            'è¥¿å…°èŠ±': { carbs: 7, protein: 2.8, fat: 0.4, calories: 34 },
            'èƒ¡èåœ': { carbs: 9.6, protein: 0.9, fat: 0.2, calories: 41 },
            'æ©„æ¦„æ²¹': { carbs: 0, protein: 0, fat: 100, calories: 884 },
            'ä¸‰æ–‡é±¼': { carbs: 0, protein: 20, fat: 13, calories: 208 },
            'è’¸è›‹': { carbs: 0.6, protein: 13, fat: 10, calories: 143 },
            'è èœ': { carbs: 3.6, protein: 2.9, fat: 0.4, calories: 23 },
            'ç´«è–¯': { carbs: 20, protein: 1.6, fat: 0.2, calories: 86 },
            'é…¸å¥¶': { carbs: 4.7, protein: 10, fat: 0.5, calories: 59 },
            'æä»': { carbs: 21.6, protein: 21.2, fat: 49.4, calories: 579 },
            'è‹¹æœ': { carbs: 13.8, protein: 0.3, fat: 0.2, calories: 52 },
            'é¸¡è›‹': { carbs: 1, protein: 13, fat: 11, calories: 155 },
            'å…¨éº¦é¢åŒ…': { carbs: 41, protein: 13, fat: 4, calories: 247 },
            'ç‰›æ²¹æœ': { carbs: 8.5, protein: 2, fat: 14.7, calories: 160 },
            'è“è“': { carbs: 14.5, protein: 0.7, fat: 0.3, calories: 57 },
            'æ ¸æ¡ƒ': { carbs: 4, protein: 4, fat: 18, calories: 185 }
        };

        // é£Ÿç‰©é€‰æ‹©æ•°æ®åº“
        const foodDatabase = [
            { name: 'ç‡•éº¦ç²¥', calories: 180, protein: 6, fat: 3, carbs: 30, unit: '50g', category: 'grains' },
            { name: 'ç‰›å¥¶', calories: 120, protein: 6, fat: 6, carbs: 9, unit: '200ml', category: 'dairy' },
            { name: 'é¦™è•‰', calories: 80, protein: 1, fat: 0, carbs: 20, unit: '1æ ¹', category: 'fruits' },
            { name: 'é¸¡èƒ¸è‚‰', calories: 250, protein: 46, fat: 5, carbs: 0, unit: '150g', category: 'protein' },
            { name: 'ç³™ç±³é¥­', calories: 180, protein: 4, fat: 2, carbs: 36, unit: '100g', category: 'grains' },
            { name: 'è¥¿å…°èŠ±', calories: 35, protein: 3, fat: 0, carbs: 7, unit: '100g', category: 'vegetables' },
            { name: 'èƒ¡èåœ', calories: 30, protein: 1, fat: 0, carbs: 7, unit: '80g', category: 'vegetables' },
            { name: 'æ©„æ¦„æ²¹', calories: 85, protein: 0, fat: 9, carbs: 0, unit: '1å‹º', category: 'protein' },
            { name: 'ä¸‰æ–‡é±¼', calories: 280, protein: 25, fat: 18, carbs: 0, unit: '120g', category: 'protein' },
            { name: 'è’¸è›‹', calories: 140, protein: 12, fat: 10, carbs: 1, unit: '2ä¸ª', category: 'protein' },
            { name: 'è èœ', calories: 25, protein: 3, fat: 0, carbs: 4, unit: '100g', category: 'vegetables' },
            { name: 'ç´«è–¯', calories: 85, protein: 2, fat: 0, carbs: 20, unit: '100g', category: 'grains' },
            { name: 'é…¸å¥¶', calories: 80, protein: 4, fat: 0, carbs: 12, unit: '150g', category: 'dairy' },
            { name: 'æä»', calories: 20, protein: 1, fat: 2, carbs: 1, unit: '10é¢—', category: 'nuts' },
            { name: 'è‹¹æœ', calories: 52, protein: 0, fat: 0, carbs: 14, unit: '1ä¸ª', category: 'fruits' },
            { name: 'é¸¡è›‹', calories: 155, protein: 13, fat: 11, carbs: 1, unit: '2ä¸ª', category: 'protein' },
            { name: 'å…¨éº¦é¢åŒ…', calories: 120, protein: 4, fat: 2, carbs: 20, unit: '1ç‰‡', category: 'grains' },
            { name: 'ç‰›æ²¹æœ', calories: 160, protein: 2, fat: 15, carbs: 9, unit: 'åŠä¸ª', category: 'fruits' },
            { name: 'è“è“', calories: 42, protein: 1, fat: 0, carbs: 11, unit: '100g', category: 'fruits' },
            { name: 'æ ¸æ¡ƒ', calories: 185, protein: 4, fat: 18, carbs: 4, unit: '30g', category: 'nuts' }
        ];

        // ç¢³å¾ªç¯é…ç½®
        let carbCycleConfig = null;

        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const index = params.get('index') || 0;
            const planType = params.get('type') || 'custom';
            document.getElementById('pageTitle').textContent = `ç¼–è¾‘ Day ${parseInt(index) + 1}`;
            
            // åŠ è½½ç¢³å¾ªç¯é…ç½®
            const savedConfig = localStorage.getItem('carbCycleConfig');
            if (savedConfig && planType === 'carb-cycle') {
                carbCycleConfig = JSON.parse(savedConfig);
                // æ ¹æ®ç´¢å¼•ç¡®å®šé˜¶æ®µç±»å‹å¹¶æ˜¾ç¤º
                setupCarbCyclePhase(parseInt(index));
            }
            
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            document.getElementById('templateName').addEventListener('input', updateNameCharCount);
            
            loadTemplateData(index);
        });

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateNameCharCount() {
            const nameInput = document.getElementById('templateName');
            const charCount = nameInput.value.length;
            document.getElementById('nameCharCount').textContent = charCount;
        }

        // è®¾ç½®ç¢³å¾ªç¯é˜¶æ®µ
        function setupCarbCyclePhase(index) {
            if (!carbCycleConfig || !carbCycleConfig.phases) return;
            
            const phases = carbCycleConfig.phases;
            const highDays = phases.high?.days || 0;
            const mediumDays = phases.medium?.days || 0;
            
            let phaseType = 'low';
            if (index < highDays) {
                phaseType = 'high';
            } else if (index < highDays + mediumDays) {
                phaseType = 'medium';
            }
            
            const phaseConfig = phases[phaseType];
            if (!phaseConfig) return;
            
            // æ˜¾ç¤ºç¢³å¾ªç¯é˜¶æ®µå¡ç‰‡ï¼Œéšè—æ™®é€šç›®æ ‡å¡ç‰‡
            document.getElementById('phaseBadge').classList.remove('hidden');
            document.getElementById('normalTarget').classList.add('hidden');
            
            // æ›´æ–°é˜¶æ®µæ ‡è¯†
            const iconEl = document.getElementById('phaseIcon');
            const nameEl = document.getElementById('phaseName');
            const tagEl = document.getElementById('phaseTag');
            
            const phaseInfo = {
                'high': { icon: 'ğŸ”¥', name: 'é«˜ç¢³æ—¥', tag: 'é«˜ç¢³æ°´', tagClass: 'bg-yellow-100 text-yellow-700' },
                'medium': { icon: 'âš–ï¸', name: 'ä¸­ç¢³æ—¥', tag: 'åŸºå‡†', tagClass: 'bg-emerald-100 text-emerald-700' },
                'low': { icon: 'â„ï¸', name: 'ä½ç¢³æ—¥', tag: 'ä½ç¢³æ°´', tagClass: 'bg-blue-100 text-blue-700' }
            };
            
            const info = phaseInfo[phaseType];
            iconEl.textContent = info.icon;
            nameEl.textContent = info.name;
            tagEl.textContent = info.tag;
            tagEl.className = `px-2 py-0.5 rounded-full text-xs font-medium ${info.tagClass}`;
            
            // è®¾ç½®è¥å…»ç›®æ ‡
            templateData.targetCalories = phaseConfig.calories || 0;
            templateData.targetProtein = phaseConfig.protein || 0;
            templateData.targetCarbs = phaseConfig.carbs || 0;
            templateData.targetFat = phaseConfig.fat || 0;
            
            // æ›´æ–°æ˜¾ç¤ºï¼ˆä½¿ç”¨ textContent è€Œä¸æ˜¯ valueï¼‰
            document.getElementById('targetCalories').textContent = templateData.targetCalories;
            document.getElementById('targetProtein').textContent = templateData.targetProtein;
            document.getElementById('targetCarbs').textContent = templateData.targetCarbs;
            document.getElementById('targetFat').textContent = templateData.targetFat;
        }

        function loadTemplateData(index) {
            const saved = localStorage.getItem(`template_${index}`);
            if (saved) {
                const data = JSON.parse(saved);
                templateData = { ...templateData, ...data };
                document.getElementById('templateName').value = templateData.name || '';
            }
            
            // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
            updateNameCharCount();
            renderMeals();
            // å¦‚æœä¸æ˜¯ç¢³å¾ªç¯ï¼Œåˆ™è®¡ç®—ç›®æ ‡
            if (!carbCycleConfig) {
                calculateTargets();
            }
        }

        // æ¸²æŸ“é¤å•åˆ—è¡¨
        function renderMeals() {
            // ç¡®ä¿ mealOrder å­˜åœ¨
            if (!templateData.mealOrder) {
                templateData.mealOrder = ['breakfast', 'lunch', 'dinner', 'snacks'];
            }
            
            const meals = templateData.mealOrder;
            const mealListEl = document.getElementById('mealList');
            const isCarbCycle = !!carbCycleConfig;
            
            // æ˜¾ç¤º/éšè—æ·»åŠ é¤æ¬¡æŒ‰é’®
            document.getElementById('addMealBtn').classList.toggle('hidden', !isCarbCycle);
            
            let totalFoods = 0;
            let totalCarbs = 0, totalProtein = 0, totalFat = 0, totalCalories = 0;
            
            // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
            mealListEl.innerHTML = '';
            
            meals.forEach((mealId, index) => {
                const foods = templateData.meals[mealId] || [];
                totalFoods += foods.length;
                
                let mealCarbs = 0, mealProtein = 0, mealFat = 0, mealCalories = 0;
                foods.forEach(food => {
                    const nutrition = foodNutritionDB[food.name];
                    if (nutrition) {
                        const ratio = food.quantity / 100;
                        mealCarbs += nutrition.carbs * ratio;
                        mealProtein += nutrition.protein * ratio;
                        mealFat += nutrition.fat * ratio;
                        mealCalories += nutrition.calories * ratio;
                    }
                });
                
                // ç´¯åŠ åˆ°æ€»è®¡
                totalCarbs += mealCarbs;
                totalProtein += mealProtein;
                totalFat += mealFat;
                totalCalories += mealCalories;
                
                // è·å–é¤æ¬¡é…ç½®
                const config = mealConfig[mealId] || { name: `é¤æ¬¡${index + 1}`, icon: 'ğŸ½ï¸' };
                const summaryText = foods.length === 0 ? 'æœªé…ç½®' : `${foods.length} ä¸ªé£Ÿç‰©`;
                const summaryClass = foods.length === 0 ? 'text-xs text-gray-400' : 'text-xs text-emerald-600';
                
                // åˆ›å»ºé¤æ¬¡ DOM
                const mealCard = document.createElement('div');
                mealCard.className = 'meal-card bg-white rounded-lg p-3.5 shadow-sm border border-gray-100 cursor-pointer hover:border-emerald-300 relative group';
                mealCard.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è·³è½¬
                    if (e.target.closest('.delete-meal-btn')) return;
                    goToMealConfig(mealId);
                };
                
                // åˆ é™¤æŒ‰é’®ï¼ˆä»…ç¢³å¾ªç¯ç‰ˆæœ¬æ˜¾ç¤ºï¼‰
                const deleteBtn = isCarbCycle && meals.length > 1 ? `
                    <button onclick="deleteMeal('${mealId}')" class="delete-meal-btn absolute -right-1 -top-1 w-5 h-5 bg-red-100 text-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-200">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                ` : '';
                
                mealCard.innerHTML = `
                    ${deleteBtn}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-xl mr-3">${config.icon}</span>
                            <div>
                                <h4 class="font-medium text-gray-800 text-sm">${config.name}</h4>
                                <p class="${summaryClass} mt-0.5">${summaryText}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-800">${Math.round(mealCalories)} kcal</div>
                                <div class="text-[10px] text-gray-400 mt-0.5 space-x-1.5">
                                    <span>ğŸ${Math.round(mealCarbs)}g</span>
                                    <span>ğŸ¥©${Math.round(mealProtein)}g</span>
                                    <span>ğŸ¥‘${Math.round(mealFat)}g</span>
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                `;
                
                mealListEl.appendChild(mealCard);
            });
            
            document.getElementById('mealCount').textContent = `${totalFoods} ä¸ªé£Ÿç‰©`;
            
            // æ›´æ–°ç¢³å¾ªç¯è¥å…»è¿›åº¦
            if (isCarbCycle) {
                updateNutritionProgress(totalCalories, totalProtein, totalCarbs, totalFat);
            }
        }

        // åˆ é™¤é¤æ¬¡
        function deleteMeal(mealId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${mealConfig[mealId]?.name || mealId}"å—ï¼Ÿ`)) return;
            
            // ä»é¡ºåºä¸­ç§»é™¤
            templateData.mealOrder = templateData.mealOrder.filter(id => id !== mealId);
            
            // ä¿ç•™é£Ÿç‰©æ•°æ®ï¼Œä½†ç§»é™¤ä»æ˜¾ç¤ºåˆ—è¡¨
            // å¦‚æœè¦å½»åº•åˆ é™¤æ•°æ®ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
            // delete templateData.meals[mealId];
            
            renderMeals();
        }

        // æ˜¾ç¤ºæ·»åŠ é¤æ¬¡æ¨¡æ€æ¡†
        function showAddMealModal() {
            document.getElementById('addMealModal').classList.remove('hidden');
            document.getElementById('newMealName').value = '';
            document.getElementById('newMealName').focus();
        }

        // å…³é—­æ·»åŠ é¤æ¬¡æ¨¡æ€æ¡†
        function closeAddMealModal() {
            document.getElementById('addMealModal').classList.add('hidden');
        }

        // ç¡®è®¤æ·»åŠ é¤æ¬¡
        function confirmAddMeal() {
            const name = document.getElementById('newMealName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥é¤æ¬¡åç§°');
                return;
            }
            
            // ç”Ÿæˆå”¯ä¸€ ID
            const mealId = 'meal_' + Date.now();
            
            // æ·»åŠ åˆ°é…ç½®
            mealConfig[mealId] = { name: name, icon: 'ğŸ½ï¸' };
            
            // æ·»åŠ åˆ°é¡ºåºåˆ—è¡¨
            templateData.mealOrder.push(mealId);
            
            // åˆå§‹åŒ–é£Ÿç‰©åˆ—è¡¨
            templateData.meals[mealId] = [];
            
            closeAddMealModal();
            renderMeals();
        }

        // æ›´æ–°è¥å…»ç›®æ ‡è¿›åº¦
        function updateNutritionProgress(calories, protein, carbs, fat) {
            const targets = {
                calories: templateData.targetCalories || 1,
                protein: templateData.targetProtein || 1,
                carbs: templateData.targetCarbs || 1,
                fat: templateData.targetFat || 1
            };
            
            // æ›´æ–°å½“å‰å€¼
            document.getElementById('currentCalories').textContent = Math.round(calories);
            document.getElementById('currentProtein').textContent = Math.round(protein);
            document.getElementById('currentCarbs').textContent = Math.round(carbs);
            document.getElementById('currentFat').textContent = Math.round(fat);
            
            // è®¡ç®—å‰©ä½™
            const remainingCalories = Math.max(0, targets.calories - calories);
            document.getElementById('remainingCalories').textContent = Math.round(remainingCalories);
            
            // è®¡ç®—ç™¾åˆ†æ¯”
            const proteinPercent = Math.min(100, Math.round((protein / targets.protein) * 100));
            const carbsPercent = Math.min(100, Math.round((carbs / targets.carbs) * 100));
            const fatPercent = Math.min(100, Math.round((fat / targets.fat) * 100));
            
            // æ›´æ–°æ¡å½¢è¿›åº¦æ¡
            document.getElementById('proteinProgressBar').style.width = proteinPercent + '%';
            document.getElementById('carbsProgressBar').style.width = carbsPercent + '%';
            document.getElementById('fatProgressBar').style.width = fatPercent + '%';
        }

        // è®¡ç®—å½“æ—¥ç›®æ ‡
        function calculateTargets() {
            let totalCalories = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
            
            Object.values(templateData.meals).forEach(foods => {
                foods.forEach(food => {
                    totalCalories += food.calories;
                    const nutrition = foodNutritionDB[food.name];
                    if (nutrition) {
                        const ratio = food.quantity / 100;
                        totalCarbs += nutrition.carbs * ratio;
                        totalProtein += nutrition.protein * ratio;
                        totalFat += nutrition.fat * ratio;
                    }
                });
            });
            
            templateData.targetCalories = Math.round(totalCalories);
            templateData.targetCarbs = Math.round(totalCarbs);
            templateData.targetProtein = Math.round(totalProtein);
            templateData.targetFat = Math.round(totalFat);
            
            document.getElementById('targetCalories').value = totalCalories || '';
            document.getElementById('targetCarbs').value = Math.round(totalCarbs) || '';
            document.getElementById('targetProtein').value = Math.round(totalProtein) || '';
            document.getElementById('targetFat').value = Math.round(totalFat) || '';
        }
// è·³è½¬åˆ°é¤æ¬¡é…ç½®é¡µé¢
function goToMealConfig(meal) {
    const params = new URLSearchParams(window.location.search);
    const index = params.get('index') || 0;
    window.location.href = `meal-config.html?index=${index}&meal=${meal}`;
}


        function renderFoodList(filterText = '') {
            const foodList = document.getElementById('foodListModal');
            foodList.innerHTML = '';
            
            let filteredFoods = foodDatabase;
            
            // æŒ‰åˆ†ç±»ç­›é€‰
            if (currentCategory !== 'all') {
                filteredFoods = filteredFoods.filter(food => food.category === currentCategory);
            }
            
            // æŒ‰æœç´¢æ–‡æœ¬ç­›é€‰
            if (filterText) {
                filteredFoods = filteredFoods.filter(food => food.name.includes(filterText));
            }
            
            filteredFoods.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-emerald-50 transition-colors';
                foodItem.onclick = () => selectFood(food);
                foodItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold text-gray-800 text-base">${food.name}</div>
                        <div class="text-lg font-bold text-emerald-600">${food.calories} <span class="text-xs font-normal text-gray-400">kcal</span></div>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">æ¯${food.unit}</span>
                        <div class="flex items-center gap-3 text-gray-500">
                            <span>ğŸ ${food.carbs}g</span>
                            <span>ğŸ¥© ${food.protein}g</span>
                            <span>ğŸ¥‘ ${food.fat}g</span>
                        </div>
                    </div>
                `;
                foodList.appendChild(foodItem);
            });
        }

        function filterFoodList() {
            const searchText = document.getElementById('foodSearchInput').value;
            renderFoodList(searchText);
        }

        // åˆ†ç±»ç­›é€‰äº‹ä»¶ç›‘å¬
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('category-btn')) {
                // æ›´æ–°æŒ‰é’®æ ·å¼
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-emerald-100', 'text-emerald-700');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                });
                e.target.classList.remove('bg-gray-100', 'text-gray-600');
                e.target.classList.add('active', 'bg-emerald-100', 'text-emerald-700');
                
                // æ›´æ–°å½“å‰åˆ†ç±»å¹¶é‡æ–°æ¸²æŸ“
                currentCategory = e.target.dataset.category;
                const searchText = document.getElementById('foodSearchInput').value;
                renderFoodList(searchText);
            }
        });

        function closeFoodModal() {
            document.getElementById('foodModal').classList.add('hidden');
        }

        function selectFood(food) {
            currentFood = food;
            document.getElementById('foodName').textContent = food.name;
            document.getElementById('foodQuantity').value = 100;
            updatePreview(food.name, 100);
            closeFoodModal();
            document.getElementById('quantityModal').classList.remove('hidden');
        }

        function updatePreview(foodName, quantity) {
            const nutrition = foodNutritionDB[foodName];
            if (!nutrition) return;
            
            const ratio = quantity / 100;
            const carbs = (nutrition.carbs * ratio).toFixed(1);
            const protein = (nutrition.protein * ratio).toFixed(1);
            const fat = (nutrition.fat * ratio).toFixed(1);
            const calories = Math.round(nutrition.calories * ratio);
            
            document.getElementById('previewCarbs').textContent = carbs + 'g';
            document.getElementById('previewProtein').textContent = protein + 'g';
            document.getElementById('previewFat').textContent = fat + 'g';
            document.getElementById('previewCalories').textContent = calories + ' kcal';
        }

        // ç›‘å¬æ•°é‡å˜åŒ–
        document.getElementById('foodQuantity').addEventListener('input', function() {
            const foodName = document.getElementById('foodName').textContent;
            const quantity = parseFloat(this.value) || 0;
            updatePreview(foodName, quantity);
        });

        // æ·»åŠ é¤æ¬¡å›è½¦ç¡®è®¤
        document.getElementById('newMealName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddMeal();
            }
        });

        function closeQuantityModal() {
            document.getElementById('quantityModal').classList.add('hidden');
        }

        function confirmAddFood() {
            const quantity = parseFloat(document.getElementById('foodQuantity').value) || 100;
            
            if (!quantity || quantity <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            const nutrition = foodNutritionDB[currentFood.name];
            const calories = nutrition ? Math.round(nutrition.calories * quantity / 100) : 0;
            
            const foodItem = {
                name: currentFood.name,
                quantity: quantity,
                unit: 'g',
                calories: calories
            };
            
            const editIndex = document.getElementById('quantityModal').dataset.editIndex;
            if (editIndex !== undefined && editIndex !== '') {
                templateData.meals[currentMeal][parseInt(editIndex)] = foodItem;
                delete document.getElementById('quantityModal').dataset.editIndex;
            } else {
                templateData.meals[currentMeal].push(foodItem);
            }
            
            closeQuantityModal();
            renderMeals();
            renderMealFoodList();
            calculateTargets();
        }

        function goBack() {
            window.history.back();
        }

        function deleteTemplate() {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) {
                const params = new URLSearchParams(window.location.search);
                const index = params.get('index');
                localStorage.removeItem(`template_${index}`);
                goBack();
            }
        }

        function saveTemplate() {
            const nameInput = document.getElementById('templateName');
            // é™åˆ¶åç§°é•¿åº¦ä¸º6ä¸ªå­—ç¬¦
            templateData.name = nameInput.value.substring(0, 6);
            
            const params = new URLSearchParams(window.location.search);
            const index = params.get('index') || 0;
            localStorage.setItem(`template_${index}`, JSON.stringify(templateData));
            
            alert('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
            goBack();
        }

        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹æ¡†
        document.getElementById('addMealModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddMealModal();
        });
        document.getElementById('foodModal').addEventListener('click', function(e) {
            if (e.target === this) closeFoodModal();
        });
        document.getElementById('quantityModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuantityModal();
        });
    </script>
</body>
</html>
