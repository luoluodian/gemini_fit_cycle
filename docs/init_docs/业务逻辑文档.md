# 饮食记录应用 - 业务逻辑文档

## 文档说明
本文档详细梳理了从 login.html 开始的完整业务流程，包括所有页面的业务逻辑和分支流程。

## 目录
1. [登录模块](#1-登录模块)
2. [主页记录模块](#2-主页记录模块)
3. [计划管理模块](#3-计划管理模块)
4. [食材库模块](#4-食材库模块)
5. [个人中心模块](#5-个人中心模块)
6. [数据流转](#6-数据流转)

---

## 1. 登录模块

### 1.1 页面入口：login.html

#### 业务场景
用户首次访问应用或未登录状态下的入口页面。

#### 核心功能

**1.1.1 页面初始化**
- 加载完成后执行 `initializePage()`
- 播放入场动画（卡片和按钮渐入效果）
- 调用 `checkLoginStatus()` 检查登录状态

**1.1.2 登录状态检查**
```javascript
checkLoginStatus() {
  const userToken = localStorage.getItem('userToken');
  const userInfo = localStorage.getItem('userInfo');
  
  if (userToken && userInfo) {
    // 已登录 -> 跳转到 index.html（主页）
  }
}
```

**分支1：微信登录流程**
1. 用户点击"微信一键登录"按钮
2. 触发 `wechatLogin()`
3. 检查微信 JS-SDK 是否加载
4. 调用 `wx.login()` 获取 code
5. 将 code 发送到后端 `authenticateWithBackend(code)`
6. 后端验证成功后返回：
   - userToken
   - userInfo（openId, nickName, avatarUrl等）
7. 保存到 localStorage
8. 显示"登录成功"提示
9. 1.5秒后跳转到 index.html

**分支2：免登录体验**
1. 用户点击"先体验一下"按钮
2. 触发 `tryWithoutLogin()`
3. 弹出确认对话框："免登录体验模式下，数据将不会保存"
4. 用户确认后：
   - 设置 `localStorage.setItem('demoMode', 'true')`
   - 跳转到 index.html
5. 用户取消则停留在登录页

**分支3：查看隐私政策**
1. 用户点击"查看隐私政策"
2. 显示隐私政策模态框
3. 用户可以关闭模态框

#### 错误处理
- 微信 SDK 未加载：显示错误提示
- 登录失败：显示错误消息，5秒后自动隐藏
- 后端验证失败：提示"登录验证失败，请重试"

#### 数据存储
- `userToken`: 用户认证令牌
- `userInfo`: 用户基本信息（JSON字符串）
- `demoMode`: 体验模式标记

---

## 2. 主页记录模块

### 2.1 页面：index.html

#### 业务场景
用户记录每日饮食摄入的核心页面。

#### 核心功能

**2.1.1 页面初始化**
```javascript
initializePage() {
  updateDateDisplay();        // 显示当前日期
  checkLoginStatus();         // 验证登录状态
  loadActivePlan();          // 加载激活的计划
  loadMealData();            // [Prototype] 加载静态示例餐食数据 (暂未连接 localStorage)
  updateNutritionStats();    // 更新营养统计
}
```

**2.1.2 登录状态验证**
- 检查 `userToken` 或 `demoMode`
- 未登录且非体验模式 -> 跳转到 login.html
- 已登录 -> 显示用户信息

**2.1.3 日期导航**
- 点击"上一天"：`changeDate(-1)`
- 点击"下一天"：`changeDate(1)`
- 切换日期时：
  - 更新日期显示
  - 重新加载该日期的餐食数据
  - 更新营养统计
  - 播放切换动画

**2.1.4 餐食记录 - 四个餐次**

每个餐次（早餐/午餐/晚餐/加餐）都有相同的操作流程：

**分支A：添加食物**
1. 点击"+ 添加食物"按钮
2. 触发 `addFoodItem(mealType)`，设置 `currentMealType`
3. 显示食物选择模态框 `showFoodModal()`
4. 渲染食物列表（[Prototype] 使用 `main.js` 内置硬编码 `foodDatabase`，未读取 `food.html` 创建的自定义食材）
5. 用户选择食物 -> `selectFood(food)`
6. 显示数量输入模态框 `showQuantityModal()`
7. 用户输入数量和单位
8. 点击"确认添加" -> `confirmAddFood()`
9. 计算实际营养值（根据数量比例）
10. 创建食物项DOM元素
11. 添加到对应餐次容器
12. 更新餐次总计 `updateMealTotal()`
13. 更新今日目标 `updateDailyGoals()`

**分支B：按计划记录本餐**
1. 点击"按计划记录本餐"按钮
2. 触发 `recordMeal(mealType)`
3. 检查是否有激活计划
4. 计算当前日期在周期中的天数
5. 获取对应日模板的餐食配置
6. 显示确认对话框
7. 用户确认后：
   - 清空现有餐食（带删除动画）
   - 添加计划中的所有食物（带入场动画）
   - 更新营养统计

**分支C：编辑食物**
1. 点击食物项的编辑按钮
2. 检查是否已记录状态
3. 如果已记录：
   - 显示提示："该食物已记录，更改后将改为未记录状态"
   - 用户确认后继续
4. 显示编辑模态框
5. 填充当前数量和单位
6. 实时预览营养成分变化
7. 用户修改后点击"确认修改"
8. 更新食物项显示
9. 更新餐次总计和今日目标

**分支D：删除食物**
1. 点击食物项的删除按钮
2. 显示删除确认对话框
3. 用户确认后：
   - 播放删除动画
   - 从DOM中移除
   - 更新餐次总计
   - 更新今日目标

**2.1.5 今日目标统计**

实时计算和显示：
- 目标热量 vs 已摄入热量
- 蛋白质进度条（已摄入/目标）
- 脂肪进度条
- 碳水化合物进度条

计算逻辑：
```javascript
updateDailyGoals() {
  // 遍历所有食物项
  // 累加各营养素
  // 更新进度条宽度
  // 更新文本显示
}
```

**2.1.6 食物搜索和分类**

在食物选择模态框中：
- 搜索框：实时过滤食物列表
- 分类标签：全部/主食/蛋白质/蔬菜/水果/坚果/乳制品
- 点击分类 -> 筛选对应类别的食物

#### 数据流转
- 从 localStorage 读取：
  - 激活的计划配置
  - 历史餐食记录
- 保存到 localStorage：
  - 每日餐食记录（按日期存储）([Prototype] 暂未实现，仅更新 DOM)
  - 食物记录状态 ([Prototype] 暂未实现)

---

## 3. 计划管理模块

### 3.1 计划列表页：plan.html

#### 核心功能

**3.1.1 计划分类展示**

**Tab切换**
- 进行中：显示所有 status='active' 或 'paused' 的计划 ([Prototype] 目前读取静态 Mock 数据，未连接 localStorage)
- 已完成：显示所有 status='completed' 的计划 ([Prototype] 目前读取静态 Mock 数据)

**计划卡片信息**
- 计划名称
- 计划类型（减脂/增肌/维持）
- 剩余天数
- 每日热量目标
- 完成进度（百分比和进度条）
- 状态标签（进行中/暂停中/已完成）

**3.1.2 创建新计划**

点击"新建"按钮 -> 显示创建选项模态框：

**选项1：创建新计划**
1. 点击"创建新计划"
2. 跳转到 new-plan.html

**选项2：导入计划**
1. 点击"导入计划"
2. 显示导入模态框
3. 输入分享码（格式：PLAN-XXXX）
4. 验证分享码格式
5. 调用导入接口
6. 成功后添加到计划列表

**3.1.3 推荐计划**

显示三种预设计划模板：
- 30天减脂挑战
- 增肌训练计划
- 均衡营养计划

点击"创建"按钮：
1. 预填充计划参数
2. 跳转到 new-plan.html
3. 表单已填充模板数据

**3.1.4 计划操作**

点击计划卡片 -> `viewPlanDetail(planId)` -> 跳转到计划详情页

长按或点击菜单按钮 -> 显示操作菜单：
- 编辑计划：修改基本信息和目标
- 分享计划：生成分享码
- 复制计划：创建副本
- 归档计划：移到归档列表
- 删除计划：永久删除（需确认）

### 3.2 创建计划页：new-plan.html

#### 业务流程

**步骤1：基础信息**
1. 输入计划名称（必填）
2. 选择计划类型：
   - 普通：常规计划
   - 进阶：碳循环计划
3. 设置周期参数：
   - 每周期天数（建议3-7天）
   - 周期数量
   - 自动计算总天数
4. 勾选"保存后设为当前激活计划"

**步骤2：类型分支**

**分支A：普通计划**
- 点击"下一步"
- 跳转到 plan-templates.html
- 开始配置日模板

**分支B：碳循环计划**
- 点击"下一步"
- 跳转到 carb-cycle-setup.html
- 配置碳循环参数（高碳日/低碳日/中碳日）
- 然后跳转到 plan-templates.html

### 3.3 模板配置页：plan-templates.html

#### 核心功能

**3.3.1 日模板管理**

**添加模板**
1. 点击"添加新模板"按钮
2. 检查是否达到周期天数上限
3. 创建新模板对象：
   ```javascript
   {
     id: 'template_' + timestamp,
     dayNumber: 当前数量 + 1,
     name: 'Day1',
     target: { calories, protein, fat, carbs },
     meals: { breakfast: [], lunch: [], dinner: [], snacks: [] }
   }
   ```
4. 添加到模板列表
5. 自动选中新模板

**复制模板**
1. 点击模板的复制按钮
2. 深拷贝源模板
3. 修改名称为"原名称-副本"
4. 添加到列表

**删除模板**
1. 点击模板菜单
2. 确认删除
3. 检查至少保留1个模板
4. 删除并重新编号

**一键补满周期**
1. 点击"一键补满"按钮
2. 计算缺少的天数
3. 循环复制现有模板
4. 自动命名（Day1-A, Day1-B等）

**3.3.2 模板详情编辑**

选中模板后显示详情区域：

**基本信息**
- 模板名称（可编辑）
- 每日目标：
  - 热量（kcal）
  - 蛋白质（g）
  - 脂肪（g）
  - 碳水化合物（g）

**餐单配置**

每个餐次（早餐/午餐/晚餐/加餐）：

1. 点击"+ 添加食物"
2. 显示食物选择模态框
3. 选择食物
4. 输入数量和单位
5. 确认添加到餐单
6. 显示在餐次列表中
7. 可以删除已添加的食物

**保存模板**
- 点击"保存模板详情"
- 更新模板数据
- 刷新模板列表显示

**3.3.3 保存计划**

点击底部"保存计划"按钮：
1. 验证必填字段（计划名称、至少1个模板）
2. 保存当前编辑的模板详情
3. 构建完整计划对象
4. 保存到 localStorage 的 'dietPlans' ([Prototype] 代码中目前为 TODO 状态，仅演示跳转)
5. 如果勾选了"设为激活"，更新激活计划
6. 显示成功提示
7. 2秒后跳转到 plan.html

---

## 4. 食材库模块

### 4.1 页面：food.html

#### 核心功能

**4.1.1 食材分类浏览**

**分类标签**
- 全部
- 我的收藏
- 我的创建
- 系统食材
- 蛋白质
- 蔬菜
- 水果
- 谷物
- 乳制品
- 坚果

点击分类 -> `filterByCategory(category)` -> 筛选并显示对应食材

**4.1.2 搜索功能**

1. 点击搜索图标
2. 显示搜索框（带动画）
3. 输入关键词
4. 实时过滤食材列表（按名称和描述匹配）
5. 再次点击搜索图标可隐藏搜索框

**4.1.3 热门食材**

横向滚动展示常用食材：
- 香蕉、鸡蛋、牛奶、全麦面包、鸡胸肉等
- 点击 -> 查看详情

**4.1.4 食材列表**

每个食材卡片显示：
- 图标（emoji）
- 名称
- 类型标签（系统/我的）
- 营养成分（蛋白质/脂肪/碳水）
- 热量

点击卡片 -> `viewFoodDetail(foodId)` -> 显示详情模态框

**4.1.5 食材详情**

模态框内容：
- 食材图标和名称
- 分类标签
- 描述信息
- 营养成分（每100g）：
  - 碳水化合物
  - 蛋白质
  - 脂肪
  - 热量
- 收藏按钮（可切换收藏状态）

**4.1.6 创建自定义食材**

点击"新建"按钮 -> 显示创建表单：

**表单字段**
1. 食物名称（必填）
2. 单位（克/毫升/个/杯/勺）
3. 分类标签（多选）：
   - 蛋白质、蔬菜、水果、谷物、乳制品、坚果、零食、饮品
4. 营养成分（每100g）：
   - 热量（必填）
   - 蛋白质
   - 脂肪
   - 碳水化合物
5. 描述（可选）
6. 公开食材开关（允许其他用户使用）

**创建流程**
1. 填写表单
2. 验证必填字段
3. 检查名称是否重复
4. 创建食材对象：
   ```javascript
   {
     id: 'custom_' + timestamp,
     name, unit, calories, protein, fat, carbs,
     description, emoji, isPublic,
     category: 'custom',
     type: 'custom',
     tags: [],
     createdAt: ISO时间戳
   }
   ```
5. 添加到 customFoods 数组
6. 保存到 localStorage
7. 关闭模态框
8. 刷新食材列表

**4.1.7 收藏功能**

点击收藏按钮：
1. 切换 `isFavorite` 状态
2. 更新 localStorage
3. 显示提示消息
4. 刷新列表（如果在"我的收藏"分类中）

#### 数据存储
- `customFoods`: 自定义食材数组（JSON）
- 系统食材存储在 foodDatabase 对象中（代码内置）

---

## 5. 个人中心模块

### 5.1 页面：profile.html

#### 核心功能

**5.1.1 用户信息展示**

顶部卡片：
- 用户头像（默认图标）
- 用户昵称
- 坚持天数统计
- 当前计划信息：
  - 计划名称
  - 当前周数
  - 剩余天数
  - 状态标签
- 操作按钮：
  - 查看计划 -> 跳转到 plan.html
  - 编辑计划 -> 编辑功能（开发中）

**5.1.2 快速统计**

两个统计卡片：
- 坚持使用天数
- 完成计划数

**5.1.3 本周摄入趋势**

ECharts 图表展示：
- X轴：周一到周日
- Y轴：热量（kcal）
- 两条线：
  - 目标热量（虚线）
  - 实际摄入（实线+面积填充）
- 下方显示：
  - 平均摄入
  - 达标天数
  - 本周变化（体重）

**5.1.4 健康工具**

**工具1：BMR/TDEE 计算器**
1. 点击打开计算器模态框
2. 输入参数：
   - 性别（男/女）
   - 年龄
   - 身高（cm）
   - 体重（kg）
   - 活动水平（5个选项）
3. 点击"计算"
4. 使用 Mifflin-St Jeor 公式计算 BMR：
   - 男性：10×体重 + 6.25×身高 - 5×年龄 + 5
   - 女性：10×体重 + 6.25×身高 - 5×年龄 - 161
5. 计算 TDEE = BMR × 活动系数
6. 显示结果：
   - 基础代谢（BMR）
   - 每日消耗（TDEE）
   - 目标建议：
     - 减脂：TDEE × 0.8
     - 维持：TDEE
     - 增肌：TDEE × 1.2
7. 保存到 localStorage

**工具2：体重记录**（开发中）
- 每日体重记录
- 体重变化趋势图
- 目标体重设置

**工具3：营养指南**（开发中）
- 营养素知识库
- 健康食谱推荐
- 饮食误区解析

**5.1.5 设置功能**

**应用设置**（开发中）
- 通知设置
- 隐私设置
- 数据同步
- 主题设置

**帮助与反馈**（开发中）
- 使用教程
- 常见问题
- 意见反馈
- 联系客服

**关于应用**
显示模态框：
- 应用图标
- 应用名称和版本
- 开发者信息
- 发布日期
- 功能特色列表

**5.1.6 导入计划**

1. 点击"导入"按钮
2. 显示导入模态框
3. 输入分享码
4. 验证格式（PLAN-开头）
5. 调用导入接口
6. 成功后跳转到 plan.html

---

## 6. 数据流转

### 6.1 LocalStorage 数据结构与现状 (Data State)

> **⚠️ 现状警告 (Prototype Limitation)**:
> 当前代码实现存在数据孤岛问题。以下定义的统一数据结构是目标架构，但在原型中：
> 1. `foodDatabase` 存在多份硬编码副本（`main.js`, `daily-plan.js`, `food-selector.js`），互不同步。
> 2. `dietPlans` 虽被创建流程写入，但列表页和详情页使用的是独立的 Mock 数据对象 (`const planData`)。
> 3. 自定义食材 (`customFoods`) 仅在 `food.html` 有效，未被其他模块读取。

```javascript
// 用户认证
userToken: string                    // 用户令牌
userInfo: JSON string                // 用户信息对象
demoMode: 'true' | undefined         // 体验模式标记

// 计划数据
dietPlans: JSON string               // 计划数组
[{
  id: string,
  name: string,
  type: 'fat-loss' | 'muscle-gain' | 'maintenance',
  isActive: boolean,
  cycleDays: number,
  cycleCount: number,
  dayTemplates: [{
    id: string,
    dayNumber: number,
    name: string,
    target: { calories, protein, fat, carbs },
    meals: {
      breakfast: [食物对象],
      lunch: [食物对象],
      dinner: [食物对象],
      snacks: [食物对象]
    }
  }],
  createdAt: ISO时间戳
}]

// 食材数据
customFoods: JSON string             // 自定义食材数组
[{
  id: string,
  name: string,
  calories: number,
  protein: number,
  fat: number,
  carbs: number,
  unit: string,
  description: string,
  emoji: string,
  category: string,
  type: 'custom',
  isFavorite: boolean,
  tags: string[],
  createdAt: ISO时间戳
}]

// 餐食记录
mealRecords: JSON string             // 按日期存储的餐食记录
{
  '2024-12-11': {
    breakfast: [食物项],
    lunch: [食物项],
    dinner: [食物项],
    snacks: [食物项]
  }
}

// 用户健康数据
userHealthData: JSON string          // BMR/TDEE计算结果
{
  gender: 'male' | 'female',
  age: number,
  height: number,
  weight: number,
  activityLevel: number,
  bmr: number,
  tdee: number
}
```

### 6.2 页面跳转流程图

```
login.html
  ├─ 登录成功 → index.html
  ├─ 体验模式 → index.html
  └─ 未登录 ← 其他页面检测到未登录

index.html (主页)
  ├─ 底部导航 → plan.html
  ├─ 底部导航 → food.html
  ├─ 底部导航 → profile.html
  └─ 添加食物 → 食物选择模态框

plan.html (计划列表)
  ├─ 新建计划 → new-plan.html
  ├─ 查看详情 → plan-detail.html
  └─ 底部导航 → 其他页面

new-plan.html (创建计划)
  ├─ 普通计划 → plan-templates.html
  ├─ 碳循环 → carb-cycle-setup.html → plan-templates.html
  └─ 取消 → plan.html

plan-templates.html (模板配置)
  ├─ 保存成功 → plan.html
  └─ 返回 → new-plan.html

food.html (食材库)
  ├─ 查看详情 → 详情模态框
  ├─ 创建食材 → 创建模态框
  └─ 底部导航 → 其他页面

profile.html (个人中心)
  ├─ 查看计划 → plan.html
  ├─ BMR计算器 → 计算器模态框
  ├─ 导入计划 → 导入模态框
  └─ 底部导航 → 其他页面
```

### 6.3 关键业务规则

1. **登录验证**：所有页面（除login.html）都需要检查登录状态
2. **激活计划**：同时只能有一个激活的计划
3. **日期记录**：每个日期的餐食记录独立存储 ([Prototype] 暂未实现)
4. **模板周期**：日模板数量必须等于周期天数
5. **营养计算**：所有营养值基于100g/ml标准计算
6. **数据同步**：所有修改立即保存到localStorage ([Prototype] 部分模块未实现)
7. **体验模式**：demoMode下数据不持久化（刷新后丢失）

---

## 附录：状态码和错误处理

### 常见错误场景

1. **未登录访问**
   - 检测：无userToken且无demoMode
   - 处理：跳转到login.html

2. **微信SDK加载失败**
   - 检测：typeof wx === 'undefined'
   - 处理：显示错误提示，延迟重试

3. **表单验证失败**
   - 检测：必填字段为空或格式错误
   - 处理：alert提示，阻止提交

4. **数据解析失败**
   - 检测：JSON.parse抛出异常
   - 处理：使用默认值或空数组

5. **超出限制**
   - 检测：模板数量超过周期天数
   - 处理：提示"已达到最大天数"

### 成功提示规范

所有成功操作使用统一的toast提示：
- 位置：顶部居中
- 样式：绿色背景，白色文字
- 动画：渐入渐出
- 持续时间：3秒

---

**文档版本**：v1.0  
**最后更新**：2024-12-11  
**维护者**：开发团队

