# 编码规范文档

## 通用规范

### 代码风格
- 遵循 ESLint 配置和项目代码规范
- 使用 TypeScript 严格模式
- 代码格式化使用 Prettier
- 所有代码必须通过 ESLint 检查

### 命名规范
- **变量和函数**：使用 camelCase（驼峰命名）
- **类名和接口**：使用 PascalCase（大驼峰命名）
- **常量**：使用 UPPER_SNAKE_CASE（大写下划线）
- **文件名**：
  - 后端：使用 kebab-case（短横线命名），如 `user.service.ts`
  - 前端：使用 PascalCase（大驼峰），如 `UserProfile.vue`

### 注释规范
- 所有公共函数和类必须添加 JSDoc 注释
- 复杂业务逻辑必须添加行内注释
- 注释使用中文，清晰说明代码意图

## 后端编码规范（NestJS）

### 文件结构
```
module/
├── module.controller.ts    # 控制器
├── module.service.ts      # 服务层
├── module.entity.ts       # 实体定义
├── module.dto.ts          # 数据传输对象
└── module.module.ts       # 模块定义
```

### 控制器规范
- 使用装饰器模式进行依赖注入
- 每个路由方法必须添加 Swagger 文档注释
- 使用 DTO 进行参数验证
- 统一使用响应拦截器返回数据

```typescript
@Controller('users')
@ApiTags('用户管理')
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Post()
  @ApiOperation({ summary: '创建用户' })
  @ApiResponse({ status: 201, description: '创建成功' })
  async create(@Body() createUserDto: CreateUserDto) {
    return this.userService.create(createUserDto);
  }
}
```

### 服务层规范
- 遵循单一职责原则
- 业务逻辑封装在服务层
- 使用事务确保数据一致性
- 异常处理使用自定义异常类

```typescript
@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
  ) {}

  async create(createUserDto: CreateUserDto): Promise<User> {
    // 业务逻辑实现
  }
}
```

### DTO 规范
- 使用 class-validator 进行数据验证
- 使用 class-transformer 进行数据转换
- 每个 DTO 必须添加验证装饰器

```typescript
export class CreateUserDto {
  @IsString()
  @IsNotEmpty()
  @ApiProperty({ description: '用户名' })
  username: string;

  @IsEmail()
  @ApiProperty({ description: '邮箱' })
  email: string;
}
```

### 实体规范
- 使用 TypeORM 装饰器定义实体
- 必须定义主键
- 关联关系必须明确定义
- 使用时间戳字段（createdAt, updatedAt）

```typescript
@Entity('users')
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  username: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

### 错误处理
- 使用 NestJS 异常过滤器统一处理异常
- 自定义业务异常类
- 所有异常必须记录日志

## 前端编码规范（Vue 3 + Taro）

### 组件规范
- 使用 Vue 3 Composition API
- 保持组件单一职责原则
- 组件名使用 PascalCase
- Props 必须定义类型和默认值

```vue
<script setup lang="ts">
interface Props {
  title: string;
  count?: number;
}

const props = withDefaults(defineProps<Props>(), {
  count: 0,
});
</script>
```

### 样式规范
- 使用 Sass 预处理器
- 遵循 BEM 命名规范（如适用）
- 使用 Tailwind CSS 工具类优先
- 响应式设计使用移动端优先策略

### 状态管理
- 使用 Pinia 进行状态管理
- Store 按功能模块划分
- 状态变更必须通过 Actions

### API 调用
- 统一使用 services 层封装 API 调用
- 使用 TypeScript 定义接口类型
- 统一错误处理

```typescript
// services/user.ts
export interface UserInfo {
  id: number;
  username: string;
}

export async function getUserInfo(id: number): Promise<UserInfo> {
  return request.get(`/api/users/${id}`);
}
```

### 性能优化
- 使用 `v-show` 替代 `v-if`（频繁切换时）
- 大列表使用虚拟滚动
- 图片使用懒加载
- 组件按需加载

## Git 提交规范

### 提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type 类型
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具相关

### 示例
```
feat(backend): 添加用户登录接口

- 实现 JWT 认证
- 添加登录验证逻辑
- 更新 API 文档

Closes #123
```

## 测试规范

### 单元测试
- 核心业务逻辑必须达到 90% 以上覆盖率
- 使用 Jest 编写测试用例
- 测试用例命名清晰，描述测试场景

```typescript
describe('UserService', () => {
  it('should create a user successfully', async () => {
    // 测试实现
  });
});
```

### 集成测试
- 关键业务流程必须编写集成测试
- 使用测试数据库
- 测试后清理测试数据

## 安全规范

### 后端安全
- 所有用户输入必须验证
- 使用参数化查询防止 SQL 注入
- JWT Token 必须设置过期时间
- 敏感信息必须加密存储
- API 必须实现访问频率限制

### 前端安全
- 防止 XSS 攻击，对用户输入进行转义
- 敏感信息不存储在 localStorage
- API 密钥不暴露在前端代码
- 使用 HTTPS 传输数据

## 性能规范

### 后端性能
- API 响应时间 < 200ms
- 支持 1000 并发用户
- 数据库查询必须使用索引
- 合理使用 Redis 缓存

### 前端性能
- 首屏加载时间 < 2秒
- 交互响应时间 < 100ms
- 图片必须压缩和优化
- 代码必须压缩和混淆

## 文档规范

### 代码文档
- 所有公共 API 必须添加 Swagger 文档
- 复杂算法必须添加注释说明
- README 必须包含项目说明和运行指南

### 开发文档
- 所有功能开发必须创建计划文档
- 代码变更必须记录变更说明
- 自测必须生成自测报告
