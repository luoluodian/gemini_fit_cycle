# P-1: Plan 实体设计 - T5 分析文档

> **任务 ID**: P-1  
> **任务名称**: Plan 实体设计  
> **优先级**: P0  
> **垂直拆分**: 后端 DB  
> **预估工时**: 4h  
> **复杂度**: 中  
> **分析时间**: 2026-02-02 20:30  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `users` (`fit_cycle_app/src/database/entity/user.entity.ts`): 计划所属者。
- [x] `data_dictionary` (`fit_cycle_app/src/database/entity/data-dictionary.entity.ts`): 用于计划类型、状态、碳循环日类型的枚举引用。
- [x] `food_items` (`fit_cycle_app/src/database/entity/food-item.entity.ts`): 计划餐次中预设的食材。

### 涉及跨模块 Service
- [ ] 无 (本任务为纯 DB 设计)

### 所有关联模块
- `UserModule`: 提供用户身份。
- `FoodModule`: 提供计划中引用的食材。
- `PlanModule`: 核心业务模块。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/database/entity/diet-plan.entity.ts`: 增加 `is_template`, `cycle_days`, `cycle_count`, `carb_cycle_config` 等字段，对齐规约。
- [x] `fit_cycle_app/src/database/entity/plan-day.entity.ts`: 对齐规约，作为计划内的“日模板”。
- [x] `fit_cycle_app/src/database/entity/plan-meal.entity.ts`: 完善餐次关联。
- [x] `fit_cycle_app/src/database/entity/plan-meal-item.entity.ts`: 完善餐次食材关联。

### 对现有功能的影响
- [x] **有影响**: 计划域的实体结构调整会影响后续 P-2 至 P-14 所有任务的实现。需确保当前修改完整覆盖 `04_接口与数据规约.md`。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 数据库字段的唯一真理来源。
- `html/carb-cycle-setup.html`: 参考碳循环配置的 UI 结构。

### 潜在的破坏性变更
- [x] **有破坏性变更**: 修改现有实体字段名（如 `goalType` -> `type`）会导致现有测试或未合并代码失效。需同步更新 DTO。

---

## 5.3 技术落地计划

### 1. 文件创建/修改清单

#### 后端文件
- [x] `fit_cycle_app/src/database/entity/diet-plan.entity.ts`: 修改
  - 类名: `DietPlan`
  - 变更: 增加 `type` (Enum), `status` (Enum), `isTemplate`, `cycleDays`, `cycleCount`, `carbCycleConfig` (JSON)。
- [x] `fit_cycle_app/src/database/entity/plan-day.entity.ts`: 修改
  - 类名: `PlanDay`
  - 变更: 移除 `date` (由计划激活时动态生成)，强化 `dayIndex`。
- [x] `fit_cycle_app/src/database/entity/plan-meal.entity.ts`: 修改
  - 类名: `PlanMeal`
  - 变更: 确保 `mealType` 字段存在。

### 2. 核心实体定义预览

```typescript
// DietPlan 核心字段对齐
export enum PlanType {
  FAT_LOSS = 'fat-loss',
  MUSCLE_GAIN = 'muscle-gain',
  MAINTENANCE = 'maintenance',
  CUSTOM = 'custom',
  CARB_CYCLE = 'carb-cycle'
}

export enum PlanStatus {
  ACTIVE = 'active',
  PAUSED = 'paused',
  COMPLETED = 'completed',
  ARCHIVED = 'archived'
}

// 关联结构
// DietPlan (1) -> (*) PlanDay (1) -> (*) PlanMeal (1) -> (*) PlanMealItem
```

### 3. 数据流向

```
[前端创建向导] → [CreatePlanDto] → [PlanService.create] → [MySQL (diet_plans, plan_days...)]
```

### 4. 依赖任务检查

- [x] 依赖任务 `U-9` (User 实体) 已完成
- [x] 依赖任务 `F-4` (Food 实体) 已完成

---

## 5.4 风险点清单

### 技术风险
- [ ] **JSON 字段兼容性**
  - 影响: `carb_cycle_config` 的存储在不同 MySQL 版本可能存在差异。
  - 应对措施: 使用 TypeORM 的 `json` 类型，并在 Service 层做好结构验证。

### 业务风险
- [ ] **单一激活原则**
  - 影响: 用户可能同时激活多个计划，导致逻辑混乱。
  - 应对措施: 在 `P-4` 任务中实现严格的排他逻辑，本任务仅负责提供 `status` 字段。

---

## 5.5 预期交付物

### 代码交付物
- [x] `diet-plan.entity.ts`: 更新后的计划实体
- [x] `plan-day.entity.ts`: 更新后的天数配置实体
- [x] `plan-meal.entity.ts`: 计划餐次实体
- [x] `plan-meal-item.entity.ts`: 计划餐次食材实体

### 文档交付物
- [x] T6_变更清单.md

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 所有影响范围已评估
- [x] 技术方案可行且清晰
- [x] 所有风险点已列出
- [x] 依赖任务已确认
- [x] UI 结构已分析（前端任务）
- [x] 数据流向已明确

---

## 5.7 下一步行动

1. **立即执行**: 按照分析文档开始 T6 编码，修改后端实体类。
2. **需要澄清**: 规约中 `plan_templates` 使用 JSON 存储 `meals_config`，但现有代码使用 `PlanMeal` 表。**决策**: 维持现有表结构（分表存储），因为后期“按计划记录”功能需要更精细的关联查询，分表比解析 JSON 性能更好且更易维护。

---

## 附录：参考资料

### 相关文档
- `docs/pj_docs/04_接口与数据规约.md`
- `docs/pj_docs/02_需求原子化拆分.md`

**分析完成时间**: 2026-02-02 20:45  
**预计开始编码时间**: 2026-02-02 20:50  
**预计完成时间**: 2026-02-02 22:30
