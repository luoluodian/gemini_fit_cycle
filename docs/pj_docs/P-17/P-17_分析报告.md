# P-17 创建向导 Step 1.5 - 常规目标初始化 (批量设置) 分析报告

## 1. 业务目标 (Business Goal)
在常规计划流程中，为用户提供一键初始化周期内所有天数（日模板）营养目标的能力。该功能对应 `plan-templates.html` 中的“自动填充”操作，旨在解决常规计划中每天目标一致时的重复录入痛点。

## 2. 原型细节分析 (Detailed Analysis)
参考 `html/plan-templates.html` (参数: `type=normal`, `cycleDays=7`, `cycleCount=3`)：

- **触发入口**: 位于“日模板列表”上方的“自动填充”文字按钮。
- **配置摘要展示**:
  - **计划名称**: 展示用户在 Step 1 输入的名称（如 "1"）。
  - **周期信息**: 明确展示 `7天 × 3周期 = 21天`。
  - **配置进度**: 初始为 `0 / 7`。批量设置后应变为 `7 / 7`。
- **模板卡片变化**:
  - 初始状态：显示“未配置”。
  - 批量设置后：应展示具体的营养素快照（热量、蛋、脂、碳），样式需与 `edit-template.html` 中的汇总展示一致。
- **业务逻辑**: 
  - 弹窗录入一套标准值（Calories, P, F, C）。
  - 遍历当前周期的所有模板草稿，进行覆盖式填充。
  - 标记所有模板为 `isConfigured = true`。

## 2.4 操作项细节 (Card Actions Detail)
参考 `plan-templates.html` 中的模板卡片（Template Card），每个项目需包含以下操作：

- **复制按钮 (Copy)**: 
  - **位置**: 位于卡片右侧操作区第一个图标。
  - **功能**: 克隆当前日期的配置到一个新日期，并自动增加 `cycleDays`。
  - **反馈**: 成功后列表末尾新增一项，提示“已复制为 Day X”。
- **删除按钮 (Delete)**: 
  - **位置**: 位于卡片右侧操作区第二个图标（红色）。
  - **功能**: 移除当前日模板，并同步减少 `cycleDays`。
  - **反馈**: 需弹出二次确认，防止误删。

## 2.5 新增日模板逻辑 (Add Day Detail)
参考 `plan-templates.html` 中的底部新增按钮：

- **展示形式**: 列表末尾的宽体虚线边框按钮。
- **动态文案**: 显示当前数量与预设周期天数的比例，例如 `+ 新增日模板 (0/7)`。
- **点击行为**:
  - 在 `draft.templates` 数组末尾推入一个新的初始化对象。
  - **关键细节**：同步递增 `draft.cycleDays`。
  - **导航**：新增后通常自动跳转至该日期的“日模板编辑”页（P-9）。
- **约束**: 
  - 允许超出初始设置的周期天数（即通过新增天数来动态延长周期）。

## 3. 技术方案细化 (Technical Solution)

### 3.1 UI 交互
- 延用之前实现的 `BatchSetupModal.vue`。
- **卡片组件更新**: 在 `TemplateManagementStep.vue` 的循环项中增加“复制”与“删除”按钮的还原。
- **新增按钮还原**: 实现底部的 `dashed border` 按钮，文案需绑定 `templates.length` 和 `cycleDays`。

### 3.2 数据流转与状态影响
- **Store (`planStore`)**: 
  - `draft.templates`: 存储每个 Day 的具体目标。
  - `batchUpdateTargets`: 批量覆盖。
  - `addTemplate()`: 推入新对象，更新 `cycleDays++`。
  - `copyTemplate(index)`: 执行列表切片操作，生成新对象并推入，更新 `cycleDays++`。
  - `deleteTemplate(index)`: 执行 `splice` 操作，更新 `cycleDays--`。
- **参数同步**: 任何改变列表长度的操作必须强制同步 `draft.cycleDays`，因为后端接口依赖此数值确定计划总长度。

## 4. 验收标准 (Acceptance Criteria)
- [ ] 底部显示 `+ 新增日模板 (X/Y)` 按钮。
- [ ] 点击新增按钮，列表项数加 1，顶部“周期信息”摘要同步变为 `(Y+1)天 × Z周期`。
- [ ] 点击“复制”图标，行为同上（复制现有数据）。
- [ ] 点击“删除”图标并确认，行消失，`cycleDays` 自动减 1。
- [ ] 当列表只有 1 项时，应禁用或隐藏删除按钮。
- [ ] 仅当 `type=normal` 时，操作按钮区不应被碳循环的色条遮挡。
