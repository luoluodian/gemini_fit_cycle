# S-2: 全局拦截器 - T5 分析文档

> **任务 ID**: S-2
> **任务名称**: 全局拦截器
> **优先级**: P0
> **垂直拆分**: 后端 API / 公共逻辑
> **预估工时**: 1h
> **复杂度**: 低
> **分析时间**: 2026-01-31
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [ ] 无

### 涉及公共组件
- [x] `TransformInterceptor` (`fit_cycle_app/src/common/interceptors/transform.interceptor.ts`): 用于统一响应格式。
- [x] `HttpExceptionFilter` (`fit_cycle_app/src/common/filters/http-exception.filter.ts`): 用于统一异常处理。
- [x] `RequestLoggerInterceptor` (`fit_cycle_app/src/common/interceptors/transform.interceptor.ts`): 请求日志记录。
- [x] `TrimInterceptor` (`fit_cycle_app/src/common/interceptors/trim.interceptor.ts`): 输入参数去空格。

### 涉及跨模块 Service
- [x] `WINSTON_MODULE_NEST_PROVIDER` (Logging): 拦截器和过滤器都深度依赖日志模块。

### 所有关联模块
- `AppModule` (Global Scope): 拦截器在 `main.ts` 中被注册为全局。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/common/interceptors/transform.interceptor.ts`: 需完善类型定义，确保响应结构 `{ code, data, message }` 与 `04_接口与数据规约.md` 严格一致。目前逻辑基本符合，但需确认 `code` 在业务错误时的表现。
- [x] `fit_cycle_app/src/common/filters/http-exception.filter.ts`: 目前已实现基础异常捕获，需确认是否覆盖了所有 NestJS 内置异常及自定义业务异常，并统一返回 200 HTTP 状态码 + 错误 Code（还是遵循 RESTful 状态码？根据规约，通常微服务/小程序倾向于统一 200，但需检查规约细节）。
- [x] `fit_cycle_app/src/main.ts`: 确认全局注册顺序正确。

### 对现有功能的影响
- **有影响**: 修改拦截器会影响所有 API 的响应格式。如果有前端已经对接了旧格式，可能会通过 `code` 或 `data` 字段的细微变化导致解析失败。但目前项目处于重构初期，影响可控。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: "2. API 接口契约" 章节明确规定了 `Resp: { code: 200, data: any, message: string }`。

### 潜在的破坏性变更
- **无破坏性变更**: 现有逻辑已经实现了 `{ code, message, data }` 的包装，本次任务主要是代码审计和规范化，而非重写。

---

## 5.3 技术落地计划

### 1. 文件创建清单
本次任务主要是**修改**和**验证**，无新文件创建需求。

### 2. 代码审计与修正点

#### 后端方法 (`TransformInterceptor`)
- **现状**:
  ```typescript
  return {
    code: 200,
    message: 'success',
    data,
  };
  ```
- **修正目标**: 保持现状，确保 `code: 200` 是硬编码的成功状态。确认当 Controller 返回 `null` 时 `data` 字段的表现。

#### 后端方法 (`HttpExceptionFilter`)
- **现状**:
  ```typescript
  return response.status(status).json({
    code: status,
    message,
    data: null,
  });
  ```
- **修正目标**:
  - 规约要求统一响应结构。当前的实现 `code: status` (e.g. 404, 500) 符合一般惯例。
  - **关键点**: 确认是否需要将 HTTP Status Code 统一改为 200 (Soft Error)，还是保持 RESTful (Hard Error)。
  - **决策**: 依据 `04_接口与数据规约` (虽然未明确写明 HTTP 状态码，但通常小程序端处理 200 OK + 业务错误码更方便，不过 NestJS 默认 `status(status)` 会设置 HTTP Header)。
  - **建议**: 保持 HTTP Status Code 与 `code` 一致（即 4xx/5xx），方便网关层监控。前端 `request` 库已做适配。

### 3. 数据流向
```
Request -> [TrimInterceptor] -> [RequestLoggerInterceptor] -> Controller -> Service
                                                                    |
Response <- [TransformInterceptor] (Success Wrap) <-----------------+
OR
Exception <- [HttpExceptionFilter] (Error Wrap) <-------------------+
```

### 5. 依赖任务检查
- [x] 无

---

## 5.4 风险点清单

### 技术风险
- [x] **日志脱敏**: `RequestLoggerInterceptor` 中虽然有 `mask` 函数，但需检查是否覆盖了所有敏感字段（如 `password`, `token`, `refresh_token`）。
- [x] **双重包装**: 确保 `TransformInterceptor` 不会对已经是标准格式的响应再次包装（代码中已有 `if ('code' in data)` 的检查，需验证其鲁棒性）。

---

## 5.5 预期交付物

### 代码交付物
- 修正后的 `transform.interceptor.ts` (如有必要)
- 修正后的 `http-exception.filter.ts` (如有必要)

### 文档交付物
- `docs/pj_docs/S-2/S-2_分析文档.md`

---

## 5.6 自检清单

- [x] 所有关联模块已识别 (Logger, Main)
- [x] 所有影响范围已评估 (Global API)
- [x] 技术方案可行且清晰
- [x] 数据流向已明确

---

## 5.7 下一步行动

1. **立即执行**:
   - 检查 `transform.interceptor.ts` 中的 `mask` 字段列表。
   - 验证 `HttpExceptionFilter` 的异常处理逻辑。
   - 运行现有的 E2E 测试 (`npm run test:e2e`) 验证拦截器行为。
2. **需要澄清**: 规约中未明确 HTTP 状态码策略，默认沿用 RESTful 风格。
