# U-8: 健康工具 UI - T5 分析文档

> **任务 ID**: U-8  
> **任务名称**: 健康工具 UI  
> **优先级**: P1  
> **垂直拆分**: 前端 Component / Logic  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共组件
- [x] `BMRCalculatorModal.vue`: 已在 `fit_cycle_web/src/components/profile/` 中存在初步实现。
- [x] `HealthTools.vue`: 入口组件。

### 涉及跨模块 Service
- `UserService` (`fit_cycle_web/src/services/modules/user.ts`): 需要确保 `updateUserInfo` 方法能被正确调用，以保存计算结果。
- `UserStore` (`fit_cycle_web/src/stores/user.ts`): 需要确保 `healthProfile` 状态能被及时更新。

### 交互逻辑分析
- **入口**: 个人中心 -> 健康工具 -> BMR/TDEE 计算器。
- **输入**: 性别、年龄、身高、体重、活动系数。
- **输出**: 计算 BMR 和 TDEE，并显示减脂/维持/增肌的目标建议。
- **持久化**: 点击“计算”后，除了展示结果，是否应该**自动保存**到用户档案？
  - **决策**: 是。为了用户体验，计算即意味着更新身体数据，应调用后端 API 保存。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_web/src/components/profile/BMRCalculatorModal.vue`:
  - 现状: 纯前端计算，未调用 API。
  - 修改: 增加调用 `userStore.updateUserInfo` 的逻辑，将计算用的身高/体重同步保存到后端。
- [x] `fit_cycle_web/src/stores/user.ts`:
  - 现状: 已有 `fetchUserProfile`。
  - 修改: 确保 `updateUserInfo` action 能够正确处理并回写 state。

### 对现有功能的影响
- [x] **增强**: 将单纯的计算器升级为“身体数据更新入口”。

---

## 5.3 技术落地计划

### 1. 逻辑流转设计

1.  **打开模态框**: 从 Store 回显当前的 `healthProfile` 数据（如有）。
2.  **用户输入**: 修改身高、体重等。
3.  **点击计算**:
    -   前端先执行计算（用于即时反馈）。
    -   **异步**调用 `userStore.updateUserInfo(payload)`。
    -   API 返回更新后的 Profile（含后端重算的 BMR/TDEE）。
    -   更新 Store，确保数据一致性。

### 2. 代码实现方案

在 `BMRCalculatorModal.vue` 中：

```typescript
// 引入 Store
const userStore = useUserStore();

// 初始化回显
watch(() => props.visible, (val) => {
  if (val && userStore.healthProfile) {
    height.value = userStore.healthProfile.height;
    weight.value = userStore.healthProfile.weight;
    // ... 其他字段回显
  }
});

// 计算并保存
const handleCalculate = async () => {
  // 1. 前端计算展示结果 (保持现有逻辑不变，作为 Optimistic UI)
  
  // 2. 调用 API 保存
  try {
    await userStore.updateUserInfo({
      heightCm: Number(height.value),
      weightKg: Number(weight.value),
      // ...
    });
    showSuccess('身体数据已更新');
  } catch (e) {
    console.error(e);
  }
}
```

### 3. 依赖任务检查

- [x] 依赖任务 `U-7` (后端接口) 已完成。

---

## 5.4 风险点清单

- [ ] **数据同步冲突**: 前端计算公式与后端公式若有微差（如取整方式），可能导致 UI 先显示一个值，接口返回后跳变为另一个值。
  - **应对**: 接受微小差异，以接口返回值为最终真理（Source of Truth）。在 API 成功返回后，用后端数据刷新显示。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_web/src/components/profile/BMRCalculatorModal.vue` (逻辑增强)
- `fit_cycle_web/src/stores/user.ts` (功能增强)

### 文档交付物
- T6~T9 全套文档。

---

## 5.6 自检清单

- [x] 确认了前后端交互点。
- [x] 确认了数据回显逻辑。
- [x] 确认了状态管理方案。

---

## 5.7 下一步行动

1. **立即执行**: 进入 T6 编码阶段，修改前端代码以对接后端 API。
