# T6 变更清单: I-4.1 打卡保存闭环 (Sync Hook)

## 1. Store 层功能增强 (Store Enhancements)

### 1.1 更新 `useRecordStore` (`stores/record.ts`)
- **新增方法 `addMealLogAction(data: CreateMealLogDto)`**:
    - **逻辑**: 
        1. 调用 `services/record.ts` 的 `addMealLog`。
        2. 成功后判断:
            - 若 `this.currentRecord.id` 已存在: 直接将返回的实体 `push` 到 `mealLogs` (实现零延迟反馈)。
            - 若 `this.currentRecord.id` 为空 (首笔记录): 调用 `this.fetchRecord(data.date, { silent: true })`。
- **优化 `fetchRecord`**:
    - 增加参数 `{ silent?: boolean }`。
    - 若 `silent` 为 true，不重置 `isLoading` 状态，防止首页骨架屏闪烁。

## 2. 首页集成重构 (Index Page Integration)

### 2.1 完善 `pages/index/index.vue`
- **引入状态**: 增加 `const isSubmitting = ref(false)` 提交锁。
- **重构 `handleFoodPicked`**:
    - 实现 `try...finally` 结构。
    - **数据转换**: 确保 `quantity` 传递的是基于 100g/ml 基准的标量。
    - **调用链**: `await recordStore.addMealLogAction({ ... })`。
    - **弹窗控制**: 仅在 `finally` 之前（即成功后）执行 `foodPickerVisible.value = false`。

### 2.2 上下文加固
- 确保 `handleAddFood` 在打开 Picker 瞬间，`currentMealType.value` 已被准确赋值。

## 3. API 契约微调
- **同步 `services/modules/record.ts`**:
    - 确保 `addMealLog` 接收参数完全匹配后端 `CreateMealLogDto`。

## 4. 验证计划 (Verification)
- **首笔记录闭环**:
    - [ ] 验证当日首笔记录添加后，进度环目标热量从 0 (或默认) 变为计算后的准确值，且无白屏闪烁。
- **连续打卡压力**:
    - [ ] 快速点击确认 3 次，验证是否由于提交锁存在，数据库中仅产生 1 条记录且 Loading 状态正常。
- **异常恢复**:
    - [ ] 模拟后端 500，验证 `FoodPicker` 是否保持开启，且用户输入的重量数据未丢失。

## 5. 结论
I-4.1 不仅是接口的连通，更是“状态自愈”逻辑的落地。通过“静默加载”和“局部合并”策略，我们将为用户提供顺滑、不中断的打卡流。
