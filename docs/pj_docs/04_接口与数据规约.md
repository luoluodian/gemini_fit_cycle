# 04_接口与数据规约

## 1. 数据库设计 (Database Schema)

> **规范**: 所有表名使用 `snake_case`，主键为 `id` (Auto Increment BigInt)，包含 `created_at`, `updated_at`, `deleted_at`。

### 1.1 用户域
**`users`**
- `id`: PK
- `openid`: Varchar(64), Unique, Not Null
- `nickname`: Varchar(64)
- `avatar_url`: Varchar(255)

**`health_profiles`**
- `id`: PK
- `user_id`: FK -> users.id
- `gender`: Enum('male', 'female')
- `height`: Float (cm)
- `weight`: Float (kg)
- `birthday`: Date
- `activity_level`: Float (1.2 ~ 1.9)
- `bmr`: Int
- `tdee`: Int

**`user_weight_logs`**
- `id`: PK
- `user_id`: FK -> users.id
- `weight`: Float (kg)
- `date`: Date
- `created_at`: Timestamp

### 1.2 计划域
**`diet_plans`**
- `id`: PK
- `user_id`: FK -> users.id (Nullable if is_template=true)
- `name`: Varchar(100)
- `description`: Text (Optional, for templates)
- `type`: Enum('fat-loss', 'muscle-gain', 'maintenance', 'custom', 'carb-cycle')
- `status`: Enum('active', 'paused', 'completed', 'archived')
- `is_template`: Boolean (Default false)
- `cycle_days`: Int (e.g. 7)
- `cycle_count`: Int (e.g. 3)
- `start_date`: Date
- `carb_cycle_config`: JSON (存储高/中/低碳参数)

**`plan_templates`**
- `id`: PK
- `plan_id`: FK -> diet_plans.id
- `day_number`: Int (1 ~ cycle_days)
- `target_calories`: Int
- `target_macros`: JSON ({p, f, c})
- `meals_config`: JSON (预设餐单结构)

### 1.3 食材域
**`food_items`**
- `id`: PK
- `name`: Varchar(100), Index
- `type`: Enum('system', 'custom')
- `user_id`: FK -> users.id (Nullable, system foods are null)
- `category`: Enum('protein', 'vegetables', 'fruits', 'grains', 'dairy', 'nuts', 'oils', 'snacks', 'custom')
- `description`: Varchar(255) (Optional)
- `image_url`: Varchar(255) (Stores emoji char or image URL)
- `is_public`: Boolean (Default false, for user-submitted public foods)
- `calories`: Int (per 100g)
- `protein`: Float
- `fat`: Float
- `carbs`: Float
- `unit`: Varchar(20) (e.g. 'g', 'ml')
- `tags`: JSON (['high_protein', ...])

**`user_favorite_foods`**
- `id`: PK
- `user_id`: FK -> users.id
- `food_id`: FK -> food_items.id
- `created_at`: Timestamp

### 1.4 记录域
**`daily_records`**
- `id`: PK
- `user_id`: FK -> users.id
- `date`: Date, Index
- `target_snapshot`: JSON (当天的目标快照)
- `plan_id`: FK -> diet_plans.id (Nullable)

**`meal_logs`**
- `id`: PK
- `record_id`: FK -> daily_records.id
- `meal_type`: Enum('breakfast', 'lunch', 'dinner', 'snacks')
- `food_id`: FK -> food_items.id
- `food_name`: Varchar(100) (快照)
- `quantity`: Float
- `unit`: Varchar(20)
- `calories`: Int (Calculated)
- `macros`: JSON (Calculated {p, f, c})

---

## 2. API 接口契约 (API Contract)

> **规范**: 响应体结构 `{ code: 200, data: any, message: string }`

### 2.1 认证 (Auth)
*   **POST /auth/login**
    *   Body: `{ code: string }`
    *   Resp: `{ token: string, user: UserProfile }`

### 2.2 用户 (User)
*   **GET /user/profile**
    *   Resp: `{ user: User, health: HealthProfile, stats: { totalDays: number, completedPlans: number } }`
*   **PUT /user/health-profile**
    *   Body: `{ height, weight, ... }`
    *   Resp: `{ bmr, tdee }` (自动重算返回)
*   **POST /user/weight**
    *   Body: `{ weight, date }`
    *   Resp: `Success`
*   **GET /user/weight/history**
    *   Query: `startDate`, `endDate`
    *   Resp: `{ logs: WeightLog[] }`

### 2.3 食材 (Food)
*   **GET /food/search**
    *   Query: `keyword`, `category`, `type` ('system'|'custom'), `page`
    *   Resp: `{ items: FoodItem[], total: number }`
*   **GET /food/popular**
    *   Desc: 获取热门/常用食材
    *   Resp: `{ items: FoodItem[] }`
*   **POST /food/custom**
    *   Body: `{ name, calories, macros, ... }`
    *   Resp: `{ id }`
*   **POST /food/:id/favorite**
    *   Desc: 收藏食材
    *   Resp: `Success`
*   **DELETE /food/:id/favorite**
    *   Desc: 取消收藏
    *   Resp: `Success`

### 2.4 计划 (Plan)
*   **GET /plans**
    *   Query: `status`
    *   Resp: `DietPlan[]`
*   **GET /plans/recommended**
    *   Desc: 获取系统推荐计划模板
    *   Resp: `DietPlan[]` (where is_template=true)
*   **POST /plans**
    *   Body: `CreatePlanDto`
    *   Resp: `{ id }`
*   **POST /plans/:id/share**
    *   Desc: 生成计划分享码
    *   Resp: `{ shareCode: string, expireAt: Date }`
*   **GET /plans/shared/:code**
    *   Desc: 解析分享码获取计划预览
    *   Resp: `DietPlan` (readonly preview)
*   **POST /plans/import**
    *   Body: `{ shareCode: string }`
    *   Desc: 根据分享码导入计划为自己的计划
    *   Resp: `{ id }` (new plan id)
*   **POST /plans/:id/templates**
    *   Body: `{ templates: TemplateDto[] }`
    *   Desc: 批量保存日模板

### 2.5 记录 (Record)
*   **GET /records/:date**
    *   Params: `date` (YYYY-MM-DD)
    *   Resp: `{ record: DailyRecord, meals: MealLog[] }`
*   **POST /records/meal**
    *   Body: `{ date, mealType, foodId, quantity }`
    *   Resp: `MealLog` (含计算后的热量)
*   **DELETE /records/meal/:id**
    *   Resp: `Success`

### 2.6 统计 (Analysis)
*   **GET /analysis/weekly**
    *   Desc: 获取本周摄入趋势
    *   Resp: `{ dates: string[], targets: number[], actuals: number[] }`

---

## 3. 枚举值定义

**MealType**
- `breakfast`: 早餐
- `lunch`: 午餐
- `dinner`: 晚餐
- `snacks`: 加餐

**FoodCategory**
- `protein`: 蛋白质
- `vegetables`: 蔬菜
- `fruits`: 水果
- `grains`: 谷物
- `dairy`: 乳制品
- `nuts`: 坚果
- `oils`: 油脂
- `snacks`: 零食/其他
- `custom`: 自定义

**PlanStatus**
- `active`: 进行中 (全局唯一)
- `paused`: 已暂停
- `completed`: 已完成
- `archived`: 已归档
