# F-10: 热门食材接口 - T5 分析文档

> **任务 ID**: F-10  
> **任务名称**: 热门食材接口  
> **优先级**: P1  
> **垂直拆分**: 后端 API  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `food_items`: 食材基础数据。
- [x] `user_favorite_foods`: 收藏统计来源。

### 涉及跨模块 Service
- `FoodItemsService`: 实现聚合查询逻辑。

### 逻辑分析
- **定义**: “热门食材”通常指收藏人数最多的食材。
- **降级策略**: 如果系统尚无收藏数据，则返回最新的系统预设食材 (`type: 'system'`) 作为填充。
- **返回字段**: 需包含 `FoodItem` 实体所有字段，且支持当前用户的 `isFavorite` 状态标记。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/modules/food-items/food-items.service.ts`: 新增 `getPopular` 方法。
- [x] `fit_cycle_app/src/modules/food-items/food-items.controller.ts`: 暴露 `GET /food-items/popular` 接口。

### 对现有功能的影响
- [x] **无影响**: 仅新增只读接口。

---

## 5.3 技术落地计划

### 1. 聚合查询设计

使用 QueryBuilder 进行关联统计：
```sql
SELECT food.*, COUNT(fav.id) as favorite_count
FROM food_items food
LEFT JOIN user_favorite_foods fav ON fav.food_id = food.id
GROUP BY food.id
ORDER BY favorite_count DESC, food.id DESC
LIMIT 10
```

### 2. 状态增强 (isFavorite)
与 `list` 接口类似，在返回给特定用户时，需要二次标记 `isFavorite` 字段。

### 3. 数据流向
```
Frontend -> GET /food-items/popular -> Controller -> Service -> SQL (Group By + Count) -> Response
```

### 4. 依赖任务检查
- [x] 依赖任务 `F-9` (收藏功能) 已完成。

---

## 5.4 风险点清单

- [ ] **性能**: `GROUP BY` 在大数据量下可能较慢。
  - 应对措施: 暂时限制返回 10-20 条。后续可考虑 Redis 缓存。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/modules/food-items/food-items.service.ts` (新增 getPopular)
- `fit_cycle_app/src/modules/food-items/food-items.controller.ts` (新增接口)

### 文档交付物
- T6~T9 全套文档。

---

## 5.6 自检清单
- [x] 排序逻辑符合“热门”定义
- [x] 返回结构对齐 `FoodItem` 实体
- [x] 支持 `isFavorite` 状态回显

---

## 5.7 下一步行动
1. **立即执行**: 进入 T6 编码阶段。
