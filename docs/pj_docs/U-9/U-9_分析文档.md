# U-9: User 实体定义 - T5 分析文档

> **任务 ID**: U-9  
> **任务名称**: User 实体定义  
> **优先级**: P0  
> **垂直拆分**: 后端 DB  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `users` (`fit_cycle_app/src/database/entity/user.entity.ts`): 核心用户信息表。
- [x] `health_profiles` (`fit_cycle_app/src/database/entity/health-profile.entity.ts`): 用户健康档案表，与 `users` 是一对一关系。

### 涉及公共组件
- 无 (后端 DB 任务)

### 涉及跨模块 Service
- `UserService`: 负责实体的 CRUD 操作。

### 所有关联模块
- `Auth`: 登录时需要查询/创建 User。
- `User`: 提供个人资料接口。
- `DietPlan`: 计划需要关联 User。
- `DietLog`: 记录需要关联 User。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/database/entity/user.entity.ts`: 验证字段是否符合 `04_接口与数据规约.md`。
- [x] `fit_cycle_app/src/database/entity/health-profile.entity.ts`: 验证字段及 BMR/TDEE 相关定义。

### 对现有功能的影响
- [x] **无影响**: 实体已存在，本次任务主要是进行合规性检查与基准化文档。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 数据库设计标准。

### 潜在的破坏性变更
- [x] **无破坏性变更**

---

## 5.3 技术落地计划

### 1. 文件确认清单

#### 后端文件
- [x] `fit_cycle_app/src/database/entity/user.entity.ts`:
  - 类名: `User`
  - 核心字段: `id`, `openId`, `nickname`, `avatarUrl`, `healthProfile` (OneToOne)。
- [x] `fit_cycle_app/src/database/entity/health-profile.entity.ts`:
  - 类名: `HealthProfile`
  - 核心字段: `userId`, `gender`, `height`, `weight`, `birthday`, `activityLevel`, `bmr`, `tdee`。

### 2. 审计重点

1.  **命名规范**: 确认表名是否为 `users` 和 `health_profiles` (snake_case)。
2.  **字段类型**: 
    - `openId` 应为 `unique`。
    - `height`, `weight`, `activityLevel` 应使用 `decimal` 以保证精度。
    - `bmr`, `tdee` 应为 `int`。
3.  **关联关系**: 
    - `User` 与 `HealthProfile` 的 `OneToOne` 关系及 `cascade: true`。
    - `onDelete: 'CASCADE'` 配置以保证数据一致性。

### 3. 数据流向

```
TypeORM Entity -> MySQL Table
```

### 4. 依赖任务检查

- [x] 依赖任务 `S-1` (数据库初始化) 已完成。

---

## 5.4 风险点清单

### 技术风险
- [ ] **字段精度**: 确认 `decimal` 类型的精度设置是否满足业务需求 (如身高 250.00cm)。
  - 应对措施: 使用 `precision: 5, scale: 2`。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/database/entity/user.entity.ts` (确认/微调)
- `fit_cycle_app/src/database/entity/health-profile.entity.ts` (确认/微调)

### 文档交付物
- T6_变更清单.md
- T7_测试报告.md
- T8_审计报告.md
- T8.5_审查意见.md
- T9_交付报告.md

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 所有影响范围已评估
- [x] 技术方案可行且清晰
- [x] UI 结构已分析 (不适用)
- [x] 数据流向已明确

---

## 5.7 下一步行动

1. **立即执行**: 进入 T6 编码阶段，执行实体合规性确认。

---

## 附录：参考资料

### 相关文档
- `docs/pj_docs/04_接口与数据规约.md`: 数据库设计标准。
