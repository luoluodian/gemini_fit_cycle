# P-14: 计划分享与导入 - T5 分析文档

> **任务 ID**: P-14  
> **任务名称**: 计划分享与导入  
> **优先级**: P2  
> **垂直拆分**: 前端 UI + 后端 API  
> **复杂度**: 中  
> **分析时间**: 2026-02-04 20:00  
> **分析人**: AI Assistant

---

## 1. 业务目标
通过“分享码”机制，允许用户将自己精心设计的饮食计划分享给好友，促进社区传播。好友输入分享码后，系统会自动将该计划复制一份到好友的计划列表中。

## 2. 场景分析 (Scenarios)
- **场景 A (分享者)**: 用户觉得自己的“7天减脂计划”效果很好，点击“分享”，生成一个类似 `PLAN-X8Y9Z` 的 6 位随机码，并复制到剪贴板。
- **场景 B (接收者)**: 好友打开小程序，点击“导入计划”，输入 `PLAN-X8Y9Z`，系统预览计划概况（名称、天数、类型），确认后保存。

## 3. 核心机制设计

### 3.1 分享码生成规则
- **格式**: `PLAN-` + 6 位大写字母/数字。
- **存储**: 在数据库中建立 `plan_shares` 表，关联 `original_plan_id` 和生成的 `code`。
- **有效期**: 默认 7 天或永久（视业务复杂度定，MVP 建议设为 30 天）。

### 3.2 导入逻辑 (Deep Clone)
- **快照复制**: 导入时，不是引用原计划，而是**深拷贝**一份全新的数据。
- **数据清洗**: 移除原计划的 `created_by`、`status`（重置为 draft/inactive）、`start_date` 等私有字段。
- **食材兼容**: 如果计划中包含“自定义食材”，目前 MVP 阶段建议仅保留食材名称和营养素数据，转为纯文本描述，或者将自定义食材也一并复制到接收者的库中（复杂度较高，建议方案一：仅复制快照数据）。

---

## 4. 接口契约 (API Contract)

### 4.1 生成分享码
- **POST** `/diet-plans/:id/share`
- **Response**: `{ code: "PLAN-A1B2C3", expireAt: "2026-03-01..." }`

### 4.2 解析分享码 (预览)
- **GET** `/diet-plans/share/:code`
- **Response**: `{ name: "7天减脂", type: "carb-cycle", cycleDays: 7, authorName: "Gemini", ... }`

### 4.3 确认导入
- **POST** `/diet-plans/import`
- **Body**: `{ code: "PLAN-A1B2C3" }`
- **Response**: `{ id: newPlanId }`

---

## 5. 技术落地计划

### 1. 数据库变更
- 新增实体 `PlanShare`:
  - `code` (Unique Index)
  - `plan_id` (ManyToOne)
  - `user_id` (创建者)
  - `expire_at`

### 2. 后端逻辑 (`DietPlansService`)
- `sharePlan(planId)`: 生成唯一码，写入 `PlanShare` 表。
- `importPlan(code)`: 
  1. 查找分享记录。
  2. 读取原计划详情（包含 `planDays`, `planMeals`）。
  3. 执行 `deepCopy`，剔除 ID 和用户关联。
  4. 保存为当前用户的新计划。

### 3. 前端交互
- **分享入口**: `plan-detail` 右上角菜单 -> “分享计划” -> 弹窗显示码 + 复制按钮。
- **导入入口**: `plan/index` 列表页 -> “创建/导入”悬浮按钮 -> “输入分享码”弹窗。

---

## 6. 风险点清单
- **数据一致性**: 原计划删除后，分享码是否失效？
  - *策略*: 失效。或者在生成分享时就物理复制一份“快照”供分享使用（推荐快照模式，防止原作者修改计划影响已分享的内容）。
- **权限控制**: 只能导入公开的或持有码的计划。

---

**分析完成时间**: 2026-02-04 20:15  
**预计开始编码时间**: 2026-02-04 20:20  
**预计完成时间**: 2026-02-04 21:30
