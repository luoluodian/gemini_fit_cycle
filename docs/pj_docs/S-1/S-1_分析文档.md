# S-1: 数据库初始化 - T5 分析文档

> **任务 ID**: S-1
> **任务名称**: 数据库初始化
> **优先级**: P0
> **垂直拆分**: DB
> **预估工时**: 2h
> **复杂度**: 中
> **分析时间**: 2026-01-31
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] 所有表: `users`, `health_profiles`, `user_weight_logs`, `diet_plans`, `plan_templates`, `food_items`, `user_favorite_foods`, `daily_records`, `meal_logs`。
- [x] `data_dictionary` (虽然规约中未显式定义表结构，但作为基础架构存在于 `initial-schema.sql` 中，且规约定义了多个 Enum，需初始化数据)。

### 涉及公共组件
- [ ] 无

### 涉及跨模块 Service
- [ ] 无

### 所有关联模块
- `Auth`, `User`, `Food`, `Plan`, `Record`, `Analysis` (数据库作为底层支撑)

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/database/migrations/initial-schema.sql`: 需要完全重写以匹配 `04_接口与数据规约.md`。
- [x] `fit_cycle_app/src/database/migrations/seed-dict.sql` (新建): 用于插入字典数据。

### 对现有功能的影响
- **有影响**: 现有的 Entity 定义 (`src/database/entity/*.ts`) 与新的数据库 Schema 将产生严重不一致（例如表名变更 `plans` -> `diet_plans`, `foods` -> `food_items`）。
- **策略**: 本任务仅负责 DB 层面的 SQL 文件更新和执行。Entity 层的修正将在后续各模块的具体开发任务（S-2, S-3, F-1 等）中逐一解决。目前仅确保 SQL 文件符合“唯一真理”文档。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 核心参考，Schema 定义源。

### 潜在的破坏性变更
- **有破坏性变更**: 数据库结构发生根本性变化。若有存量数据需迁移（当前为初始化阶段，可忽略）。

---

## 5.3 技术落地计划

### 1. 文件创建/修改清单

#### 数据库迁移脚本
- [x] `fit_cycle_app/src/database/migrations/01_initial_schema.sql`: 
  - 重命名并重写原 `initial-schema.sql`。
  - 实现 `04_接口与数据规约.md` 中定义的 9 张表。
  - 添加 `data_dictionary` 表结构支持动态配置。
- [x] `fit_cycle_app/src/database/migrations/02_seed_dictionary.sql`:
  - 插入 `MealType` (breakfast, lunch, dinner, snacks)。
  - 插入 `FoodCategory` (protein, vegetables, ...)。
  - 插入 `PlanStatus` (active, paused, completed, archived)。
  - 插入 `Gender` (male, female)。

### 2. 表结构映射确认 (Doc vs Implementation)

| 规约表名 | 原 SQL 表名 | 变更操作 | 关键字段差异 |
| :--- | :--- | :--- | :--- |
| `users` | `users` | 修改 | 移除 profile 字段，保留 `openid`, `nickname`, `avatar_url` |
| `health_profiles` | (混在 users) | **新增** | 独立存储身高、体重、BMR 等 |
| `user_weight_logs` | `weight_records` | 重命名 | `record_date` -> `date` |
| `diet_plans` | `plans` | 重命名 | 增加 `carb_cycle_config`, `is_template` |
| `plan_templates` | (混在 plans?) | **新增** | 明确模板结构 |
| `food_items` | `foods` | 重命名 | 增加 `type` ('system', 'custom'), `tags` |
| `user_favorite_foods` | - | **新增** | 收藏功能支持 |
| `daily_records` | `daily_goals`? | 重命名/重构 | 聚焦于每日快照 (`target_snapshot`) |
| `meal_logs` | `meal_records` | 重命名 | `meal_type` 统一为 Enum 值 |

### 3. 数据流向
- SQL 脚本 -> MySQL 数据库初始化。

---

## 5.4 风险点清单

### 技术风险
- [x] **Entity 与 DB 不一致**: 
  - 影响: 应用启动可能报错，或运行 `TypeORM` 操作时失败。
  - 应对: 
    1. 确保 `data-source.ts` 中 `synchronize: false`，防止 TypeORM 自动反向修改 DB。
    2. 在后续任务中必须优先更新 Entity。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/database/migrations/01_initial_schema.sql` (全量 Schema)
- `fit_cycle_app/src/database/migrations/02_seed_dictionary.sql` (字典数据)

### 文档交付物
- `docs/pj_docs/S-1_分析文档.md` (本文档)

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 所有影响范围已评估
- [x] 技术方案可行且清晰
- [x] 数据流向已明确 (Schema -> DB)

---

## 5.7 下一步行动

1. **立即执行**: 根据分析文档重写 SQL 文件。
2. **后续关注**: 提醒后续 S-2 (User) 任务需同步更新 `User` 和 `HealthProfile` Entity。
