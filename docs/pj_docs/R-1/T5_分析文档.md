# T5 分析文档: R-1 Record 实体设计

## 1. 任务背景 (Task Background)
任务 **R-1** 是记录域 (Record Domain) 的基础，旨在定义饮食打卡的核心数据结构。该模型需要支持用户每日热量目标的追踪、多餐次管理以及摄入营养素的精确计算与快照存储。

## 2. 需求分析 (Requirement Analysis)
- **核心目标**: 建立 `DailyRecord` (每日汇总) 与 `MealLog` (餐次明细) 的 1:N 关系。
- **快照机制**: 
    - `DailyRecord` 需存储 `target_snapshot`，防止用户修改饮食计划后导致历史打卡的进度环目标发生漂移。
    - `MealLog` 需存储 `food_name` 和 `macros` 快照，防止系统食材库更新或删除后导致历史记录错误。
- **业务约束**:
    - 一个用户在同一日期只能有一条 `DailyRecord` (Unique Index: `user_id` + `date`)。
    - 级联删除: 当 `DailyRecord` 删除时，所属的所有 `MealLog` 必须同步物理删除。

## 3. 数据库模型设计 (Database Schema Design)

### 3.1 `daily_records` (每日记录总表)
| 字段名 | 类型 | 描述 | 约束 |
| :--- | :--- | :--- | :--- |
| `id` | BigInt | 主键 | PK, AI |
| `user_id` | BigInt | 关联用户 | FK -> users.id, Not Null |
| `date` | Date | 记录日期 | Not Null |
| `target_snapshot` | JSON | 目标快照 | 包含目标热量、碳水、蛋白、脂肪 |
| `plan_id` | BigInt | 关联计划 | FK -> diet_plans.id, Nullable (可能无计划手动记) |
| `created_at` | Timestamp | 创建时间 | Default: now() |
| `updated_at` | Timestamp | 更新时间 | Default: now() |

**索引**:
- `UNIQUE INDEX idx_user_date` (`user_id`, `date`): 保证每日唯一性。

### 3.2 `meal_logs` (餐食记录明细表)
| 字段名 | 类型 | 描述 | 约束 |
| :--- | :--- | :--- | :--- |
| `id` | BigInt | 主键 | PK, AI |
| `record_id` | BigInt | 关联总表 | FK -> daily_records.id, Not Null, Cascade |
| `meal_type` | Enum | 餐次类型 | 'breakfast', 'lunch', 'dinner', 'snacks' |
| `food_id` | BigInt | 关联食材 | FK -> food_items.id, Not Null |
| `food_name` | Varchar(100) | 食材名称快照 | 防止食材被删 |
| `quantity` | Float | 摄入数量 | 存储单位数量 (如 g, ml) |
| `calories` | Int | 计算后热量 | 根据 food_item.calories * quantity / 100 计算 |
| `macros` | JSON | 营养素快照 | {p, f, c} 计算后的克数 |

## 4. 逻辑实现要点 (Implementation Logic)
- **Entity 层**: 使用 TypeORM 的 `@Entity`, `@Column`, `@ManyToOne`, `@OneToMany` 装饰器。
- **关联处理**: `DailyRecord` 实体中定义 `@OneToMany(() => MealLog, log => log.dailyRecord, { cascade: true })`。
- **快照计算**: 在 Service 层写入 `MealLog` 时，需先从 `FoodItem` 获取单价营养素，乘以 `quantity` 后再存入 `macros` 字段。

## 5. 潜在风险与对策 (Risks & Mitigations)
- **并发写入**: 当用户快速点击“添加食物”时，可能产生多条请求。后端需通过数据库唯一索引拦截重复的 `DailyRecord` 创建。
- **时区问题**: 日期存为 `Date` 类型，后端处理时需统一使用 UTC 或由前端传入标准 YYYY-MM-DD 字符串。

## 6. 结论 (Conclusion)
R-1 的实体设计采用了典型的“总-分”结构，通过快照机制平衡了数据完整性与历史回溯的准确性。设计方案符合 `04_接口与数据规约.md`。
