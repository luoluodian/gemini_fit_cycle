# T6 变更清单: R-1 Record 实体设计 (对齐计划模块版)

## 1. 字段对齐策略 (Naming Alignment Strategy)
- **零成本映射**: `DailyRecord` 的目标字段必须与 `PlanDay` 完全一致，支持 `Object.assign` 式的数据迁移。
- **精度兼容**: 营养素字段统一使用 `decimal` + `transformer: { to: ..., from: parseFloat }`。
- **结构化快照**: 将 `target_snapshot` 拆解为具名列，方便 Analysis 模块直接进行 SQL 聚合查询。

## 2. 数据库变更 (Database Changes)

### 2.1 新增 `DailyRecord` 实体 (`daily_records`)
- **属性对齐**:
    - `targetCalories`: `int` (对齐 `PlanDay.targetCalories`)
    - `targetProtein`: `decimal(8,2)` (对齐 `PlanDay.targetProtein`)
    - `targetFat`: `decimal(8,2)`
    - `targetCarbs`: `decimal(8,2)`
- **扩展字段**:
    - `planId`: `bigint`, Nullable (关联来源计划)
    - `date`: `date` (唯一索引: `[userId, date]`)

### 2.2 重构为 `MealLog` 实体 (`meal_logs`)
- **属性对齐**:
    - `quantity`: `decimal(10,4)` (对齐 `PlanMealItem.quantity`)
    - `calories`: `int`
    - `protein/fat/carbs`: `decimal(10,4)`
    - `mealType`: `enum` ('breakfast', 'lunch', 'dinner', 'snacks')
- **快照补全**:
    - `foodName`: `varchar(100)` (系统食材名冗余)
    - `customName`: `varchar(255)` (用户自填名，对齐 `PlanMealItem.customName`)

## 3. 实现细节 (Implementation Details)

### 3.1 关系定义
- `User` (1) -> `DailyRecord` (N)
- `DailyRecord` (1) -> `MealLog` (N) (Cascade: ALL)
- `MealLog` (N) -> `FoodItem` (1) (onDelete: 'SET NULL')

### 3.2 数值转换
- 所有 `decimal` 字段必须包含：
  ```typescript
  transformer: { 
    to: (v: number) => v, 
    from: (v: string) => parseFloat(v) 
  }
  ```

## 4. 验证计划 (Verification)
- **映射测试**: 编写用例验证 `PlanDay` 数据能否直接解构赋值给 `DailyRecord`。
- **统计审计**: 验证 SQL `SUM(meal_logs.calories)` 是否能与 `DailyRecord.targetCalories` 正确对比。