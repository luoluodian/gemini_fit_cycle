# U-5: 路由守卫 - T5 分析文档

## 5.1 模块关联性审计

- **涉及公共 Store**: `useUserStore` (Pinia) - 用于获取登录状态。
- **涉及路由模块**:
  - `fit_cycle_web/src/router/index.ts`: 路由跳转封装。
  - `fit_cycle_web/src/constants/routes.ts`: 路由常量定义。
- **涉及入口文件**:
  - `fit_cycle_web/src/app.ts`: 处理初始化启动时的权限检查。

## 5.2 影响评估

- **需要修改的现有文件**:
  - `fit_cycle_web/src/router/index.ts`: 注入守卫逻辑。
  - `fit_cycle_web/src/app.ts`: 添加启动自检。
- **对现有功能的影响**: 
  - 所有内部跳转都会经过权限验证。
  - 提升了应用的安全性，防止未登录用户访问受保护页面。

## 5.3 技术落地计划

### 1. 核心任务定义
- **守卫函数实现**: 在 `src/router/index.ts` 中实现 `checkAuth(url)`。
- **跳转拦截**: 修改 `navigateTo`, `redirectTo`, `reLaunch` 等导出函数，在执行原生 Taro 调用前先执行 `checkAuth`。
- **启动检查**: 在 `App.onLaunch` 或首页挂载时，检查当前页面权限。
- **登录重定向**: 登录成功后支持回跳至原目标页面。

### 2. 实现逻辑
1. **定义白名单**: 在 `routes.ts` 中明确 `LOGIN` 为公共页面。
2. **状态检查**: 
   - 调用 `useUserStore().isLoggedIn`。
   - 若未登录且访问非白名单页面，拦截跳转并重定向至 `LOGIN`。
3. **参数透传**: 跳转登录页时携带 `redirect` 参数。

### 3. 风险点
- **小程序 TabBar**: `switchTab` 在小程序中比较特殊，需确保守卫能正确处理 Tab 页面的切换。
- **递归跳转**: 确保守卫逻辑不会导致“未登录 -> 跳转登录页 -> 守卫再次拦截登录页”的死循环。

## 5.4 验收标准 (T7 预案)
- [ ] 在未登录状态下点击跳转“个人中心”，应用应自动重定向至登录页。
- [ ] 登录页本身应在白名单中，不会被拦截。
- [ ] 游客模式 (`demoMode: true`) 下访问应符合预期（视业务需求决定是否允许访问）。
- [ ] 登录成功后，若有 `redirect` 参数，应正确跳转回原页面。
