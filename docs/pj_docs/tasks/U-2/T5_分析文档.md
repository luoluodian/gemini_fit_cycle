# U-2: 封装前端认证服务 - T5 分析文档

## 任务 ID: U-2
**任务名称**: 封装前端认证服务 (登录、登出、Token 管理)
**优先级**: P0
**垂直拆分**: `[前端服务]`
**预估工时**: 2h
**复杂度**: 中

## 5.1 模块关联性审计

-   **涉及公共数据表**: 无 (纯前端逻辑)。
-   **涉及公共组件**: 无。
-   **涉及跨模块 Service**:
    -   `HttpService` (`fit_cycle_web/src/services/http.ts`)：用于发送网络请求。
    -   `StorageService` (`fit_cycle_web/src/utils/storage.ts`)：用于本地存储 Token。
-   **所有关联模块**:
    -   `UserStore` (`fit_cycle_web/src/stores/user.ts`): 状态管理，存储 Token 和用户信息。
    -   `AuthService` (`fit_cycle_web/src/services/modules/auth.ts`): 封装 API 调用。
-   **UI 结构分析**:
    -   本任务不涉及直接 UI 开发，但为 `U-3` (登录页面) 和 `U-5` (路由守卫) 提供基础服务。

## 5.2 影响评估

-   **需要修改的现有文件**:
    -   `fit_cycle_web/src/stores/user.ts`: 需要实现 `login`, `logout` action，以及状态持久化逻辑。
    -   `fit_cycle_web/src/services/http.ts`: 可能需要完善拦截器以处理 401 错误 (自动登出)。
-   **对现有功能的影响**:
    -   无直接负面影响。
    -   完善后将支持全应用的认证状态管理。
-   **必须参考的文件路径**:
    -   `docs/pj_docs/04_接口与数据规约.md`: 参考 `U-1` 接口定义 (`/auth/wechatAuth`, `AuthResponseDto`)。
    -   `docs/pj_docs/03_系统架构设计方案.md`: 参考前端架构中的 Store 和 Service 设计。
-   **潜在的破坏性变更**: 无。

## 5.3 技术落地计划

1.  **文件创建/修改**:
    -   `fit_cycle_web/src/services/modules/auth.ts`:
        -   定义 `login(code: string)` 方法，调用 `POST /auth/wechatAuth`。
        -   定义 `refreshToken()` 方法 (预留)。
    -   `fit_cycle_web/src/stores/user.ts`:
        -   State: `accessToken`, `refreshToken`, `userInfo`。
        -   Actions:
            -   `login(code)`: 调用 Service -> 保存 Token -> 更新 State。
            -   `logout()`: 清除 Token -> 重置 State -> 跳转登录页。
            -   `checkAuth()`: 初始化时检查本地 Token 有效性。
    -   `fit_cycle_web/src/utils/storage.ts`: 确保有 `setStorage`, `getStorage`, `removeStorage` 的封装。

2.  **方法定义**:
    -   `AuthService.login(code)` -> `Promise<AuthResponseDto>`
    -   `UserStore.login(code)` -> `Promise<void>`

3.  **数据流向**:
    -   Component (`LoginButton`) -> `UserStore.login(code)` -> `AuthService.login(code)` -> `API` -> `UserStore` (更新 State & Storage)。

4.  **风险点**:
    -   **Token 过期处理**: 需要在 `http.ts` 拦截器中统一处理 401，调用 `UserStore.logout()`。此逻辑需小心循环依赖 (HttpService <-> UserStore)。建议通过事件总线或回调解决，或者在 `http.ts` 中直接操作 Storage 并跳转，Store 监听路由变化或手动同步。

## 5.4 更新看板

-   将 U-2 任务的 `T5-分析` 列更新为 ✅。
