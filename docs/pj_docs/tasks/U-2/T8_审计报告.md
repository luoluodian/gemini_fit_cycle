# U-2: 封装前端认证服务 - T8 审计报告

## 任务 ID: U-2
**任务名称**: 封装前端认证服务 (登录、登出、Token 管理)
**日期**: 2026-01-27

## 8.1 规范审计

- **命名规范**:
    - 类名/Store名 (`HttpService` in `http.ts`, `useUserStore`) 遵循 `PascalCase` 或项目约定的 Pinia 命名。
    - 方法名 (`login`, `logout`, `setLoginState`) 遵循 `camelCase`。
    - 文件名 (`auth.ts`, `user.ts`) 遵循 `kebab-case`。
    - 符合项目编码规范。
- **代码格式**: 
    - 使用 Prettier 标准格式化，缩进和空格一致。
- **注释完整性**:
    - `auth.ts` 和 `user.ts` (store) 包含必要的 JSDoc 注释。
    - `http/interceptors.ts` 逻辑关键点有注释说明。
- **文件结构**:
    - 目录结构严谨: `services` 封装请求, `stores` 管理状态。
    - **修正**: 移除了冗余的 `src/services/http.ts`，统一使用 `src/services/http/index.ts`，符合模块化设计。

## 8.2 质量与安全审计

- **状态管理 (Pinia)**:
    - `useUserStore` 实现了状态持久化 (通过 `utils/storage`)，确保刷新页面或小程序重启后登录状态不丢失。
    - 职责划分清晰: `setLoginState` 集中处理登录成功的副作用。
- **网络请求 (HttpService)**:
    - **安全性**: `AuthInterceptor` 采用 `Bearer Token` 模式注入请求头。
    - **鲁棒性**: `AuthInterceptor` 实现了 Token 自动刷新机制 (`refreshToken`)，并在刷新失败时强制重定向至登录页 (`navigateToLogin`)，防止死循环请求。
    - **解耦**: 拦截器使用独立的 `storage` 工具类，避免了与 Store 的直接循环依赖。
- **安全审计**:
    - 敏感信息 (Token) 仅存储在小程序/浏览器安全存储中。

## 8.3 视觉还原审计 (与 Service 关联)

- **UI 交互**:
    - 虽然本任务不涉及 UI 界面开发，但 `http` 模块的拦截器中包含了 `showLoading` 和 `showToast` 的逻辑 (在 `request.ts` 和 `interceptors.ts` 中)。
    - **检查**: 确认 `request.ts` 中的 `request` 方法和 `interceptors.ts` 中的 `ErrorInterceptor` 正确调用了 Taro 的 UI 反馈 API。
    - **结论**: 交互逻辑符合预期，能在请求进行中和出错时给予用户反馈。

## 8.4 审计结论

- **风险级别**: 🟢 极低
- **优化建议**:
    1. **Token 刷新并发**: `AuthInterceptor` 已实现了请求队列 (`refreshing.queue`) 来处理并发请求时的 Token 刷新，设计优秀。
    2. **常量统一**: 建议检查 `constants/storage.ts` 中的 Key 定义与 `interceptors.ts` 中使用的 Key (`userToken` vs `ACCESS_TOKEN_KEY`) 是否一致。目前发现 `interceptors.ts` 使用了硬编码字符串 `"userToken"`，建议后续优化为引用常量。

**更新看板**: 将该任务的 T8 列更新为 ✅。