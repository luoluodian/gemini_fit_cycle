# U-2: 前端认证服务 - T7 测试报告

## 7.1 测试环境
- **操作系统**: Darwin (macOS)
- **构建工具**: Taro CLI v4.1.9
- **测试类型**: 静态构建测试 + 手动验证规划

## 7.2 自动化测试结果
> 注：当前前端项目尚未配置单元测试框架 (Jest/Vitest)，仅执行构建级静态检查。

### 7.2.1 构建测试
- **命令**: `npm run build:weapp`
- **结果**: ✅ **PASS**
- **日志摘要**:
  ```bash
  ✓ 669 modules transformed.
  ✓ built in 8.35s
  Error: (none)
  Exit Code: 0
  ```

### 7.2.2 类型检查
- **覆盖范围**: `services/modules/user.ts`, `services/http/interceptors.ts`, `constants/api-config.ts`
- **结果**: ✅ **PASS** (由 TypeScript 编译器保证)
- **关键点验证**:
  - `AuthResponse` 接口与后端定义匹配。
  - `UserInfo` 接口包含 `id`, `nickname`, `avatarUrl`。
  - `getStorage` 和 `setStorage` 泛型使用正确。

## 7.3 手动验证计划 (验收标准)

由于缺乏自动化测试环境，请开发人员在真机/模拟器中执行以下用例：

### 用例 1: 登录状态存储
- **前置**: 清除 App 缓存。
- **操作**: 调用登录接口 (可由 UI 触发或 mock 调用)。
- **预期**: 
  - `Taro.getStorageSync('access_token')` 有值。
  - `Taro.getStorageSync('refresh_token')` 有值。
  - `Taro.getStorageSync('user_info')` 包含用户信息。

### 用例 2: 请求头注入
- **前置**: 已登录。
- **操作**: 发起一个受保护的请求 (如 `GET /user/info`)。
- **预期**: 请求 Header 中包含 `Authorization: Bearer <access_token>`。

### 用例 3: 自动刷新 Token
- **前置**: 
  - 已登录。
  - 手动修改 Storage 中的 `access_token` 为无效值 (或等待过期)。
- **操作**: 发起受保护请求。
- **预期**:
  1. 第一次请求返回 401。
  2. 网络面板显示发起 `POST /auth/refreshToken`。
  3. 刷新成功后，自动重试原请求并返回 200。
  4. Storage 中的 `access_token` 已更新。

### 用例 4: 刷新失败回退
- **前置**: `refresh_token` 也已失效。
- **操作**: 发起受保护请求。
- **预期**:
  1. 刷新接口返回 401 或其他错误。
  2. App 自动跳转至 `/pages/login/index`。
  3. Storage 中的 Token 数据被清除。

## 7.4 遗留风险与建议
- **风险**: 并发请求时的 Token 刷新队列逻辑未经高并发测试，可能存在边缘 case。
- **建议**: 后续引入 Jest + Vue Test Utils 补充拦截器的单元测试。
