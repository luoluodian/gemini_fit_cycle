# U-1: 实现微信登录认证接口 - T5 分析文档

## 任务 ID: U-1
**任务名称**: 实现微信登录认证接口 (包含获取 `openId` 并返回 JWT Token)
**优先级**: P0
**垂直拆分**: `[后端 API]`
**预估工时**: 2h
**复杂度**: 中

## 5.1 模块关联性审计

-   **涉及公共数据表**:
    -   `User` 实体 (`user.entity.ts`)：登录成功后，需要查询或创建用户记录。
-   **涉及公共组件**: N/A (后端 API 任务)。
-   **涉及跨模块 Service**:
    -   `UserService`：用于查询或创建用户。
    -   `JwtService` (`@nestjs/jwt`)：用于生成和验证 JWT Token。
-   **所有关联模块**:
    -   `AuthModule`: 封装所有认证相关逻辑。
    -   `UserModule`: 提供 `UserService`。
    -   `ConfigModule`: 获取配置信息（如 JWT 密钥，微信 AppID/Secret - 虽然微信 API 暂时 Mock）。
-   **UI 结构分析**:
    -   此任务为后端 API，不直接涉及 UI 结构分析。但前端的 `U-3` (登录页面 UI) 和 `U-4` (登录按钮组件) 将会调用此接口。前端需传入微信 `code`，并接收 `accessToken` 和 `userInfo`。

## 5.2 影响评估

-   **需要修改的现有文件**:
    -   `app.module.ts`: 需要引入并注册 `AuthModule`。
    -   `main.ts`: 确保全局 `ValidationPipe`, `TransformInterceptor`, `HttpExceptionFilter` 已配置。
-   **对现有功能的影响**: 无直接影响，为新增功能。
-   **必须参考的文件路径**:
    -   `fit_cycle_app/src/modules/user/user.service.ts`: 参考 `UserService` 的创建和查询用户方法。
    -   `fit_cycle_app/src/main.ts`: 全局管道、拦截器、过滤器配置。
    -   `fit_cycle_app/src/config/config.module.ts`: 获取 JWT 相关配置。
    -   `docs/pj_docs/03_系统架构设计方案.md`: 后端架构分层、核心机制（认证与授权、DTO 校验、统一响应、异常处理）。
    -   `docs/pj_docs/04_接口与数据规约.md`: `U-1` API 契约定义。
-   **潜在的破坏性变更**: 无。

## 5.3 技术落地计划

1.  **文件创建**:
    -   `fit_cycle_app/src/modules/auth/auth.module.ts`: 认证模块。
    -   `fit_cycle_app/src/modules/auth/auth.controller.ts`: 登录控制器，暴露 `/auth/login` 接口。
    -   `fit_cycle_app/src/modules/auth/auth.service.ts`: 认证服务，包含核心登录逻辑和 JWT 生成。
    -   `fit_cycle_app/src/modules/auth/strategies/jwt.strategy.ts`: JWT 策略，用于验证 Token。
    -   `fit_cycle_app/src/modules/auth/guards/jwt-auth.guard.ts`: JWT 认证守卫。
    -   `fit_cycle_app/src/dtos/auth-login.dto.ts`: 请求 DTO。
    -   `fit_cycle_app/src/dtos/auth-response.dto.ts`: 响应 DTO。
2.  **方法定义**:
    -   `AuthController.login(@Body() authLoginDto: AuthLoginDto)`:
        -   接收微信 `code`。
        -   调用 `AuthService.login(code)`。
        -   返回 `AuthResponseDto`。
    -   `AuthService.login(code: string)`:
        -   **Mock 微信 API 调用**: 模拟调用微信接口获取 `openid`。
        -   根据 `openid` 查询 `UserService`，判断用户是否存在。
        -   如果用户不存在，则调用 `UserService.create()` 创建新用户。
        -   使用 `JwtService.sign()` 生成 `accessToken`。
        -   构建并返回 `AuthResponseDto`。
    -   `JwtStrategy.validate(payload)`:
        -   验证 JWT payload 的有效性。
        -   根据 payload 中的用户 ID 查询 `UserService` 获取完整用户数据。
        -   返回用户对象 (NestJS 会将其附加到 `req.user`)。
3.  **数据流向**:
    -   前端 (`U-3`, `U-4`) -> `POST /auth/login` (带 `code`) -> `AuthController` -> `AuthService` -> `UserService` / `JwtService` -> `AuthService` -> `AuthController` -> 前端 (`U-2`)。
4.  **风险点**:
    -   **微信 API 真实对接**: 目前设计为 Mock，未来真实对接时需处理实际的网络请求、微信接口错误和安全性。
    -   **JWT 密钥管理**: 生产环境密钥需安全存储和加载。
    -   **Token 刷新机制**: `AuthResponseDto` 已预留 `refreshToken` 字段，后续需实现刷新逻辑。