# U-1: 实现微信登录认证接口 - T5 分析文档

## 5.1 模块关联性审计

- **涉及公共数据表**: `users` (用户表)
- **涉及公共组件**: 无 (后端接口)
- **涉及跨模块 Service**:
  - `UserService`: 用于查询和创建用户记录。
- **涉及外部依赖**:
  - 微信 `code2session` 接口 (Mock 或 API 调用)。
  - `@nestjs/jwt`: Token 签发。
  - `@nestjs/passport`: 策略管理。

## 5.2 影响评估

- **需要修改的现有文件**:
  - `fit_cycle_app/src/app.module.ts`: 注册 `AuthModule`。
- **对现有功能的影响**: 无 (新增核心流程)。
- **必须参考的文件路径**:
  - `docs/pj_docs/04_接口与数据规约.md`: 定义了 `/auth/wechatAuth`。
  - `fit_cycle_app/src/database/entity/user.entity.ts`: 确认 `open_id` 字段。
- **潜在的破坏性变更**: 无。

## 5.3 技术落地计划

### 1. 核心类定义
- **AuthService**:
  - `wechatAuth(code: string)`: 核心业务逻辑。
  - `createAccessToken(uid: number)`: 签发 JWT。
- **AuthController**:
  - `wechatLogin(@Body() dto: WechatAuthDto)`: 暴露接口。

### 2. 实现逻辑
1. 接收 `code`。
2. 调用微信 API (Mock) 置换 `open_id`。
3. 调用 `UserService.findOrCreateByOpenid(open_id)`。
4. 签发 JWT Token。
5. 返回 `{ accessToken, user }`。

### 3. 风险点
- **微信 API 异常**: 如果微信接口不可用，需有完善的错误抛出（401/500）。
- **Token 安全性**: JWT 密钥必须从环境变量加载。

## 5.4 验收标准 (T7 预案)
- [ ] 调用 `/auth/wechatAuth` 返回 200/201。
- [ ] 响应包含 `accessToken`。
- [ ] 数据库中成功创建或更新了用户记录。