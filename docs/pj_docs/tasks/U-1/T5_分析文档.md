# U-1: 微信登录认证接口 - T5 分析文档

## 5.1 模块关联性审计

- **涉及公共数据表**: `User` (用户表)
- **涉及公共组件**: 无 (纯后端接口)
- **涉及跨模块 Service**: 
  - `UserService` (UserModule): 用于按 OpenID 查找或创建用户。
- **涉及外部依赖**: 
  - 微信服务端 API (`jscode2session`): 用于置换 OpenID。
  - JWT Library: 用于生成 AccessToken。

## 5.2 影响评估

- **需要修改的现有文件**:
  - `src/app.module.ts`: 需导入 `AuthModule`。
- **对现有功能的影响**: 无 (新增模块)。
- **必须参考的文件路径**:
  - `docs/pj_docs/04_接口与数据规约.md`: 遵循定义的 API 路径 `/auth/login` 和响应格式。
  - `src/database/entity/user.entity.ts`: 确认 User 实体结构。

## 5.3 技术落地计划

### 1. 模块创建
创建 `AuthModule`，包含 `AuthController` 和 `AuthService`。

### 2. 核心方法定义
- **AuthController**:
  - `login(@Body() body: AuthLoginDto)`: 接收 code。
- **AuthService**:
  - `validateUser(code: string)`: 调用微信 API (Mock或真实) 获取 OpenID。
  - `login(user: User)`: 生成 JWT Token。
- **JwtStrategy**:
  - `validate(payload)`: 验证 Token 有效性。

### 3. 数据流向
1. Client POST `code` -> Controller
2. Service 调用微信 API -> 获取 `openid`
3. Service 调用 `UserService.findOneByOpenid`
   - 存在 -> 返回 User
   - 不存在 -> `UserService.create` -> 返回 New User
4. Service 生成 JWT -> 返回 `{ accessToken, user }`

### 4. 风险点
- **微信 API 配置**: 需要 `APP_ID` 和 `APP_SECRET` 环境变量。如果缺失，需提供 Mock 模式以便本地开发。
- **用户表依赖**: 必须确保 U-9 (User Entity) 已就绪。

## 5.4 验证计划 (T7 预案)
- 编写 E2E 测试 `auth.e2e-spec.ts`。
- 模拟微信 API 返回特定的 OpenID，验证用户创建逻辑。
