# U-1: 实现微信登录认证接口 - T7 测试报告

## 任务 ID: U-1
**任务名称**: 实现微信登录认证接口 (包含获取 `openId` 并返回 JWT Token)
**日期**: 2026-01-27

## 7.1 链路跑通测试

### 测试环境
- **后端**: NestJS (v11.1.9)
- **数据库**: MySQL (120.26.103.157)
- **Redis**: 已连接

### 测试用例 1: 微信登录成功 (首次授权)
- **输入**: 有效的 `code`, `rawData` (包含昵称和头像)
- **行为**: 
    1. Mock 微信 API 返回 `openid`。
    2. 后端查询数据库，若无此 `openid` 则创建用户。
    3. 更新用户的 `nickname` 和 `avatarUrl`。
    4. 生成 JWT `accessToken` 和 `refreshToken`。
- **预期输出**: 
    - HTTP 201 (NestJS 默认) / 拦截器包装后返回 `code: 200`。
    - 返回 `accessToken`, `refreshToken`, `user` 对象。
- **实际结果**: ✅ 通过 (见 e2e 测试日志)

### 测试用例 2: 微信登录成功 (静默登录/老用户)
- **输入**: 有效的 `code` (不带 `rawData`)
- **行为**: 
    1. Mock 微信 API 返回已存在的 `openid`。
    2. 后端获取现有用户信息。
    3. 返回新的 Token。
- **预期输出**: 
    - `code: 200`。
    - 返回 `accessToken`, `user` (包含之前存储的资料)。
- **实际结果**: ✅ 通过

## 7.2 鲁棒性验证

### 测试用例 3: 缺少 `code`
- **输入**: `{}`
- **预期输出**: HTTP 400, 提示 `code must be a string`。
- **实际结果**: ✅ 通过 (ValidationPipe 拦截成功)

### 测试用例 4: 微信 API 返回错误
- **输入**: 模拟微信 API 返回 `errcode: 40029`。
- **预期输出**: HTTP 401, 提示 `invalid code`。
- **实际结果**: ✅ 通过 (AuthService 抛出 UnauthorizedException)

## 7.3 回归测试与 Bug 修复

### 发现的问题
1. **数据库列名不匹配**: `User` 实体中使用的 `openId` 属性映射到了错误的列名 (或未映射)。通过 `mysql DESCRIBE` 发现实际列名为 `open_id`。
2. **测试环境拦截器未生效**: 初始 e2e 测试未手动应用 `TransformInterceptor`，导致断言失败。

### 修复方案
1. **修正实体映射**: 更新 `user.entity.ts`，显式指定 `@Column({ name: 'open_id' })` 等。
2. **完善测试基座**: 在 `auth.e2e-spec.ts` 中应用生产环境的全局管道、拦截器和过滤器。

## 7.4 结论
U-1 任务核心链路已跑通，异常处理符合预期，代码已通过 e2e 验证。

**更新看板**: 将该任务的 T7 列更新为 ✅。
