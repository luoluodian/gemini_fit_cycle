# U-9: User 表设计 - T5 分析文档

## 5.1 模块关联性审计

- **涉及核心表**: `users`
- **涉及关联表**: 
  - `diet_logs`, `diet_plans`, `daily_goals`, `weight_records`, `daily_checkins` 等（通过 `user_id` 关联）。
- **字段规范**:
  - `open_id`: 微信唯一标识，强制索引且唯一。
  - `gender_id`, `activity_level_id`, `goal_type_id`: 引用数据字典 ID。
  - `height_cm`, `weight_kg`: 使用 `DECIMAL(5,2)` 确保精度。

## 5.2 影响评估

- **现状**: 实体代码与 `initial-schema.sql` 存在命名差异（如 `openid` vs `open_id`）。
- **风险**: 若不统一，会导致开发环境（TypeORM 自动同步）与生产环境（手动执行 SQL）的行为不一致。
- **解决方案**: 以 Entity 代码为准，同步修正 SQL 脚本。

## 5.3 技术落地计划

### 1. 表结构定义 (Target)
| 字段 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| id | INT | PK, AI | 用户 ID |
| open_id | VARCHAR(100) | UK, NOT NULL | 微信 OpenID |
| nickname | VARCHAR(100) | - | 昵称 |
| avatar_url | VARCHAR(500) | - | 头像地址 |
| gender_id | INT | - | 性别 (字典) |
| date_of_birth | DATE | - | 出生日期 |
| height_cm | DECIMAL(5,2) | - | 身高 |
| weight_kg | DECIMAL(5,2) | - | 体重 |
| activity_level_id | INT | - | 活动水平 (字典) |
| goal_type_id | INT | - | 目标类型 (字典) |
| refresh_token | TEXT | - | JWT 刷新令牌 |
| created_at | TIMESTAMP | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

### 2. 实现路径
1. 修改 `fit_cycle_app/src/database/migrations/initial-schema.sql`。
2. 确保 `User` 实体中的装饰器属性与 SQL 定义完全匹配。

## 5.4 验收标准 (T7 预案)
- [ ] SQL 脚本可无错执行。
- [ ] `User` 实体通过 TypeORM 同步后生成的表结构与 SQL 脚本一致。
- [ ] 关联关系（OneToMany）在子表中具有正确的 Foreign Key 约束。
