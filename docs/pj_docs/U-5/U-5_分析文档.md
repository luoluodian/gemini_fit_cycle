# U-5: 个人中心页 UI - T5 分析文档

> **任务 ID**: U-5  
> **任务名称**: 个人中心页 UI  
> **优先级**: P0  
> **垂直拆分**: 前端页面 / 前端组件 / 前端服务  
> **预估工时**: 4h  
> **复杂度**: 中  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- 无 (前端任务)

### 涉及公共组件
- `GlassCard` (`fit_cycle_web/src/components/common/GlassCard.vue`): 用于卡片式布局。
- `BaseButton` (`fit_cycle_web/src/components/common/BaseButton.vue`): 用于按钮交互。
- `BaseNavBar` (`fit_cycle_web/src/components/common/BaseNavBar.vue`): 顶部导航。

### 涉及现有业务组件
- `ProfileHeader`: 头部用户信息展示。
- `CurrentPlanCard`: 当前计划卡片。
- `QuickStats`: 核心数据统计。
- `WeeklyProgressChart`: 周趋势图表 (暂用 Mock 数据，等待 A-1/A-2)。
- `HealthTools`: 健康工具入口。
- `SettingsMenu`: 设置菜单。
- `ImportPlanCard`: 导入计划入口。

### 涉及跨模块 Service
- `UserService` (`fit_cycle_web/src/services/modules/user.ts`): 需要扩展以支持获取完整个人档案。
- `UserStore` (`fit_cycle_web/src/stores/user.ts`): 需要扩展状态以存储统计数据和健康档案。

### UI 结构分析
- **参考文件**: `html/profile.html`
- **DOM 结构**:
  - 顶部 Header (渐变背景 + 用户头像 + 昵称 + 坚持天数)。
  - 当前计划卡片 (嵌入 Header 中)。
  - 核心统计 (天数、完成计划数)。
  - 图表卡片 (周摄入趋势)。
  - 菜单列表 (健康工具、设置、导入)。
  - 底部导航栏 (TabBar)。
- **交互逻辑**:
  - 点击菜单项跳转或弹出模态框 (BMR计算器等)。
  - 下拉刷新更新数据 (可选)。

---

## 5.2 影响评估

### 需要修改的现有文件
1.  `fit_cycle_web/src/services/modules/user.ts`:
    - 修改: 新增 `getUserProfile` 方法，调用 `GET /user/profile`。
    - 修改: 更新/新增响应类型定义 `UserProfileResponse` (包含 `user`, `health`, `stats`)。
2.  `fit_cycle_web/src/stores/user.ts`:
    - 修改: State 新增 `healthProfile` 和 `stats` 字段。
    - 修改: Action 新增 `fetchUserProfile` 方法。
3.  `fit_cycle_web/src/pages/profile/index.vue`:
    - 修改: `onShow` (或 `useDidShow`) 时调用 `userStore.fetchUserProfile()`。
    - 修改: 将硬编码的 `totalDays`, `completedPlans` 替换为 Store 中的数据。
    - 修改: `CurrentPlanCard` 的数据源目前 API 未提供，建议保留 Mock 或标记为 TODO (待 P-4/P-5 计划模块完善后接入)。

### 对现有功能的影响
- **无破坏性变更**: 仅扩展现有 Store 和 Service。

---

## 5.3 技术落地计划

### 1. 接口与类型定义

在 `fit_cycle_web/src/services/modules/user.ts` 中定义契约类型：

```typescript
// 对应 docs/pj_docs/04_接口与数据规约.md 中的定义
export interface HealthProfile {
  id: number;
  gender: 'male' | 'female';
  height: number;
  weight: number;
  birthday: string;
  activityLevel: number;
  bmr: number;
  tdee: number;
}

export interface UserStats {
  totalDays: number;
  completedPlans: number;
}

export interface UserProfileResponse {
  user: UserInfo;
  health: HealthProfile;
  stats: UserStats;
}
```

### 2. Service 方法扩展

```typescript
// fit_cycle_web/src/services/modules/user.ts

/**
 * 获取用户完整档案 (包含健康数据和统计)
 */
export async function getUserProfile(): Promise<UserProfileResponse> {
  // 注意：确认后端接口路径是 /user/profile 还是 /user/info
  // 根据 04 文档应为 /user/profile
  return httpRequest.get("/user/profile");
}
```

### 3. Store 状态扩展

```typescript
// fit_cycle_web/src/stores/user.ts

state: () => ({
  // ... existing
  healthProfile: null as HealthProfile | null,
  stats: null as UserStats | null,
}),

actions: {
  // ... existing
  async fetchUserProfile() {
    try {
      const res = await getUserProfile();
      this.userInfo = res.user; // 更新基本信息
      this.healthProfile = res.health;
      this.stats = res.stats;
      
      // 更新本地存储 (可选，如果需要离线显示)
      setStorage(USER_INFO_KEY, this.userInfo);
    } catch (error) {
      console.error('Fetch profile failed:', error);
    }
  }
}
```

### 4. UI 数据绑定

在 `fit_cycle_web/src/pages/profile/index.vue` 中：

```typescript
// 替换 computed userData
const userData = computed(() => ({
  nickname: userStore.userInfo?.nickname || '微信用户',
  avatarUrl: userStore.userInfo?.avatarUrl,
  totalDays: userStore.stats?.totalDays || 0, // 绑定 Store
  completedPlans: userStore.stats?.completedPlans || 0, // 绑定 Store
}));

// 生命周期调用
useDidShow(() => {
  // ... existing logic
  if (userStore.isLoggedIn) {
    userStore.fetchUserProfile();
  }
});
```

### 5. 依赖任务检查

- [x] 依赖任务 `U-3` (登录页面 UI) 已完成 (Store 基础已存在)。
- [ ] 依赖任务 `U-4` (用户信息接口) 需确认后端 API 已就绪。

---

## 5.4 风险点清单

### 数据一致性风险
- **风险描述**: `CurrentPlan` (当前计划) 数据不在 `GET /user/profile` 返回中。
- **影响**: 个人中心页面的"当前计划"卡片无法显示真实数据。
- **应对措施**: 
  1. 暂时保持 Mock 数据。
  2. 待 `P-2` (计划接口) 完成后，在 `useDidShow` 中额外调用 `getPlans({ status: 'active' })` 来获取当前计划。

### 类型同步风险
- **风险描述**: 前端定义的 `HealthProfile` 需与后端 Entity 保持一致。
- **应对措施**: 严格参照 `04_接口与数据规约.md` 定义 interface。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_web/src/services/modules/user.ts` (更新)
- `fit_cycle_web/src/stores/user.ts` (更新)
- `fit_cycle_web/src/pages/profile/index.vue` (更新)

### 文档交付物
- `docs/pj_docs/U-5/T6_变更清单.md`

---

## 5.6 下一步行动

1. **立即执行**: 进入 T6 编码阶段，修改 Service 和 Store。
2. **确认后端**: 确认 `U-4` 接口是否已部署及可用。
