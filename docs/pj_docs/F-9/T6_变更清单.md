# F-9: 食材收藏接口 - T6 变更清单

> **变更日期**: 2026-01-31  
> **执行人**: AI Assistant

---

## 1. 变更摘要

本次任务实现了食材的收藏与取消收藏功能。通过引入 `UserFavoriteFood` 实体建立了用户与食材的多对多关联关系，并增强了现有的食材列表和详情接口，使其能够返回当前用户的收藏状态。

## 2. 文件变更列表

### 新增文件

| 文件路径 | 变更类型 | 说明 |
|:---|:---|:---|
| `fit_cycle_app/src/database/entity/user-favorite-food.entity.ts` | 新增 | 定义用户收藏食材的关联表实体。 |

### 修改文件

| 文件路径 | 变更类型 | 说明 |
|:---|:---|:---|
| `fit_cycle_app/src/database/entities.module.ts` | 修改 | 注册 `UserFavoriteFood` 实体。 |
| `fit_cycle_app/src/modules/food-items/food-items.service.ts` | 修改 | 实现 `favorite`, `unfavorite` 逻辑，并增强 `list` 和 `detail` 以支持 `isFavorite` 字段。 |
| `fit_cycle_app/src/modules/food-items/food-items.controller.ts` | 修改 | 暴露收藏与取消收藏接口，并为 `list` 和 `detail` 注入用户 ID。 |

## 3. 详细变更内容

### 3.1 实体设计 (`UserFavoriteFood`)
- [x] 表名: `user_favorite_foods`。
- [x] 核心字段: `userId`, `foodId`。
- [x] 约束: `[userId, foodId]` 组合唯一索引。

### 3.2 业务逻辑集成
- [x] **收藏逻辑**: 验证食材存在性 -> 幂等性检查 -> 保存。
- [x] **取消收藏**: 根据 UID 和 FID 物理删除关联记录。
- [x] **状态反馈**: 列表查询时，通过二级查询高效匹配当前用户的收藏集合，并映射 `isFavorite: boolean` 到结果集。

## 4. 验证计划

1.  **构建验证**: 运行 `npm run build` 已成功。
2.  **单元测试**: 运行 `npm run test src/modules/food-items/food-items.service.spec.ts` 已成功，覆盖了收藏、取消收藏及收藏状态回显逻辑。
