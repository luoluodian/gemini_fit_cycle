# F-9: 食材收藏接口 - T5 分析文档

> **任务 ID**: F-9  
> **任务名称**: 食材收藏接口  
> **优先级**: P1  
> **垂直拆分**: 后端 API / DB  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [ ] `user_favorite_foods` (新表): 存储用户与食材的收藏关系。
- [x] `food_items`: 被收藏的食材。
- [x] `users`: 执行收藏操作的用户。

### 涉及跨模块 Service
- `FoodItemsService`: 负责实现收藏与取消收藏的逻辑。

### 交互逻辑分析
- **收藏**: 用户点击心形图标 -> `POST /food-items/:id/favorite` -> 写入关联表。
- **取消收藏**: 再次点击 -> `DELETE /food-items/:id/favorite` -> 删除关联记录。
- **查询状态**: 在食材列表或详情中，需要返回当前用户是否已收藏该食材 (`isFavorite` 字段)。

---

## 5.2 影响评估

### 需要修改的现有文件
- [ ] `fit_cycle_app/src/database/entities.module.ts`: 注册新实体。
- [ ] `fit_cycle_app/src/modules/food-items/food-items.service.ts`: 增加收藏/取消收藏方法，并修改 `list` 和 `detail` 方法以支持 `isFavorite` 字段。
- [ ] `fit_cycle_app/src/modules/food-items/food-items.controller.ts`: 暴露收藏/取消收藏接口。

### 新增文件清单
- [ ] `fit_cycle_app/src/database/entity/user-favorite-food.entity.ts`: 定义收藏关系实体。

### 对现有功能的影响
- **列表与详情**: 需要在返回的 JSON 中增加 `isFavorite` 布尔值。

---

## 5.3 技术落地计划

### 1. 实体定义 (`UserFavoriteFood`)

- `id`: PK (BigInt)
- `userId`: FK -> users.id
- `foodId`: FK -> food_items.id
- `createdAt`: CreateDateColumn
- **唯一约束**: `[userId, foodId]` 组合唯一。

### 2. 接口契约对齐

- **POST /food-items/:id/favorite**
- **DELETE /food-items/:id/favorite**

### 3. 代码实现方案

1.  **Service 逻辑**:
    - `favorite(userId, foodId)`: 检查食材是否存在 -> 检查是否已收藏 -> 写入。
    - `unfavorite(userId, foodId)`: 删除对应记录。
    - **增强查询**: 在 `list` 和 `detail` 中，如果提供了 `userId`，则通过 `LEFT JOIN` 或额外的查询判断收藏状态。

### 4. 数据流向

```
Frontend -> JWT Guard -> Controller -> Service -> Repository (UserFavoriteFood)
```

---

## 5.4 风险点清单

- **性能**: 在列表查询（如一次 50 条）中判断收藏状态。
  - 应对措施: 使用 `LEFT JOIN` 一次性查出，或者通过 `IN` 子查询当前用户的所有收藏 ID 进行内存匹配。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/database/entity/user-favorite-food.entity.ts`
- `fit_cycle_app/src/modules/food-items/food-items.service.ts` (更新)
- `fit_cycle_app/src/modules/food-items/food-items.controller.ts` (更新)

### 文档交付物
- T6~T9 全套文档。

---

## 5.6 自检清单
- [x] 收藏关系表结构符合规约
- [x] 接口路径与项目现有风格一致
- [x] 支持取消收藏
- [x] 列表与详情接口已增强 `isFavorite` 字段

---

## 5.7 下一步行动
1. **立即执行**: 创建 `UserFavoriteFood` 实体并注册。
2. **立即执行**: 更新 Service 和 Controller 实现 API。
