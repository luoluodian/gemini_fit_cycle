# P-4: 计划状态管理 - T5 分析文档

> **任务 ID**: P-4  
> **任务名称**: 计划状态管理  
> **优先级**: P0  
> **垂直拆分**: 后端 API / 业务逻辑  
> **预估工时**: 3h  
> **复杂度**: 低  
> **分析时间**: 2026-02-03 14:00  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `diet_plans` (`fit_cycle_app/src/database/entity/diet-plan.entity.ts`): 更新 `status` 和 `startDate` 字段。

### 涉及跨模块 Service
- [x] `DietPlansService`: 核心逻辑实现地。

### 所有关联模块
- `PlanModule`: 提供计划管理接口。

---

## 5.2 影响评估

### 需要修改的现有文件
- [ ] `fit_cycle_app/src/modules/diet-plans/diet-plans.service.ts`: 完善 `activatePlan` 逻辑，增加 `pausePlan` 逻辑。
- [ ] `fit_cycle_app/src/modules/diet-plans/diet-plans.controller.ts`: 暴露暂停接口。

### 对现有功能的影响
- [x] **有影响**: 确定了用户当前唯一生效的饮食方案，直接影响后续“今日目标”的计算。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 状态枚举定义。

### 潜在的破坏性变更
- [x] **无破坏性变更**

---

## 5.3 技术落地计划

### 1. 业务规则定义

#### 单一激活原则 (Single Active Principle)
- 用户在任一时刻只能有一个处于 `active` 状态的计划。
- 激活一个计划时，系统必须自动将该用户其他所有 `active` 状态的计划变更为 `paused`。

#### 激活逻辑增强
- 当激活计划时，若 `startDate` 为空，则自动设置为当前日期。
- 只有属于本人的计划才能被激活/暂停。

### 2. 方法定义

#### 后端方法
```typescript
// Controller
@Post(':id/activate')
async activate(@Req() req: any, @Param('id') id: string);

@Post(':id/pause')
async pause(@Req() req: any, @Param('id') id: string);

// Service
/**
 * 激活计划：实施“单一激活原则”，并设置起始日期
 */
async activatePlan(userId: number, planId: number): Promise<{ success: true }>;

/**
 * 暂停计划
 */
async pausePlan(userId: number, planId: number): Promise<{ success: true }>;
```

### 3. 数据流向

```
[前端点击激活] → [Controller] → [Service] → [MySQL (事务: update all to paused -> update target to active)]
```

### 4. 依赖任务检查

- [x] 依赖任务 `P-2` (CRUD 接口) 已完成。

---

## 5.4 风险点清单

### 技术风险
- [ ] **并发激活请求**
  - 影响: 极短时间内多次点击可能导致数据库状态不一致。
  - 应对措施: 虽然发生概率低，但 Service 中应确保两步更新操作的顺序，或在 `activatePlan` 中增加简单锁机制。

### 业务风险
- [ ] **误操作暂停**
  - 影响: 用户误触导致记录无法匹配计划。
  - 应对措施: 前端增加确认弹窗。

---

## 5.5 预期交付物

### 代码交付物
- [x] 完善后的 `DietPlansService`
- [x] 暴露暂停接口的 `DietPlansController`

### 文档交付物
- [x] T6_变更清单.md
- [x] T7_测试报告

---

## 5.6 下一步行动

1. **立即执行**: 进入 T6 编码，完善激活与暂停逻辑。
