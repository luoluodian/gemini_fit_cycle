# P-4: 计划状态管理 - T6 变更清单

> **任务 ID**: P-4  
> **任务状态**: 已实现单一激活逻辑与暂停功能

---

## 6.1 代码变更详情

### 后端 (fit_cycle_app)

#### 1. 服务层增强 (`src/modules/diet-plans/diet-plans.service.ts`)
- [x] **激活事务化**: 在 `activatePlan` 中引入事务，确保“互斥激活”的原子性。
- [x] **单一激活原则**: 逻辑会自动寻找并暂停该用户当前所有 `ACTIVE` 状态的计划。
- [x] **自动补全日期**: 激活时若 `startDate` 为空，系统会自动填充为当前服务器日期。
- [x] **新增暂停逻辑**: 实现 `pausePlan` 方法，支持将指定计划切回 `PAUSED` 状态。

#### 2. 控制层端点补全 (`src/modules/diet-plans/diet-plans.controller.ts`)
- [x] **新增接口**: `POST /diet-plans/:id/pause`。
- [x] **权限校验**: 两个状态切换端点均严格执行 `userId` 归属权校验。

---

## 6.2 待办事项 (Next Steps)

1. **进入 T7 测试**: 
    - 创建两个计划 A 和 B。
    - 激活 A -> 检查 A 为 ACTIVE。
    - 激活 B -> 检查 A 是否自动变为 PAUSED，B 是否为 ACTIVE。
    - 暂停 B -> 检查 B 状态是否正确变更。
2. **进入 P-5**: 计划列表 UI 开发。
