# S-3: 前端基础架构 - T5 分析文档

> **任务 ID**: S-3
> **任务名称**: 前端基础架构
> **优先级**: P0
> **垂直拆分**: 前端服务 / 公共逻辑
> **预估工时**: 2h
> **复杂度**: 中
> **分析时间**: 2026-01-31
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [ ] 无

### 涉及公共组件
- [x] `RequestManager` (`fit_cycle_web/src/services/http/request.ts`): 核心请求类。
- [x] `AuthInterceptor` (`fit_cycle_web/src/services/http/interceptors.ts`): 认证拦截器。
- [x] `UserStore` (`fit_cycle_web/src/stores/user.ts`): 用户状态管理。

### 涉及跨模块 Service
- [x] `HttpService` (`fit_cycle_web/src/services/http/index.ts`): 全局 HTTP 服务。

### 所有关联模块
- `User`, `Auth`: 基础架构强依赖于用户认证逻辑。

### UI 结构分析（前端任务必填）
- 本任务为纯逻辑层重构，不涉及 UI 变更。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_web/src/services/http/types.ts`: 需要更新 `ApiResponse` 接口以严格匹配 `04_接口与数据规约.md` (确认 `code`, `data`, `message` 结构)。
- [x] `fit_cycle_web/src/services/http/interceptors.ts`: 需检查 `AuthInterceptor` 中的 Token 刷新逻辑是否与后端 S-2 确认的接口一致。
- [x] `fit_cycle_web/src/stores/user.ts`: 需增强类型定义，确保 `UserInfo` 接口与后端返回一致。
- [x] `fit_cycle_web/src/services/modules/auth.ts`: 需调整登录/刷新接口的返回类型定义。

### 对现有功能的影响
- **有影响**: 修改 HTTP 基础类可能会影响所有 API 调用。必须确保向下兼容或同步修改所有引用点。目前的引用点主要集中在 `auth` 和 `user` 模块。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: "2. API 接口契约"。

### 潜在的破坏性变更
- **有破坏性变更**: 如果 `ApiResponse` 的泛型定义发生变化，可能导致现有的 API 调用处类型报错。

---

## 5.3 技术落地计划

### 1. 文件创建清单
无新文件，主要是修改。

### 2. 代码审计与修正点

#### 前端方法 (`http/types.ts`)
- **现状**:
  ```typescript
  export interface ApiResponse<T = unknown> {
    readonly code: number;
    readonly message: string;
    readonly data: T;
  }
  ```
- **修正目标**: 现状已符合规约。

#### 前端方法 (`http/interceptors.ts`)
- **现状**: `AuthInterceptor` 中的 `refreshToken` 期望返回 `{ accessToken, refreshToken, user }`。
- **修正目标**: 
  - 后端 `/auth/refreshToken` 仅返回 `{ accessToken, refreshToken }`。
  - **修正点**: 移除 `refreshToken` 方法中对 `res.user` 的依赖，避免解构错误或无效存储。

#### 前端方法 (`stores/user.ts` & `services/modules/auth.ts`)
- **现状**: `UserInfo` 类型定义过于简单 (`id`, `nickname`, `avatarUrl`)。
- **修正目标**: 
  - 根据后端 `UserResponseDto` 补全字段：`email`, `phone`, `genderId`, `activityLevelId`, `goalTypeId`, `isCompleted` 等。
  - 统一 `services/modules/auth.ts`, `services/modules/user.ts` 和 `stores/user.ts` 中的类型定义。

### 3. 数据流向
```
View -> Store Action -> API Service (RequestManager) -> Interceptors -> Backend
```

### 5. 依赖任务检查
- [x] 依赖任务 `S-2` 已完成 (后端接口已就绪)。

---

## 5.4 风险点清单

### 技术风险
- [x] **Token 刷新死循环**: 如果 RefreshToken 也过期，拦截器必须能够中断重试并跳转登录页。目前的 `AuthInterceptor` 看起来有处理逻辑，需通过 Review 确认。
- [x] **类型定义不一致**: 前端手动定义的类型 (`interface`) 可能与后端 DTO 不一致。建议 S-3 阶段先手动对齐，后续考虑自动化生成（如有）。

---

## 5.5 预期交付物

### 代码交付物
- 修正后的 `fit_cycle_web/src/services/http/types.ts`
- 修正后的 `fit_cycle_web/src/stores/user.ts`
- 修正后的 `fit_cycle_web/src/services/modules/auth.ts`

### 文档交付物
- `docs/pj_docs/S-3/S-3_分析文档.md`

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 所有影响范围已评估
- [x] 技术方案可行且清晰
- [x] 数据流向已明确

---

## 5.7 下一步行动

1. **立即执行**: 
   - 检查 `fit_cycle_web/src/services/http/interceptors.ts` 中的刷新 Token 逻辑。
   - 对齐 `fit_cycle_web/src/stores/user.ts` 中的 `UserInfo` 类型。
2. **需要澄清**: 无。
