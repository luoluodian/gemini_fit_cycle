# U-2: 认证服务封装 - T5 分析文档

> **任务 ID**: U-2
> **任务名称**: 认证服务封装
> **优先级**: P0
> **垂直拆分**: 前端服务 / 状态管理
> **预估工时**: 1h
> **复杂度**: 低
> **分析时间**: 2026-01-31
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [ ] 无

### 涉及公共组件
- [x] `UserStore` (`fit_cycle_web/src/stores/user.ts`): 核心状态管理。
- [x] `AuthService` (`fit_cycle_web/src/services/modules/auth.ts`): 认证相关 API 封装。

### 涉及跨模块 Service
- [x] `HttpService` (`fit_cycle_web/src/services/http/index.ts`): 依赖基础请求服务。

### 所有关联模块
- `Login` Page, `Profile` Page。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_web/src/stores/user.ts`:
    - 现有的 `login` action 直接调用了 API 并更新状态，逻辑基本正确。
    - **增强点**: 需要增加 `checkLoginStatus` 方法（用于小程序启动时检查 `checkSession` 和本地 Token 有效性），以及 `updateUserInfo` action（当 Token 刷新或资料更新时同步更新 Store）。
- [x] `fit_cycle_web/src/services/modules/auth.ts`:
    - 现有代码已包含 `login` 方法。

### 对现有功能的影响
- **有影响**: 完善登录态管理逻辑会增强用户体验（避免频繁登录），但需确保不破坏现有的 Token 刷新机制。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 认证接口。

### 潜在的破坏性变更
- **无破坏性变更**: 主要是增强和封装。

---

## 5.3 技术落地计划

### 1. 文件创建清单
无新文件。

### 2. 代码审计与修正点

#### 前端方法 (`stores/user.ts`)
- **现状**:
  ```typescript
  async login(code: string) { ... }
  ```
- **修正目标**:
  - 增加 `checkLoginStatus()`: 调用 `Taro.checkSession()`。如果失败，则清除登录态；如果成功但无 Token，也视为未登录。
  - 完善 `logout()`: 除了清除 Storage，还应重置 Store 状态为初始值（不仅是 null，避免空指针）。

### 3. 数据流向
```
App Launch -> UserStore.checkLoginStatus() -> Taro.checkSession()
Login Page -> UserStore.login(code) -> API.login(code) -> Update Store & Storage
```

### 5. 依赖任务检查
- [x] 依赖任务 `U-1` 已完成 (后端接口就绪)。
- [x] 依赖任务 `S-3` 已完成 (前端基础架构就绪)。

---

## 5.4 风险点清单

### 技术风险
- [x] **登录态不同步**: `Taro.checkSession` 只能检查微信侧 SessionKey 是否过期，不能检查自建系统的 Token 是否过期。
  - **对策**: 双重检查。`checkSession` 成功后，发起一个静默请求（如 `getUserInfo`）验证 Token。

---

## 5.5 预期交付物

### 代码交付物
- 增强后的 `fit_cycle_web/src/stores/user.ts`。

### 文档交付物
- `docs/pj_docs/U-2/U-2_分析文档.md`

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 所有影响范围已评估
- [x] 技术方案可行且清晰
- [x] 数据流向已明确

---

## 5.7 下一步行动

1. **立即执行**: 
   - 修改 `fit_cycle_web/src/stores/user.ts`，增加 `checkLoginStatus` 和更健壮的 `logout`。
2. **需要澄清**: 无。
