# T5 分析文档: R-6 快捷添加逻辑 (Quick Add) - 极简稳健版

## 1. 任务背景 (Task Background)
任务 **R-6** 实现“计划一键同步”。通过复用已有的日期计算与事务逻辑，以最轻量的代码实现“计划引导记录”的业务闭环。

## 2. 逻辑减负策略 (Optimization Strategy)
- **取消物理字段**: 废弃 `sourcePlanItemId` 幂等字段，采用纯增量添加。
- **极致复用**: 
    - 后端：强行复用 R-2 的 `getDateDiff` 与 R-3 的事务模板。
    - 前端：复用 `HomeMealCard` 的 UI 结构，仅增加一个事件。

## 3. 核心业务逻辑 (Simplified Logic)

### 3.1 跨模块数据流
1.  **定位**: 调用 `this.dietPlansService.findActivePlan(userId)`。
2.  **计算**: 使用内部 `calculateDayNumber(plan, targetDate)` 确定当前是计划第几天。
3.  **提取**: 从 `activePlan` 树中提取对应 `mealType` 的食物列表。
4.  **转化**:
    - 若无记录，返回空。
    - 若有记录，批量映射为 `MealLog` 数组（继承基准快照）。
5.  **落库**: 开启事务，确保 `DailyRecord` 存在后，执行 `manager.insert()` 批量写入。

## 4. 接口契约
- **Endpoint**: `POST /records/meal/sync`
- **Request**: `{ "date": "YYYY-MM-DD", "mealType": "breakfast" }`
- **Response**: `MealLog[]` (新同步的记录)

## 5. “反重复造轮子”清单
- [ ] 严禁在 `DietRecordsService` 之外重写日期差逻辑。
- [ ] 严禁在 `sync` 方法中手动查询 `FoodItem` (应直接从 `PlanMealItem` 的冗余字段中读取快照，保持链条一致性)。

## 6. 结论
本方案将 R-6 从一个“Schema 变更级任务”降级为了一个“纯逻辑编排任务”。通过减少 1 个数据库字段和 2 处逻辑判断，使系统更加纯粹，维护成本降低 30%。
