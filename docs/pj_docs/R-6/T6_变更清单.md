# T6 变更清单: R-6 快捷添加逻辑 (Quick Add)

## 1. 后端重构与实现 (Backend Implementation)

### 1.1 服务层扩展 (`diet-records.service.ts`)
- **逻辑复用**: 将 `getDateDiff` 保持为私有工具方法。
- **新增 `syncMealFromPlan(userId, date, mealType)`**:
    1. **获取计划**: 调用 `dietPlansService.findActivePlan(userId)`。
    2. **计算天数**: 依据 `date` 与 `startDate` 的偏移量计算 `dayNumber`。
    3. **提取模板**: 在 `activePlan.planDays` 中定位当日，并匹配对应 `mealType` 的食物列表。
    4. **开启事务**:
        - 调用 `getOrCreateDailyRecord` 确保总表存在。
        - **数据映射**: 将 `PlanMealItem` 字段映射至 `MealLog` (含 `baseCalories` 快照继承)。
        - **批量插入**: 使用 `manager.insert(MealLog, logs)` 提升性能。
    5. 返回同步成功的所有记录。

### 1.2 控制层并网 (`diet-records.controller.ts`)
- **新增 Endpoint**: `POST /records/meal/sync`
- **Body**: `{ date: string, mealType: string }`

## 2. 前端组件激活 (Frontend UI Activation)

### 2.1 更新 `HomeMealCard.vue`
- **恢复按钮**: 
    - 恢复“按计划记录”按钮 UI。
    - **逻辑**: 点击后调用 `syncMealFromPlan` API。
    - **视觉**: 显示加载态，成功后触发 `emit('refresh')` 全量更新。

## 3. 性能优化点 (Zero-IO Mapping)
- **强制约束**: 映射过程中禁止查询 `food_items` 表。所有营养素数据必须直接从 `PlanMealItem` 的冗余快照字段中提取，确保批量接口极速响应。

## 4. 验证计划 (Verification)
- **同步准确性**:
    - [ ] 验证同步后产生的 `MealLog` 是否准确继承了计划中的 `foodName` 和 `calories`。
- **并发与重复**:
    - [ ] 连续快速点击两次按钮，验证是否产生两组记录（符合增量添加预期）。
- **空态验证**:
    - [ ] 若计划中该餐次无食物，验证接口是否返回 200 及空数组，且不产生数据库写入。

## 5. 依赖
- 依赖 `DietPlansService` 提供的 `findActivePlan` 方法。
