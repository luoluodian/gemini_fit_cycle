# 用户模块 (User Module) - 原子任务拆解 (QA 细化版)

本文档为 QA 团队审计后的细化版本，旨在将任务拆解到可被单一、明确的测试手段验证的粒度。

---

### [TASK-USER-001]: 用户实体与数据库表创建

**(QA 审计: 通过。此任务定义清晰，目标单一。)**

**1. 任务背景 (Context)**
- **真理来源**: `@docs/init_docs/编码规范.md` (实体规范), `@docs/init_docs/页面功能详细说明文档.md` (登录功能)。
- **优先级**: P0
- **依赖项**: 无。

**2. 模块关联与契约 (Associations & Contract)**
- **Backend (fit_cycle_app)**: 
  - **文件**: `fit_cycle_app/src/database/entity/user.entity.ts`, `fit_cycle_app/src/database/entities.module.ts`
  - **逻辑**: 定义 `User` 实体类并注册到 ORM。
- **Frontend (fit_cycle_web)**: 无。

**3. 原子化施工步骤 (Implementation)**
- [ ] Backend: 新建 `user.entity.ts` 文件并定义 `User` 类的所有字段及 TypeORM 装饰器。
- [ ] Backend: 在 `entities.module.ts` 中导入并注册 `User` 实体。
- [ ] Backend: 通过数据库迁移或开发环境的 `synchronize` 功能，在数据库中物理创建 `users` 表。

**4. 校验机制 (Definition of Done - DoD)**
- **代码规范**: 符合 `@docs/init_docs/编码规范.md`。
- **验证命令**: `!cd fit_cycle_app && npm run build`
- **人工检查点**: 在数据库客户端中 `DESCRIBE users;`，确认表结构与实体定义完全一致。

---
### (原 TASK-USER-002 已被拆分)

### [TASK-USER-002.1]: 创建 User 服务及数据操作方法

**(QA 审计: 这是对原任务的第一次拆分，聚焦于数据库交互的逻辑层。)**

**1. 任务背景 (Context)**
- **真理来源**: `TASK-USER-002` 的一部分，需要一个服务来封装用户数据的增删改查。
- **优先级**: P0
- **依赖项**: `TASK-USER-001`

**2. 模块关联与契约 (Associations & Contract)**
- **Backend (fit_cycle_app)**: 
  - **文件**: `fit_cycle_app/src/modules/user/user.module.ts`, `fit_cycle_app/src/modules/user/user.service.ts`
  - **逻辑**: 创建 `UserService`，提供 `findOrCreateByOpenid` 方法，封装与 `User` 实体相关的数据库操作。
- **Frontend (fit_cycle_web)**: 无。

**3. 原子化施工步骤 (Implementation)**
- [ ] Backend: 创建 `user.module.ts`，在其中导入 `TypeOrmModule.forFeature([User])`。
- [ ] Backend: 创建 `user.service.ts`，注入 `UserRepository`。
- [ ] Backend: 在 `UserService` 中实现 `findOrCreateByOpenid(openid: string)` 方法。

**4. 校验机制 (Definition of Done - DoD)**
- **验证命令**: `!cd fit_cycle_app && npm run test -- src/modules/user/user.service.spec.ts`
- **人工检查点**: 必须为 `UserService` 编写单元测试，使用内存数据库或 Mock Repository 验证 `findOrCreateByOpenid` 方法在“找到用户”和“创建用户”两种场景下行为正确。

---

### [TASK-USER-002.2]: 实现 Auth 服务与 JWT 生成

**(QA 审计: 第二次拆分，聚焦于认证的核心逻辑和 Token 生成。)**

**1. 任务背景 (Context)**
- **真理来源**: `TASK-USER-002` 的核心部分，处理登录业务逻辑。
- **优先级**: P0
- **依赖项**: `TASK-USER-002.1`

**2. 模块关联与契约 (Associations & Contract)**
- **Backend (fit_cycle_app)**:
  - **文件**: `fit_cycle_app/src/modules/auth/auth.module.ts`, `fit_cycle_app/src/modules/auth/auth.service.ts`
  - **逻辑**: 创建 `AuthService`，注入 `UserService` 和 `JwtService`。实现 `login(code: string)` 方法，该方法完成 code 交换、调用 `UserService`、生成 JWT 的完整流程。
- **Frontend (fit_cycle_web)**: 无。

**3. 原子化施工步骤 (Implementation)**
- [ ] Backend: 创建 `auth.module.ts`，导入 `UserModule` 和 `JwtModule`。
- [ ] Backend: 创建 `auth.service.ts`。
- [ ] Backend: 在 `AuthService` 中实现 `login` 方法。对微信 API 的调用应被封装在一个可 Mock 的私有方法中。
- [ ] Backend: 在 `login` 方法中调用 `userService.findOrCreateByOpenid`。
- [ ] Backend: 使用 `jwtService.sign` 生成 token。

**4. 校验机制 (Definition of Done - DoD)**
- **验证命令**: `!cd fit_cycle_app && npm run test -- src/modules/auth/auth.service.spec.ts`
- **人工检查点**: 必须为 `AuthService.login` 方法编写单元测试，其中 `UserService` 和对外的 HTTP 请求都应被 Mock，确保测试只关注业务逻辑编排和 JWT 生成的正确性。

---

### [TASK-USER-002.3]: 创建 Auth Controller 并暴露接口

**(QA 审计: 第三次拆分，聚焦于将业务逻辑通过 API 暴露出去。)**

**1. 任务背景 (Context)**
- **真理来源**: `TASK-USER-002` 的收尾工作，提供 HTTP 入口。
- **优先级**: P0
- **依赖项**: `TASK-USER-002.2`

**2. 模块关联与契约 (Associations & Contract)**
- **Backend (fit_cycle_app)**:
  - **文件**: `fit_cycle_app/src/modules/auth/auth.controller.ts`
  - **路由**: `POST /auth/login`
- **Frontend (fit_cycle_web)**: 无。

**3. 原子化施工步骤 (Implementation)**
- [ ] Backend: 创建 `auth.controller.ts`。
- [ ] Backend: 在控制器中注入 `AuthService`。
- [ ] Backend: 创建一个 `login` 方法，使用 `@Post('login')` 和 `@Body` 装饰器，调用 `authService.login`。

**4. 校验机制 (Definition of Done - DoD)**
- **验证命令**: `!cd fit_cycle_app && npm run test:e2e -- test/auth.e2e-spec.ts`
- **人工检查点**: 必须为 `POST /auth/login` 编写一个 E2E 测试，使用 `supertest` 模拟 HTTP 请求，验证接口能返回 201 状态码和符合预期的响应体结构。

---
### (原 TASK-USER-003 和 TASK-USER-004 也进行类似细化)

### [TASK-USER-003.1]: 登录页静态 UI 开发

**1. 任务背景 (Context)**: 只关注视觉呈现，不含逻辑。
- **优先级**: P0, **依赖项**: 无。
- **Backend**: 无。
- **Frontend**: **文件**: `fit_cycle_web/src/pages/login/index.vue`, **逻辑**: 依据 UI/UX 设计稿，使用 `NutUI` 或 `TailwindCSS` 实现页面静态布局和样式。
- **施工步骤**: [ ] 创建 `.vue` 文件 -> [ ] 编写模板和样式 -> [ ] 在 `app.config.ts` 中注册页面。
- **DoD**: **验证**: `!cd fit_cycle_web && npm run dev:weapp`。**人工**: 在开发者工具中目视检查，UI 与设计稿保真度 > 95%。

### [TASK-USER-003.2]: 前端登录服务封装与调用

**1. 任务背景 (Context)**: 关注数据流与交互，剥离 UI。
- **优先级**: P0, **依赖项**: `TASK-USER-002.3`, `TASK-USER-003.1`。
- **Backend**: 无。
- **Frontend**: **文件**: `fit_cycle_web/src/services/modules/auth.ts`, `fit_cycle_web/src/pages/login/index.vue`。**逻辑**: 封装 API 请求，并在页面中调用。
- **施工步骤**: [ ] 创建 `auth.ts` 并封装 `login` API 请求 -> [ ] 在 `index.vue` 中引入并创建 `handleLogin` 方法 -> [ ] 在方法内实现 `Taro.login()` -> 调用 API -> 处理 `loading` 与 `error` Toast。
- **DoD**: **验证**: `!cd fit_cycle_web && npm run lint`。**人工**: 在开发者工具中点击登录，观察 Network 面板，确认 API 请求被正确发送，参数正确。

### [TASK-USER-004.1]: 创建 Pinia User Store

**1. 任务背景 (Context)**: 负责全局状态定义与管理。
- **优先级**: P0, **依赖项**: 无。
- **Backend**: 无。
- **Frontend**: **文件**: `fit_cycle_web/src/stores/user.ts`。**逻辑**: 定义 state (token, userInfo) 及 actions (setUserInfo, logout)。
- **施工步骤**: [ ] 创建 `user.ts` 文件 -> [ ] 使用 `defineStore` 定义 `useUserStore` -> [ ] 编写 state 和 actions。
- **DoD**: **验证**: `!cd fit_cycle_web && npm run test -- src/stores/user.spec.ts` (若有测试环境)。**人工**: 必须为 Store 编写单元测试（或在 DevTools 中手动验证），验证 action 能正确修改 state。

### [TASK-USER-004.2]: 集成 User Store 与路由守卫

**1. 任务背景 (Context)**: 将状态管理与页面导航结合，实现鉴权。
- **优先级**: P0, **依赖项**: `TASK-USER-003.2`, `TASK-USER-004.1`。
- **Backend**: 无。
- **Frontend**: **文件**: `fit_cycle_web/src/pages/login/index.vue`, `fit_cycle_web/src/router/hooks.ts`。**逻辑**: 登录成功后数据存入 Store；路由跳转前检查 Store 中 token。
- **施工步骤**: [ ] 修改登录页的成功回调，调用 `useUserStore` 的 action -> [ ] 在 `router/hooks.ts` 中创建路由前置钩子 -> [ ] 在钩子中检查 `useUserStore` 的 token，对需要授权的页面进行拦截和重定向。
- **DoD**: **人工检查点**: 1. 登录成功后，打开 Pinia DevTools 确认 `userStore` 数据正确。 2. 未登录时，URL 直接访问首页会被重定向到登录页。 3. 登录后刷新页面，用户状态应从持久化存储中恢复，无需再次登录。