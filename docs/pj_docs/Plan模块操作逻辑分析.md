# Plan æ¨¡å—æ“ä½œé€»è¾‘ä¸æµç¨‹åˆ†æ (Plan Module Operations & Logic)

æœ¬æ–‡æ¡£è¯¦ç»†æ‹†è§£äº† `fit_cycle` é¡¹ç›®ä¸­ Planï¼ˆé¥®é£Ÿè®¡åˆ’ï¼‰æ¨¡å—çš„æ“ä½œæµç¨‹ã€‚ä¸ºäº†æä¾›æœ€ç›´è§‚çš„å¼€å‘æŒ‡å—ï¼Œæœ¬æ–‡æ¡£é‡‡ç”¨äº† **ASCII UI çº¿æ¡†å›¾** æ¥æ¨¡æ‹ŸçœŸå®ç•Œé¢ï¼Œè¦†ç›–äº†ä»å…¥å£åˆ°æœ€ç»ˆé…ç½®å®Œæˆçš„æ¯ä¸€ä¸ªå…³é”®å±å¹•ä¸å¼¹çª—ã€‚

## 1. æ ¸å¿ƒæµç¨‹å›¾ (Core Flowchart)

```mermaid
graph TD
    A[UI-01: è®¡åˆ’åˆ—è¡¨é¡µ] -->|ç‚¹å‡»+å·/åˆ›å»ºæŒ‰é’®| B[UI-02: åˆ›å»ºé€‰é¡¹æ¨¡æ€æ¡†]
    B -->|é€‰æ‹©åˆ›å»ºæ–°è®¡åˆ’| C[UI-03: åŸºç¡€é…ç½®]
    B -->|é€‰æ‹©å¯¼å…¥| Z[UI-02-B: å¯¼å…¥å¼¹çª—]
    
    C -->|ç‚¹å‡»ä¸‹ä¸€æ­¥| D{åˆ¤æ–­è®¡åˆ’ç±»å‹}
    
    D -->|å¸¸è§„ (Custom)| E[åˆå§‹åŒ–æ—¥ç¨‹]
    D -->|ç¢³å¾ªç¯ (Carb Cycle)| F[UI-04: ç¢³å¾ªç¯è®¾ç½®]

    F -->|ç‚¹å‡»ä¸‹ä¸€æ­¥| G[ç®—æ³•ç”Ÿæˆæ—¥ç¨‹]
    
    E --> H[UI-05: æ¨¡æ¿åˆ—è¡¨]
    G --> H

    H -->|ç‚¹å‡»å•æ—¥å¡ç‰‡| I[UI-06: å•æ—¥è¯¦æƒ…ç¼–è¾‘]
    I -->|ç‚¹å‡»æ·»åŠ é¤é£Ÿ| J[UI-07: é¤é£Ÿé…ç½® (é€‰èœ)]
    
    J -->|ä¿å­˜| I
    I -->|ä¿å­˜| H
    H -->|ç‚¹å‡»ç¡®è®¤è®¡åˆ’| K[å®Œæˆ (Status: Configured)]
    K --> A
```

---

## 2. ç•Œé¢äº¤äº’è¯¦è§£ (UI & Interaction Detail)

### UI-01: è®¡åˆ’åˆ—è¡¨é¡µ (Plan List - Active State)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/plan/index.vue`*

```text
+---------------------------------------+
|  < [1]      é¥®é£Ÿè®¡åˆ’         [2] [â¬†]  | <-- [2] Uploader å›¾æ ‡ (ç»¿è‰²è¾¹æ¡†)
+---------------------------------------+
|  [ è¿›è¡Œä¸­ ]  å·²å®Œæˆ   å·²å½’æ¡£          | <-- Tabs
+---------------------------------------+
|                                       |
|  [3] è®¡åˆ’å¡ç‰‡ (PlanCard)              |
|  +---------------------------------+  |
|  |  ä¸‰å‘¨å‡è„‚è®­ç»ƒè¥             ... |  |
|  |  ç±»å‹: ç¢³å¾ªç¯ | å‰©ä½™: 12å¤©       |  |
|  |  ç›®æ ‡: 1800 kcal                  |  |
|  |  [ æŸ¥çœ‹è¯¦æƒ… ]   [ ç¼–è¾‘ ]         |  |
|  +---------------------------------+  |
|                                       |
|  +---------------------------------+  |
|  |  å¢è‚Œå†²åˆºé˜¶æ®µ               ... |  |
|  |  ç±»å‹: å¸¸è§„    | å‰©ä½™: 5å¤©        |  |
|  |  [ æŸ¥çœ‹è¯¦æƒ… ]   [ ç¼–è¾‘ ]         |  |
|  +---------------------------------+  |
|                                       |
+---------------------------------------+
```
*   **[2] åˆ›å»ºæŒ‰é’®**: ç‚¹å‡»è§¦å‘ `UI-02`ã€‚

---

### UI-01-B: è®¡åˆ’åˆ—è¡¨é¡µ (Empty State)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/plan/index.vue` > `EmptyPlanState.vue`*

```text
+---------------------------------------+
|  <          é¥®é£Ÿè®¡åˆ’             [â¬†]  |
+---------------------------------------+
|  [ è¿›è¡Œä¸­ ]  å·²å®Œæˆ   å·²å½’æ¡£          |
+---------------------------------------+
|                                       |
|           (æš‚æ— å›¾ç‰‡ Placeholder)      |
|                                       |
|           æš‚æ— è¿›è¡Œä¸­çš„è®¡åˆ’            |
|       å¼€å§‹åˆ¶å®šä½ çš„ä¸“å±é¥®é£Ÿç›®æ ‡        |
|                                       |
|      [4] åˆ›å»ºæ–°è®¡åˆ’ (ç»¿è‰²ä¸»æŒ‰é’®)      | <-- å±å¹•ä¸­å¿ƒæ˜¾çœ¼æŒ‰é’®
|                                       |
+---------------------------------------+
```
*   **[4] åˆ›å»ºæŒ‰é’®**: ç‚¹å‡»è§¦å‘ `UI-02` (ä¸ Navbar æŒ‰é’®é€»è¾‘ä¸€è‡´)ã€‚

---

### UI-02: åˆ›å»ºé€‰é¡¹æ¨¡æ€æ¡† (Create Options Modal)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/components/plan/CreateOptionsModal.vue`*

```text
(åŠé€æ˜é»‘è‰²é®ç½©å±‚)
+---------------------------------------+
|                                       |
|  å¼€å§‹ä½ çš„è®¡åˆ’                         |
|                                       |
|  +---------------------------------+  |
|  | [1] ğŸ“ åˆ›å»ºæ–°è®¡åˆ’               |  | <-- ä¸»æ“ä½œ
|  | é‡èº«å®šåˆ¶é€‚åˆä½ çš„é¥®é£Ÿæ–¹æ¡ˆ        |  |
|  +---------------------------------+  |
|                                       |
|  +---------------------------------+  |
|  | [2] ğŸ”— å¯¼å…¥åˆ†äº«è®¡åˆ’             |  | <-- æ¬¡æ“ä½œ
|  | ä½¿ç”¨æœ‹å‹æˆ–æ•™ç»ƒåˆ†äº«çš„å£ä»¤        |  |
|  +---------------------------------+  |
|                                       |
|  [3] å–æ¶ˆ                             |
+---------------------------------------+
```
*   **[1] åˆ›å»ºæ–°è®¡åˆ’**: è·³è½¬ `UI-03`ã€‚
*   **[2] å¯¼å…¥**: å¼¹å‡ºè¾“å…¥æ¡†è¾“å…¥ Share Code (UI-02-Bï¼Œç•¥)ã€‚

---

### UI-03: åŸºç¡€ä¿¡æ¯é…ç½® (Basic Info Wizard)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/plan-creator/index.vue`*

```text
+---------------------------------------+
|  < [1]      æ–°å»ºé¥®é£Ÿè®¡åˆ’              |
+---------------------------------------+
|                                       |
|  è®¡åˆ’åç§° *                           |
|  [ [2] è¯·è¾“å…¥è®¡åˆ’åç§°...            ] |
|                                       |
|  è®¡åˆ’ç±»å‹                             |
|  +---------------------------------+  |
|  | [3] å¸¸è§„ (Custom)           ( ) |  | <-- ç™½è‰²èƒŒæ™¯, é€‰ä¸­å˜ç»¿
|  | è‡ªç”±é…ç½®æ¯æ—¥çƒ­é‡ä¸è¥å…»ç´         |  |
|  +---------------------------------+  |
|  +---------------------------------+  |
|  | [4] ç¢³å¾ªç¯ (Carb Cycle)     (o) |  | <-- å¸¦"è¿›é˜¶"æ ‡ç­¾
|  | é«˜/ä¸­/ä½ç¢³å¾ªç¯æ³¢åŠ¨              |  |
|  +---------------------------------+  |
|                                       |
|  å‘¨æœŸè®¾ç½®                             |
|  [5] å‘¨æœŸå¤©æ•°: [ 7 ]                  |
|  [6] å‘¨æœŸæ•°é‡: [ 3 ]  (æ€»è®¡21å¤©)      |
|                                       |
+---------------------------------------+
|  [7] å–æ¶ˆ          [8] ä¸‹ä¸€æ­¥         | <-- åº•éƒ¨å›ºå®šæ 
+---------------------------------------+
```
*   **[8] ä¸‹ä¸€æ­¥**:
    *   å¸¸è§„ -> è·³è½¬ `UI-05`ã€‚
    *   ç¢³å¾ªç¯ -> è·³è½¬ `UI-04`ã€‚

---

### UI-04: ç¢³å¾ªç¯è®¾ç½® (Carb Cycle Setup)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/carb-cycle-setup/index.vue`*

```text
+---------------------------------------+
|  < [1]      ç¢³å¾ªç¯è®¾ç½®                |
+---------------------------------------+
|  [2] å½“å‰ä½“é‡: [ 70.0 ] kg            |
+---------------------------------------+
|  [3] è¥å…»ç´ é…æ¯” (g/kg)                |
|  [ ğŸ— 2.0 ] [ âš¡ 3.0 ] [ ğŸ¥‘ 0.8 ]      |
+---------------------------------------+
|  é˜¶æ®µåˆ†é… (Phase Cards)               |
|  +---------------------------------+  |
|  | [4] ğŸ”¥ é«˜ç¢³æ—¥ (High)            |  |
|  | å¤©æ•°: [ 1 ]   ç³»æ•°: [ 1.5 ]      |  |
|  | é¢„è§ˆ: 300g ç¢³æ°´ | 2800 kcal      |  |
|  +---------------------------------+  |
|  +---------------------------------+  |
|  | [5] âš–ï¸ ä¸­ç¢³æ—¥ (Medium)          |  |
|  | å¤©æ•°: [ 1 ]   ç³»æ•°: [ 1.0 ]      |  |
|  +---------------------------------+  |
|  +---------------------------------+  |
|  | [6] â„ï¸ ä½ç¢³æ—¥ (Low)             |  |
|  | å¤©æ•°: [ 1 ]   ç³»æ•°: [ 0.5 ]      |  |
|  +---------------------------------+  |
|                                       |
|  [7] çŠ¶æ€æ¡: âš ï¸ è¿˜éœ€é…ç½® 4 å¤© (é»„è‰²)  | <-- å®æ—¶è®¡ç®—çŠ¶æ€
+---------------------------------------+
|  [8] ä¸Šä¸€æ­¥        [9] ä¸‹ä¸€æ­¥         |
+---------------------------------------+
```
*   **[9] ä¸‹ä¸€æ­¥**: ä»…å½“ [7] ä¸ºç»¿è‰²(å¹³è¡¡)æ—¶å¯ç”¨ã€‚ç‚¹å‡»è§¦å‘ç®—æ³•ç”Ÿæˆæ•°æ®ã€‚

---

### UI-05: æ—¥æ¨¡æ¿åˆ—è¡¨ (Template List)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/plan-templates/index.vue`*

```text
+---------------------------------------+
|  < [1]      é…ç½®æ—¥æ¨¡æ¿                |
+---------------------------------------+
|  æ‘˜è¦å¡ç‰‡ (Header)                    |
|  [ å‡è„‚è®¡åˆ’ | 7å¤© x 3å‘¨æœŸ ]           |
|  è¿›åº¦: 3 / 7                          |
|  [ â— é«˜ç¢³ 1 ] [ â— ä¸­ç¢³ 1 ] ...        |
+---------------------------------------+
|  æ—¥æ¨¡æ¿åˆ—è¡¨ (List)                    |
|  +---------------------------------+  |
|  | [3] ç¬¬ 1 å¤©  [ ğŸ”¥ é«˜ç¢³ ]        |  | <-- ç‚¹å‡»åŒºåŸŸ
|  | [ âš¡ 2500 ] [ ğŸ— 180 ] ...        |  |
|  |                    [4] â‹® (èœå•) |  | <-- é•¿æŒ‰/ç‚¹å‡»èœå•
|  +---------------------------------+  |
|  +---------------------------------+  |
|  | [5] ç¬¬ 2 å¤©  [ âš–ï¸ ä¸­ç¢³ ]        |  |
|  +---------------------------------+  |
|  ...                                  |
|                                       |
|  [6] + æ–°å¢æ—¥æ¨¡æ¿ (å¤§æŒ‰é’®)            |
+---------------------------------------+
|  [7] ä¸Šä¸€æ­¥        [8] ç¡®è®¤è®¡åˆ’       |
+---------------------------------------+
```
*   **[3] å•æ—¥å¡ç‰‡**: ç‚¹å‡»è·³è½¬ `UI-06`ã€‚
*   **[8] ç¡®è®¤è®¡åˆ’**: æäº¤æœ€ç»ˆé…ç½®ï¼Œç»“æŸæµç¨‹ã€‚

---

### UI-06: å•æ—¥è¯¦æƒ…ç¼–è¾‘ (Day Detail Edit)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/edit-template/index.vue`*

```text
+---------------------------------------+
|  < [1]      ç¼–è¾‘ç¬¬ 1 å¤©               |
+---------------------------------------+
|  æ¨¡æ¿åç§°: [ [2] ç»ƒè…¿æ—¥    ] 3/6      |
+---------------------------------------+
|  [3] è¥å…»æ‘„å…¥è¿›åº¦ç¯ (NutritionRing)   |
|      [ 1800 / 2500 kcal ]             |
|      P: 80%  C: 50%  F: 30%           |
+---------------------------------------+
|  é¤å•é…ç½® (Meal List)                 |
|  +---------------------------------+  |
|  | [4] æ—©é¤ (Breakfast)            |  |
|  | - ç‡•éº¦ç‰‡ 50g           [x] åˆ é™¤ |  |
|  | - é¸¡è›‹ 2ä¸ª             [x] åˆ é™¤ |  |
|  | [5] + æ·»åŠ /ç¼–è¾‘é¤é£Ÿ             |  | <-- ç‚¹å‡»è·³è½¬ UI-07
|  +---------------------------------+  |
|  +---------------------------------+  |
|  |     åˆé¤ (Lunch)                |  |
|  |     (æš‚æ— é£Ÿç‰©)                  |  |
|  | [ + æ·»åŠ /ç¼–è¾‘é¤é£Ÿ ]             |  |
|  +---------------------------------+  |
|                                       |
|  [6] + æ–°å¢è‡ªå®šä¹‰é¤æ¬¡                 |
+---------------------------------------+
|  [7] å–æ¶ˆ          [8] ä¿å­˜é…ç½®       |
+---------------------------------------+
```
*   **[5] æ·»åŠ /ç¼–è¾‘é¤é£Ÿ**: ç‚¹å‡»è·³è½¬ `UI-07`ï¼Œå¹¶å°†å½“å‰æ¨¡æ¿æ•°æ®ä¼ å…¥ Storeã€‚

---

### UI-07: é¤é£Ÿé…ç½®/é€‰èœ (Meal Configuration)
*æ–‡ä»¶è·¯å¾„: `fit_cycle_web/src/pages/meal-config/index.vue`*

```text
+---------------------------------------+
|  < [1]      é…ç½®æ—©é¤                  |
+---------------------------------------+
|  [2] ğŸ” æœç´¢é£Ÿç‰©...                   |
+---------------------------------------+
|  [ å¸¸è§ ]  [ æ”¶è— ]  [ è‡ªå®šä¹‰ ]       | <-- Tabs
+---------------------------------------+
|  é£Ÿç‰©åˆ—è¡¨ (Food List)                 |
|  +---------------------------------+  |
|  | ğŸ¥£ ç‡•éº¦ç‰‡ (ç”Ÿ)                  |  |
|  | 370 kcal/100g                   |  |
|  | [3] -  [ 50 ]  [ + ]  g         |  | <-- æ­¥è¿›å™¨
|  +---------------------------------+  |
|  +---------------------------------+  |
|  | ğŸ¥š é¸¡è›‹ (å…¨è›‹)                  |  |
|  | 140 kcal/100g                   |  |
|  | [4] [ + æ·»åŠ  ]                  |  | <-- æœªæ·»åŠ çŠ¶æ€
|  +---------------------------------+  |
|                                       |
+---------------------------------------+
|  è´­ç‰©è½¦/åº•éƒ¨æ                         |
|  [5] å·²é€‰: 3 é¡¹ | æ€»çƒ­é‡: 450 kcal    |
|  [       [6] ç¡®è®¤æ·»åŠ  (3)        ]    | <-- ç»¿è‰²å¤§æŒ‰é’®
+---------------------------------------+
```
*   **[6] ç¡®è®¤æ·»åŠ **: å°†é€‰ä¸­çš„é£Ÿç‰©åˆ—è¡¨å›å†™åˆ° Store çš„å½“å‰æ¨¡æ¿ä¸­ï¼Œå¹¶è¿”å› `UI-06`ã€‚

---

## 3. å…³é”®æ•°æ®ç»“æ„æ˜ å°„ (Data Model Mapping)

### Store (`planStore.draft`)
è¯¥å¯¹è±¡è´¯ç©¿ **UI-03** åˆ° **UI-04**ã€‚

```typescript
{
  name: string,          // UI-03 [2]
  type: 'custom' | 'carb-cycle', // UI-03 [3][4]
  cycleDays: number,     // UI-03 [5]
  carbCycleConfig: {     // UI-04 æ ¸å¿ƒæ•°æ®
    weight: number,      // UI-04 [2]
    baseRatios: { protein, carbs, fat }, // UI-04 [3]
    phases: {
      high: { days, proteinRatio... },   // UI-04 [4]
      medium: { ... },                   // UI-04 [5]
      low: { ... }                       // UI-04 [6]
    }
  }
}
```

### Template (`PlanDay`)
è¯¥å¯¹è±¡åœ¨ **UI-05** å’Œ **UI-06** ä¸­æµè½¬ã€‚

```typescript
{
  dayNumber: number,     // UI-05 æ˜¾ç¤ºé¡ºåº
  carbType: string,      // UI-05 å¡ç‰‡é¢œè‰²æ¥æº ('high'/'medium'/'low')
  targetCalories: number,// UI-06 [3] ç›®æ ‡å€¼
  meals: {               // UI-06 [4] æ•°æ®æº
    breakfast: [ { name, calories... } ], // UI-07 ç”Ÿæˆçš„æ•°æ®
    lunch: [],
    ...
  }
}
```

## 4. å¼€å‘èµ„æºç´¢å¼• (Dev Resources)

*   **ç®—æ³•å®ç°**: `fit_cycle_web/src/utils/carb-cycle-algo.ts`
*   **å¡ç‰‡ç»„ä»¶**: `fit_cycle_web/src/components/common/GlassCard.vue`
*   **é˜¶æ®µç»„ä»¶**: `fit_cycle_web/src/components/carb-cycle-setup/PhaseCard.vue`
*   **API æœåŠ¡**: `fit_cycle_web/src/services/plan.ts`