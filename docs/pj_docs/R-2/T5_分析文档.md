# T5 分析文档: R-2 每日记录接口 (Record API)

## 1. 任务背景 (Task Background)
任务 **R-2** 旨在实现饮食记录域的核心查询接口。该接口是首页“每日仪表盘”的数据源，必须具备幂等性，能够在查询时自动处理当日目标的初始化。

## 2. 接口契约分析 (Interface Contract)
- **Endpoint**: `GET /records/:date`
- **Params**: `date` (YYYY-MM-DD)
- **Response**: 
    ```typescript
    {
      code: 200,
      data: {
        record: DailyRecord, // 包含 targetCalories, targetProtein 等
        meals: MealLog[]     // 具体的餐次食物明细
      },
      message: 'Success'
    }
    ```

## 3. 核心业务逻辑 (Core Business Logic)

### 3.1 "Get or Create" 逻辑流程
1.  **查询**: 检查 `daily_records` 表是否存在 `userId` + `date` 的记录。
2.  **命中**: 若存在，联查 `meal_logs` 列表，返回数据。
3.  **未命中 (初始化)**:
    - 查找用户当前处于 `active` 状态的计划 (`diet_plans.status = 'active'`)。
    - **逻辑 A (有计划)**:
        - 根据 `date` 计算在计划周期中的 `dayNumber`。
        - 从 `plan_days` 获取对应的目标快照。
    - **逻辑 B (无计划)**:
        - 使用用户 `health_profiles` 中的 BMR/TDEE 作为默认目标。
    - **落库**: 创建并保存 `DailyRecord` 实体。
    - **返回**: 返回新生成的记录（明细为空）。

### 3.2 依赖逻辑 (Dependencies)
- **计划关联**: 需要调用 `DietPlansService.getActivePlan(userId)`。
- **日期计算**: 需要精确处理 `startDate` 与目标 `date` 的偏移量，以确定 `dayNumber`。

## 4. 实现方案要点 (Implementation Plan)

### 4.1 控制层 (Controller)
- 使用 `@Controller('records')`。
- 实现 `@Get(':date')` 方法，并使用 `ParseDatePipe` (自定义) 校验日期格式。

### 4.2 服务层 (Service)
- `findByDate(userId: number, date: string)`: 执行上述 Get-or-Create 逻辑。
- 使用 TypeORM 的 `Transaction` 确保初始化过程的原子性。

## 5. 潜在风险与对策 (Risks & Mitigations)
- **日期偏移越界**: 若用户计划只有 7 天但正在记录第 8 天，逻辑需支持“循环计算”（如 `(dayOffset % cycleDays) + 1`）。
- **性能**: `DailyRecord` 与 `MealLog` 的联查建议使用 `relations: ['meals']` 或 `QueryBuilder`。

## 6. 结论 (Conclusion)
R-2 的难点在于**目标的自动初始化**。通过复用 Plan 模块的配置并辅以健康档案兜底，可以确保用户无论何时进入记录页都有明确的进度环目标。
