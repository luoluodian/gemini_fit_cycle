# P-7 碳循环核心算法 分析报告

## 1. 业务目标 (Business Goal)
实现碳循环计划的核心营养素分配算法。该算法根据用户的体重、基准营养素比例（每kg体重摄入量）以及高/中/低碳阶段的权重系数，精确计算出周内每一天的营养素（蛋白质、脂肪、碳水）和总热量目标。

## 2. 核心逻辑分析 (Logic Analysis) - 参考 `carb-cycle-setup.html`

### 2.1 基础公式与舍入准则
1.  **周期总营养素计算**:
    - `周期总蛋白质 (Total P) = 体重 * 基准蛋白系数 (g/kg) * 周期天数`
    - `周期总碳水 (Total C) = 体重 * 基准碳水系数 (g/kg) * 周期天数`
    - `周期总脂肪 (Total F) = 体重 * 基准脂肪系数 (g/kg) * 周期天数`

2.  **分配权重计算**:
    - 对于每种营养素，计算三个阶段的系数总和 (`Ratio Sum`)。
    - `Sum = High_Ratio + Medium_Ratio + Low_Ratio`

3.  **每日阶段分配 (重点优化)**:
    - **克数优先**: `阶段日均营养素 (Grams) = Math.round((周期总营养素 / Ratio Sum) * 阶段系数 / 该阶段天数)`
    - **热量对齐**: 必须使用取整后的克数计算热量，确保 UI 显示一致性。
    - `Calories = Protein_Grams * 4 + Carbs_Grams * 4 + Fat_Grams * 9`

### 2.2 逻辑约束与序列生成 (新增)
- **天数一致性校验**: 增加 `isBalanced` 标识。若 `高碳天数 + 中碳天数 + 低碳天数 !== 周期天数`，输出应标记为失衡并锁定下一步。
- **自动化序列生成**: 算法输出需包含一个长度等于 `cycleDays` 的数组 `sequence`，按 `High -> Medium -> Low` 顺序填充具体的营养目标对象，直接用于 Step 2 模板初始化。

## 3. 技术方案 (Technical Solution)

### 3.1 算法实现
在 `fit_cycle_web/src/utils/carb-cycle-algo.ts` 中封装纯函数 `calculateCarbCycleDistribution`。

### 3.2 数据结构定义
```typescript
export interface PhaseConfig {
  days: number;
  proteinRatio: number;
  carbRatio: number;
  fatRatio: number;
}

export interface BaseRatios {
  protein: number;
  carbs: number;
  fat: number;
}

export interface PhaseResult {
  type: 'high' | 'medium' | 'low';
  protein: number;
  carbs: number;
  fat: number;
  calories: number;
}

export interface CarbCycleInput {
  weight: number;
  cycleDays: number;
  baseRatios: BaseRatios;
  phases: Record<'high' | 'medium' | 'low', PhaseConfig>;
}

export interface CarbCycleOutput {
  isBalanced: boolean;
  summary: {
    totalProtein: number;
    totalCarbs: number;
    totalFat: number;
    totalCalories: number;
  };
  phaseResults: Record<'high' | 'medium' | 'low', PhaseResult>;
  sequence: PhaseResult[];
}
```

### 3.3 应用场景
- **实时预览**: `carb-cycle-setup` 页面用户输入时实时调用展示。
- **模板生成**: 点击“下一步”后，`planStore` 调用此算法将结果填充至 `draft.templates`。

## 4. 验收标准 (Acceptance Criteria)
- [ ] 算法输出与 `carb-cycle-setup.html` 原型中的计算结果（克数部分）完全一致。
- [ ] 确保 `Calories === P*4 + C*4 + F*9` 在任何阶段都成立。
- [ ] 输入异常值（如体重 0）时，输出应为 0 或有合法容错。
- [ ] 逻辑需通过单元测试验证。