# 原子任务清单：用户注册与登录 (Vertical Slice)

本文档使用垂直切片法，将“用户注册与登录”功能拆分为一个包含前后端修改的、可独立交付和验证的闭环任务。

---

### [LOGIN-V-SLICE-01]: 实现基于微信的完整登录流程

**[ID]**: `LOGIN-V-SLICE-01`

**[Scope]**:

- **[Backend]**: `fit_cycle_app`
  - `auth.controller.ts`: 创建 `POST /auth/login` 端点。
  - `auth.service.ts`: 实现接收微信 `code`、换取 `openid`、查找或创建用户、生成 JWT 的核心逻辑。
  - `user.service.ts`: 提供 `findOrCreateByOpenid` 方法。
  - `user.entity.ts`: 定义用户模型。
- **[Frontend]**: `fit_cycle_web`
  - `/pages/login/index.vue`: 创建登录页面 UI，并实现调用 `Taro.login()` 获取 `code`并发起后端请求的交互逻辑。
  - `/stores/user.ts`: 创建 Pinia store，用于存储 `token` 和用户信息。
  - `/router/hooks.ts`: 创建路由守卫，实现未登录则跳转登录页的逻辑。

**[Contract Preview]**:

- **Endpoint**: `POST /auth/login`
- **Request**: `{ "code": "string" }`
- **Response**: `{ "token": "string", "user": UserDto }`

**[State Changes]**:

- **系统状态**: `Unauthenticated` -> `Authenticated`。
- **用户会话**: 用户首次登录时，在 `users` 表中创建一条新记录。
- **前端状态**: `Pinia userStore` 中的 `token` 和 `userInfo` 从 `null` 变为有效值。

**[DoD] (Definition of Done)**:

- **物理验证命令**: `!cd fit_cycle_app && npm run test:e2e -- test/auth.e2e-spec.ts`
- **验证描述**: 该 E2E 测试脚本应覆盖以下场景：
  1. 模拟一个无效 `code` 请求 `/auth/login`，断言返回 400 或 401 错误。
  2. 模拟一个有效 `code` 请求，断言返回 201 状态码以及包含 `token` 和 `user` 信息的响应体。
  3. 前端手动验证：从未登录状态访问首页，应被重定向至登录页；完成登录后，能成功进入首页，且浏览器的应用存储中能找到 `token`。

---
