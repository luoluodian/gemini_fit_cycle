# T5 分析文档: I-4.5 计划占位与变色逻辑 - V2 增强版

## 1. 任务背景 (Task Background)
任务 **I-4.5** 通过将“计划”与“记录”在 UI 层深度融合，实现饮食管理的“任务化”。本版本重点解决了跨日期切换时的计划对齐问题，并确立了“幽灵态”与“实态”的转换规则。

## 2. 三态识别系统 (Three-State System)

首页餐次列表中的每一项食物将处于以下三种状态之一：

| 状态 | 定义 | 视觉表现 | 交互 |
| :--- | :--- | :--- | :--- |
| **Ghost (幽灵)** | 计划中有，但记录中无 | 灰色背景、虚线边框、60% 透明度 | 点击弹出数量确认，一键转为真实记录 |
| **Completed (达成)** | 计划中有，且记录中有 (`isPlanned: true`) | 浅绿色背景、实线边框、深绿文字 | 支持编辑数量或删除（删除后回退为 Ghost） |
| **Custom (手动)** | 计划中无，用户自行添加 | 纯白/默认背景、标准边框 | 标准编辑与删除交互 |

## 3. 核心驱动逻辑 (Data Driving)

### 3.1 跨 Store 差分算法
`MealCard.vue` 必须动态订阅两个 Store：
- **Record**: `recordsCache` (当前日期的真实摄入)。
- **Plan**: `getActivePlan` -> 转换日期为 `dayNumber` -> 提取对应餐次的模板项。

### 3.2 动态日期对齐
- **逻辑**: 当 `currentDate` 变化时，除了触发 `fetchRecord`，必须同步更新“计划影子”。
- **公式**: `targetDayNum = (dayDiff(currentDate, plan.startDate) % cycleDays) + 1`。

## 4. 结论
V2 版 T5 确立了以“计划为模板，记录为增量”的混合渲染模式。通过三态视觉区分，用户能一眼看清“计划内完成情况”与“计划外额外摄入”。