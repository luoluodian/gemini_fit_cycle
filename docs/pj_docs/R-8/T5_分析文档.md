# T5 分析文档: R-8 营养统计计算 (Nutrition Logic)

## 1. 任务背景 (Task Background)
任务 **R-8** 旨在为前端建立统一的营养摄入计算中枢。目前热量统计逻辑分散在各个 UI 组件中，缺乏统一的状态管理，导致跨页面交互时（如添加记录后返回首页）数据同步滞后。

## 2. 现状分析与优化方向 (Current State & Gap)
- **现状**: 首页 (R-4) 使用局部 `computed` 计算，其他页面无法访问。
- **优化点**: 
    - 建立 `useRecordStore`。
    - 将“聚合计算”逻辑下沉至 Store 层。
    - 实现基于日期索引的记录缓存，提升跨天切换速度。

## 3. 核心计算模型 (Calculation Model)

### 3.1 聚合算法 (Aggregation)
对当前加载的 `MealLog[]` 进行单次遍历求和：
```typescript
{
  totalCalories: sum(item.calories),
  totalProtein: sum(item.protein),
  totalFat: sum(item.fat),
  totalCarbs: sum(item.carbs)
}
```

### 3.2 达成率算法 (Achievement Rate)
将聚合结果与 `DailyRecord` 中的快照目标进行对比：
- `ratio = (consumed / target) * 100`
- **边界防御**: 若 `target` 为 0 或 null，返回 0，防止除以零异常。

## 4. 技术实现要点 (Implementation)

### 4.1 Pinia Store 设计 (`stores/record.ts`)
- **State**:
    - `currentRecord`: 存储当天的 `DailyRecord` 快照。
    - `mealLogs`: 存储当天的明细数组。
- **Getters**:
    - `summary`: 返回上述聚合对象（实时响应）。
    - `remaining`: 计算剩余可摄入额度 (`target - consumed`)。
- **Actions**:
    - `refreshRecord(date)`: 封装 API 调用并更新状态。

### 4.2 精度控制规约
- **热量 (kcal)**: 统一使用 `Math.round()` 取整。
- **营养素 (g)**: 统一保留一位小数 `.toFixed(1)` 展示，但 Store 内部保留四位小数进行累加。

## 5. 潜在风险与过度优化审计 (Risks & Audit)
- **过度优化风险**: 在前端实现复杂的“图表趋势计算”属于 Analysis 模块，R-8 应仅关注 **“当日统计”**。
- **重复造轮子**: 严禁引入第三方数学库（如 bignumber.js），原生浮点数运算配合 `Math.round` 足以支撑 0.1g 级别的精度需求。

## 6. 结论 (Conclusion)
R-8 不是一个 UI 任务，而是一个 **“逻辑归口”** 任务。通过在 Store 层锁定统计口径，系统将具备真正的实时响应式反馈能力，为用户提供准确的摄入反馈。
