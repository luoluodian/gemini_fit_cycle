# T6 变更清单: R-8 营养统计计算 (Nutrition Logic)

## 1. 状态模型重构 (State Management)

### 1.1 建立 `useRecordStore`
- **文件**: `fit_cycle_web/src/stores/record.ts`
- **State 定义**:
    - `currentRecord`: `DailyRecord | null` (存储当日总表快照)。
    - `mealLogs`: `MealLog[]` (存储当日摄入明细)。
    - `loading`: `boolean` (全局加载状态)。
- **Actions 实现**:
    - `setRecordData(data: RecordInfoResponse)`: 批量更新 State。
    - `clearRecord()`: 重置状态，防止跨天数据污染。

### 1.2 实现派生计算 (Getters)
- **`totalConsumed`**: 
    - 逻辑: 对 `mealLogs` 执行 `reduce`。
    - 精度: 
        - `calories`: `Math.round(val)`。
        - `macros`: `Number(val.toFixed(4))` (内部精度)。
- **`nutritionRatios`**:
    - 逻辑: 计算 P/F/C 达成百分比。
    - 安全: 若 `target` 为 0，百分比返回 0。

## 2. 逻辑组合式封装 (Composables)

### 2.1 建立 `useNutritionStats`
- **文件**: `fit_cycle_web/src/composables/useNutritionStats.ts`
- **功能**: 
    - 封装从 `recordStore` 导出的响应式引用。
    - 提供 `formattedStats` 格式化工具，将数值转换为 `"12 / 100g"` 等展示字符串。

## 3. 首页逻辑平移 (Refactoring index.vue)

### 3.1 移除冗余逻辑
- **删除**: 首页本地的 `nutritionConsumed` 计算属性。
- **删除**: 首页本地的 `recordInfo` 状态。
- **替换**: 改为订阅 `recordStore` 的 `summary` 与 `currentRecord`。

### 3.2 数据流并网
- 修改 `loadData` 方法，内部调用 `recordStore.setRecordData(res)`，不再操作局部变量。

## 4. 验证计划 (Verification)
- **计算一致性**:
    - [ ] 验证首页进度环数值与餐次卡片总和在点击切换日期后依然完全匹配。
- **精度验证**:
    - [ ] 连续添加 3 项 0.33g 蛋白质的食物，验证总计显示为 "1.0g" 而非 "0.9g" 或 "0.999g"。
- **并发状态**:
    - [ ] 快速切换日期时，验证旧日期的计算属性是否立即销毁，无数据闪烁。

## 5. 结论 (Conclusion)
通过将统计逻辑从 View 层剥离至 Store 层，R-8 完成了 fit_cycle 记录域的“大脑”建设。这不仅消除了首页的逻辑负担，更为后续所有涉及营养展示的页面提供了零成本的接入方案。
