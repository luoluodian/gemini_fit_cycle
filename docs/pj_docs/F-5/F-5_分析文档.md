# F-5: 自定义食材 API - T5 分析文档

> **任务 ID**: F-5  
> **任务名称**: 自定义食材 API  
> **优先级**: P1  
> **垂直拆分**: 后端 API  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `food_items`: 存储自定义食材。

### 涉及跨模块 Service
- `FoodItemsService`: 负责业务逻辑实现。

### 所有关联模块
- `Auth`: 需要 JWT 认证。
- `User`: 关联创建者。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/modules/food-items/food-items.service.ts`: 确认 `create`, `update`, `delete` 方法。
- [x] `fit_cycle_app/src/modules/food-items/food-items.controller.ts`: 确认接口暴露。

### 对现有功能的影响
- [x] **无影响**: 核心逻辑已在 F-1/F-2 重构期间预先实现，本次任务为正式验收与补全文档。

---

## 5.3 技术落地计划

### 1. 业务逻辑确认

#### 创建食材 (`create`)
- 验证名称唯一性。
- 设置 `type = FoodType.CUSTOM`。
- 绑定当前登录用户的 `userId`。

#### 更新食材 (`update`)
- 仅允许创建者修改。
- 验证修改后的名称唯一性（排除自身）。

#### 删除食材 (`delete`)
- 仅允许创建者删除。
- 执行物理删除（Repository.remove）或后续按需改为软删除。目前实体支持 `deletedAt`，应优先使用软删除。

### 2. 接口契约确认

**POST /food-items**
- Body: `CreateFoodItemDto`
- Resp: `FoodItem`

**PUT /food-items/:id**
- Param: `id`
- Body: `UpdateFoodItemDto`
- Resp: `FoodItem`

**DELETE /food-items/:id**
- Param: `id`
- Resp: `{ success: true }`

### 3. 数据流向

```
Frontend -> JWT Guard -> Controller -> Service -> DB (FoodItem)
```

---

## 5.4 风险点清单

- [ ] **权限绕过**: 确保 `update` 和 `delete` 严格检查 `item.userId === req.user.userId`。
  - 应对: Service 中已包含该逻辑。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/modules/food-items/food-items.service.ts` (逻辑确认)
- `fit_cycle_app/src/modules/food-items/food-items.controller.ts` (接口确认)

### 文档交付物
- T6~T9 全套文档。

---

## 5.6 自检清单
- [x] 支持创建者绑定
- [x] 支持权限校验
- [x] 支持唯一性冲突处理
- [x] 对齐 DTO 定义

---

## 5.7 下一步行动
1. **立即执行**: 确认并补全单元测试覆盖。
2. **立即执行**: 进入 T6 确立基准。
