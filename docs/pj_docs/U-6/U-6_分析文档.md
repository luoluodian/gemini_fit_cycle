# U-6: BMR 计算逻辑 - T5 分析文档

> **任务 ID**: U-6  
> **任务名称**: BMR 计算逻辑  
> **优先级**: P1  
> **垂直拆分**: 后端 Logic  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `health_profiles`: 存储计算所需的身体参数（身高、体重、年龄、性别、活动系数）以及计算结果（BMR、TDEE）。

### 涉及公共组件
- 无 (后端 Logic 任务)

### 涉及跨模块 Service
- `UserService`: 包含计算 BMR/TDEE 的核心逻辑。

### 所有关联模块
- `User`: 用户更新个人档案时自动触发计算。
- `Analysis`: 后续统计分析可能需要用到 BMR/TDEE 作为基准。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/modules/user/user.service.ts`: 验证并增强 `calculateHealthMetrics` 私有方法。

### 对现有功能的影响
- [x] **无影响**: 计算逻辑属于内部服务方法，不改变外部调用接口。

### 必须参考的文件路径
- `docs/init_docs/业务逻辑文档.md`: 包含核心计算公式（Mifflin-St Jeor）。

### 潜在的破坏性变更
- [x] **无破坏性变更**

---

## 5.3 技术落地计划

### 1. 核心逻辑确认 (根据业务逻辑文档 5.1.4)

#### BMR 计算 (Mifflin-St Jeor 公式)
- **男性**: $10 \times \text{体重(kg)} + 6.25 \times \text{身高(cm)} - 5 \times \text{年龄} + 5$
- **女性**: $10 \times \text{体重(kg)} + 6.25 \times \text{身高(cm)} - 5 \times \text{年龄} - 161$

#### TDEE 计算
- $\text{TDEE} = \text{BMR} \times \text{活动系数}$

#### 活动系数映射表
- 1.2: 久坐 (办公室工作)
- 1.375: 轻度活动 (每周1-3次运动)
- 1.55: 中度活动 (每周3-5次运动)
- 1.725: 高度活动 (每周6-7次运动)
- 1.9: 极高活动 (体力劳动者或专业运动员)

### 2. 代码实现方案 (UserService)

```typescript
private calculateHealthMetrics(profile: HealthProfile): void {
  const { weight, height, birthday, gender, activityLevel } = profile;
  
  if (weight && height && birthday && gender) {
    // 1. 计算年龄 (按年份差)
    const age = new Date().getFullYear() - new Date(birthday).getFullYear();
    
    // 2. 计算 BMR
    let bmr = 10 * Number(weight) + 6.25 * Number(height) - 5 * age;
    bmr += (gender === 'male' ? 5 : -161);
    
    // 3. 计算 TDEE
    const tdee = bmr * Number(activityLevel || 1.2);
    
    // 4. 更新实体字段
    profile.bmr = Math.round(bmr);
    profile.tdee = Math.round(tdee);
  }
}
```

### 3. 数据流向

```
User Input (身高/体重/生日/性别/系数) -> UserService.updateMe -> calculateHealthMetrics -> Save to DB
```

### 4. 依赖任务检查

- [x] 依赖任务 `U-9` (User 实体定义) 已完成。

---

## 5.4 风险点清单

### 技术风险
- [ ] **年龄计算精确度**: 当前按年份差计算，若用户生日未过可能存在 1 岁的误差。
  - 应对措施: 在 MVP 阶段接受年份差计算，后续优化为按具体日期计算。
- [ ] **数据类型转换**: `decimal` 字段从 DB 读取后在 TS 中可能是 string 或 number。
  - 应对措施: 使用 `Number()` 强制转换以确保计算正确。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/modules/user/user.service.ts`: `calculateHealthMetrics` 方法。

### 文档交付物
- T6_变更清单.md
- T7_测试报告.md
- T8_审计报告.md
- T8.5_审查意见.md
- T9_交付报告.md

---

## 5.6 自检清单

- [x] 公式符合业务逻辑文档
- [x] 分支判断覆盖男/女场景
- [x] 活动系数处理正确
- [x] 结果进行了取整处理 (Round)

---

## 5.7 下一步行动

1. **立即执行**: 进入 T6 编码阶段，完善并确认 `UserService` 中的计算代码。

---

## 附录：参考资料

### 相关文档
- `docs/init_docs/业务逻辑文档.md`: 5.1.4 章节。
