# F-2: 食材搜索接口 - T5 分析文档

> **任务 ID**: F-2  
> **任务名称**: 食材搜索接口  
> **优先级**: P0  
> **垂直拆分**: 后端 API  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `food_items`: 存储食材数据，搜索的目标表。

### 涉及跨模块 Service
- `FoodItemsService`: 负责具体的搜索逻辑实现。

### 所有关联模块
- `Food Domain`: 核心功能。
- `Frontend`: 食材库页面需要调用此接口进行展示和搜索。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/modules/food-items/food-items.service.ts`:
  - 现状: 已有基本的 `list` 方法，支持 `q` (关键词) 搜索和分页。
  - 修改: 增加对 `category` (分类) 筛选的支持。
- [x] `fit_cycle_app/src/modules/food-items/food-items.controller.ts`:
  - 现状: 已有 `list` 接口。
  - 修改: 增加 `category` 查询参数的接收与传递。
- [x] `fit_cycle_app/src/dtos/food-item.dto.ts`:
  - 现状: `QueryFoodItemDto` 缺失 `category` 字段。
  - 修改: 在 `QueryFoodItemDto` 中新增 `category` 字段。

### 对现有功能的影响
- [x] **无破坏性变更**: 仅扩展查询参数。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 接口契约规范。

---

## 5.3 技术落地计划

### 1. 接口契约对齐 (根据 04 规约)

**请求**: `GET /food-items`
- `q`: 关键词搜索 (模糊匹配 name 或 description)
- `category`: 分类筛选 (FoodCategory 枚举)
- `page`: 页码 (默认 1)
- `pageSize`: 每页数量 (默认 20)

**响应**: 分页对象
```json
{
  "total": 100,
  "page": 1,
  "pageSize": 20,
  "items": [ ...FoodItem ]
}
```

### 2. 代码实现方案

1.  **DTO 扩展**: 在 `QueryFoodItemDto` 中新增 `@IsOptional() @IsEnum(FoodCategory) category?: FoodCategory;`。
2.  **Service 逻辑增强**: 
    - 构造 `where` 条件时，增加 `category` 的判断。
    - 组合关键词搜索与分类筛选。
3.  **Controller 参数接收**: 更新 `list` 方法签名，使用 `QueryFoodItemDto` 接收参数。

### 3. 数据流向

```
Frontend -> GET /food-items?q=xxx&category=protein -> Controller -> Service -> TypeORM (findAndCount) -> Response
```

### 4. 依赖任务检查

- [x] 依赖任务 `F-1` (实体定义与数据导入) 已完成。

---

## 5.4 风险点清单

### 技术风险
- [ ] **性能问题**: 随着食材库增大，模糊搜索可能变慢。
  - 应对措施: 确认 `name` 字段已有索引 (`idx_name`)。目前数据量较小，暂时无需全文索引。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/dtos/food-item.dto.ts`: 更新 `QueryFoodItemDto`。
- `fit_cycle_app/src/modules/food-items/food-items.service.ts`: 增强 `list` 方法。
- `fit_cycle_app/src/modules/food-items/food-items.controller.ts`: 增强 `list` 接口。

### 文档交付物
- T6_变更清单.md
- T7_测试报告.md
- T8_审计报告.md
- T9_交付报告.md

---

## 5.6 自检清单

- [x] 接口路径与规约一致
- [x] 支持分页逻辑
- [x] 支持分类筛选
- [x] 支持关键词模糊搜索

---

## 5.7 下一步行动

1. **立即执行**: 修改 DTO、Service 和 Controller 实现功能增强。

---

## 附录：参考资料

### 相关文档
- `docs/pj_docs/04_接口与数据规约.md`: 2.3 章节。
