# P-3: 模板管理接口 - T5 分析文档

> **任务 ID**: P-3  
> **任务名称**: 模板管理接口  
> **优先级**: P0  
> **垂直拆分**: 后端 API  
> **预估工时**: 6h  
> **复杂度**: 高  
> **分析时间**: 2026-02-03 11:30  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `plan_days` (`fit_cycle_app/src/database/entity/plan-day.entity.ts`): 计划内的日配置。
- [x] `plan_meals` (`fit_cycle_app/src/database/entity/plan-meal.entity.ts`): 日配置下的餐次。
- [x] `plan_meal_items` (`fit_cycle_app/src/database/entity/plan-meal-item.entity.ts`): 餐次下的食材。
- [x] `diet_plans` (`fit_cycle_app/src/database/entity/diet-plan.entity.ts`): 根计划。

### 涉及跨模块 Service
- [x] `DietPlansService`: 负责所有计划层级数据的处理。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/dtos/create-plan-day.dto.ts`: 对齐 P-1 实体（`dayIndex` -> `dayNumber`, 移除 `date`）。
- [x] `fit_cycle_app/src/modules/diet-plans/diet-plans.service.ts`: 实现批量保存逻辑。
- [x] `fit_cycle_app/src/modules/diet-plans/diet-plans.controller.ts`: 暴露批量保存端点。

### 对现有功能的影响
- [x] **有影响**: 完善了计划的深层配置能力，是 P-6 (创建向导 UI) 的核心支撑。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 批量保存接口契约。

### 潜在的破坏性变更
- [x] **无破坏性变更**

---

## 5.3 技术落地计划

### 1. 文件创建/修改清单

#### 后端文件
- [x] `src/dtos/save-plan-templates.dto.ts` (新): 支持一次性保存整个计划的所有日模板及其餐单。
- [x] `src/dtos/create-plan-day.dto.ts`: 更新。
- [x] `src/dtos/update-plan-day.dto.ts`: 更新。

### 2. 方法定义

#### 后端方法
```typescript
// Controller
@Post(':id/templates')
async saveTemplates(@Req() req: any, @Param('id') id: string, @Body() dto: SavePlanTemplatesDto);

// Service
async saveTemplates(planId: number, userId: number, dto: SavePlanTemplatesDto): Promise<void>;
```

### 3. 数据流向

```
[前端模板编辑页] → [SavePlanTemplatesDto (嵌套结构)] → [Service (事务处理)] 
                                                    ↓
[MySQL (清理旧数据 -> 插入新 Day/Meal/Item)]
```

### 4. 批量保存策略 (Sync Strategy)
为了简化开发与保证一致性，采取 **"覆盖式保存"**:
1.  开启事务。
2.  删除当前计划下所有的 `plan_days`（会自动级联删除 `meals` 和 `items`）。
3.  根据 DTO 重新插入整套结构。
*注：此策略适用于创建向导和整套配置修改场景。*

---

## 5.4 风险点清单

### 技术风险
- [ ] **级联删除性能**
  - 影响: 如果计划天数极多，频繁删除插入可能有压力。
  - 应对措施: 限制 `cycle_days` 最大值为 31。

### 业务风险
- [ ] **数据丢失**
  - 影响: 覆盖保存会导致旧的配置被物理删除。
  - 应对措施: 前端在提交前需做二次确认。

---

## 5.5 预期交付物

### 代码交付物
- [x] 更新后的 DTOs
- [x] `save-plan-templates.dto.ts`
- [x] 实现批量保存逻辑的 Service 与 Controller

### 文档交付物
- [x] T6_变更清单.md
- [x] T7_测试报告 (嵌套结构保存测试)

---

## 5.6 下一步行动

1. **立即执行**: 创建 `SavePlanTemplatesDto` 并更新 `CreatePlanDayDto`。
2. **执行编码**: 实现 `DietPlansService.saveTemplates` 的事务逻辑。
