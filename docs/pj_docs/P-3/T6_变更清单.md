# P-3: 模板管理接口 - T6 变更清单

> **任务 ID**: P-3  
> **任务状态**: 已实现批量模板保存逻辑 (嵌套结构支持)

---

## 6.1 代码变更详情

### 后端 (fit_cycle_app)

#### 1. DTO 更新与新增
- [x] **CreatePlanDayDto**: 重命名字段，移除 `date`，完全对齐日模板属性。
- [x] **SavePlanTemplatesDto**: **核心新增**。
    - 支持 `PlanDay -> PlanMeal -> PlanMealItem` 的三层嵌套 JSON 结构。
    - 使用 `class-transformer` 的 `@Type` 装饰器实现深层级自动转换与校验。

#### 2. 服务层实现 (`src/modules/diet-plans/diet-plans.service.ts`)
- [x] **批量保存方案**: 实现 `saveTemplates` 方法。
- [x] **事务安全**: 采用 `queryRunner` 开启手动事务。
- [x] **同步策略**: 实现“全量覆盖”逻辑。
    - 第一步：按 `planId` 物理删除所有现有关联日配置。
    - 第二步：依次递归创建并保存 `PlanDay`, `PlanMeal`, `PlanMealItem`。
- [x] **性能优化**: 减少了多次 HTTP 请求往返，改为单一接口完成全周期配置。

#### 3. 控制层完善 (`src/modules/diet-plans/diet-plans.controller.ts`)
- [x] **新增端点**: `POST /diet-plans/:id/templates`。
- [x] **安全审计**: 强制校验计划所有权。

---

## 6.2 数据库一致性说明

- [x] **级联删除**: 依赖数据库物理外键或代码逻辑清理。由于 `PlanDay` 是父节点，删除 `PlanDay` 会导致其关联的 `PlanMeal` 等子表数据失效（已通过事务和 `delete` 逻辑闭环）。

---

## 6.3 待办事项 (Next Steps)

1. **进入 T7 测试**: 构造一个包含 2 天、每餐 2 个食材的嵌套 JSON，测试批量保存的完整性。
2. **进入 P-4**: 实现计划激活逻辑（确保系统中只有一个 ACTIVE 计划）。
