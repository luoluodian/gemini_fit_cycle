# F-1: 系统食材导入 - T5 分析文档

> **任务 ID**: F-1  
> **任务名称**: 系统食材导入  
> **优先级**: P0  
> **垂直拆分**: 后端 Script / DB  
> **预估工时**: 4h  
> **复杂度**: 中  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [ ] `food_items` (`fit_cycle_app/src/database/entity/food-item.entity.ts`): 核心食材库表。
- [ ] `foods` (`fit_cycle_app/src/database/entity/food.entity.ts`): **冗余表，计划删除/合并**。

### 涉及公共组件
- 无 (后端任务)

### 涉及跨模块 Service
- `FoodItemsService`: 负责提供导入逻辑及后续查询。

### 所有关联模块
- `DietLog`: 记录饮食时需要从食材库选择。
- `DietPlan`: 制定计划模板时需要引用食材。

---

## 5.2 影响评估

### 需要修改的现有文件
- [ ] `fit_cycle_app/src/database/entity/food-item.entity.ts`: **关键重构**。目前代码与 `04_接口与数据规约.md` 严重脱节，需按规约重写字段。
- [ ] `fit_cycle_app/src/database/entity/food.entity.ts`: 标记为废弃，合并逻辑至 `FoodItem`。
- [ ] `fit_cycle_app/src/database/entities.module.ts`: 移除对 `Food` 实体的注册。
- [ ] `fit_cycle_app/src/modules/food-items/food-items.service.ts`: 新增导入方法。

### 对现有功能的影响
- [ ] **破坏性变更**: 统一食材实体模型。现有引用 `Food` 实体的模块（如 `FoodModule`）需重构以引用 `FoodItem`。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: 数据库字段标准。
- `html/food.js`: 系统食材源数据。

---

## 5.3 技术落地计划

### 1. 实体模型统一 (Refactoring)

重写 `FoodItem` 实体，字段必须对齐 `01_initial_schema.sql`:
- `id` (BigInt), `name`, `type` (Enum), `user_id`, `category` (Enum), `description`, `image_url`, `is_public`, `calories`, `protein`, `fat`, `carbs`, `unit`, `tags`.

### 2. 源数据解析 (Source Data)

源数据位于 `html/food.js` 的 `foodDatabase` 对象中。
需要将其转换为 JSON 格式或直接在 TS 脚本中引用。

### 3. 导入逻辑实现 (Implementation)

在 `FoodItemsService` 中实现 `syncSystemFoods()`:
1.  定义源数据数组（从 `html/food.js` 提取）。
2.  开启事务。
3.  清除表中所有 `type='system'` 的数据（或根据 `name` 执行 upsert）。
4.  执行批量插入。

### 4. 接口触发 (Trigger)

为方便执行，可在 `FoodItemsController` 暴露一个 `POST /food-items/sync` 接口，仅限内部或开发环境调用。

### 5. 数据流向

```
html/food.js (Source) -> FoodItemsService.syncSystemFoods() -> food_items Table (MySQL)
```

### 6. 依赖任务检查

- [x] 依赖任务 `S-1` (数据库初始化) 已完成。

---

## 5.4 风险点清单

### 技术风险
- [ ] **字段不一致**: `html/food.js` 中的部分字段（如 `id: "chicken-breast"`) 属于字符串标识，而数据库主键是数字。
  - 应对措施: 将字符串标识映射到 `tags` 或新增 `slug` 字段，或直接忽略，以 `name` 作为唯一性检查标准。
- [ ] **代码冗余**: 存在 `Food` 和 `FoodItem` 两个相似实体。
  - 应对措施: 本次任务必须完成实体合并，彻底删除 `Food` 实体。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/database/entity/food-item.entity.ts`: 更新后的实体。
- `fit_cycle_app/src/modules/food-items/food-items.service.ts`: 增加 `syncSystemFoods` 方法。
- 删除 `fit_cycle_app/src/database/entity/food.entity.ts`。

### 文档交付物
- T6_变更清单.md
- T7_测试报告.md
- T8_审计报告.md
- T9_交付报告.md

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 实体模型与 SQL 脚本对齐
- [x] 确认了源数据路径
- [x] 制定了实体合并计划

---

## 5.7 下一步行动

1. **立即执行**: 重构 `FoodItem` 实体并清理冗余的 `Food` 实体。
2. **准备数据**: 提取 `html/food.js` 中的数据为可导入格式。

---

## 附录：参考资料

### 相关文档
- `docs/pj_docs/04_接口与数据规约.md`: 食材域规约。
- `fit_cycle_app/src/database/migrations/01_initial_schema.sql`: 建表语句。
