# P-2: 计划 CRUD 接口 - T5 分析文档

> **任务 ID**: P-2  
> **任务名称**: 计划 CRUD 接口  
> **优先级**: P0  
> **垂直拆分**: 后端 API  
> **预估工时**: 4h  
> **复杂度**: 中  
> **分析时间**: 2026-02-03 11:00  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `diet_plans` (`fit_cycle_app/src/database/entity/diet-plan.entity.ts`): 核心操作表。
- [x] `users` (`fit_cycle_app/src/database/entity/user.entity.ts`): 权限校验与归属。

### 涉及跨模块 Service
- [x] `DietPlansService` (`fit_cycle_app/src/modules/diet-plans/diet-plans.service.ts`): 持久化逻辑。

### 所有关联模块
- `AuthModule`: 提供用户身份上下文。
- `UserModule`: 用户数据支持。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/dtos/create-diet-plan.dto.ts`: 更新字段以适配 P-1 重构后的实体。
- [x] `fit_cycle_app/src/dtos/update-diet-plan.dto.ts`: 同步更新。
- [x] `fit_cycle_app/src/modules/diet-plans/diet-plans.controller.ts`: 完善路由与参数解析。
- [x] `fit_cycle_app/src/modules/diet-plans/diet-plans.service.ts`: 实现具体的业务逻辑（CRUD）。

### 对现有功能的影响
- [x] **无影响**: 虽是重构后的首次实现，但之前仅有空壳方法，不会破坏现有业务。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: API 契约定义。
- `fit_cycle_app/src/database/entity/diet-plan.entity.ts`: 物理字段参考。

### 潜在的破坏性变更
- [x] **无破坏性变更**

---

## 5.3 技术落地计划

### 1. 文件创建/修改清单

#### 后端文件
- [x] `create-diet-plan.dto.ts`:
  - 字段: `name`, `description`, `type` (Enum), `cycleDays`, `cycleCount`, `startDate`, `carbCycleConfig`, `targetCalories`, `targetProtein`, `targetFat`, `targetCarbs`。
- [x] `update-diet-plan.dto.ts`:
  - 以上所有字段设为可选，增加 `status` (Enum)。
- [x] `diet-plans.service.ts`:
  - `findAllByUser`: 支持按状态筛选（可选）。
  - `createPlan`: 初始状态设为 `draft`。
  - `findDetail`: 包含 `planDays` 等级联数据。
  - `updatePlan`: 权限检查。
  - `removePlan`: 权限检查。

### 2. 方法定义

#### 后端方法
```typescript
// Controller 
@Get('diet-plans')
async listPlans(@Req() req: any, @Query('status') status?: PlanStatus);

@Post('diet-plans')
async createPlan(@Req() req: any, @Body() dto: CreateDietPlanDto);

// Service
async findAllByUser(userId: number, status?: PlanStatus): Promise<DietPlan[]>;
async createPlan(userId: number, dto: CreateDietPlanDto): Promise<DietPlan>;
```

### 3. 数据流向

```
[前端请求] → [Controller (解析JWT获取UID)] → [Service (权限校验 + TypeORM)] → [MySQL]
```

### 4. 依赖任务检查

- [x] 依赖任务 `P-1` (实体设计) 已完成。

---

## 5.4 风险点清单

### 技术风险
- [ ] **越权访问 (IDOR)**
  - 影响: 用户可以增删改他人的计划。
  - 应对措施: 在 Service 层所有操作前必须验证 `userId`。

### 业务风险
- [ ] **激活冲突**
  - 影响: 逻辑上应只有一个 ACTIVE 计划。
  - 应对措施: `create` 和 `update` 接口默认不处理激活状态转换，激活操作统一通过 `activate` 接口处理（P-4 任务）。

---

## 5.5 预期交付物

### 代码交付物
- [x] 更新后的 DTO 文件
- [x] 实现完整的 Controller 与 Service 逻辑

### 文档交付物
- [x] T6_变更清单.md
- [x] T7_测试报告 (Postman/Curl 验证结果)

---

## 5.6 自检清单

- [x] DTO 字段与实体 100% 对齐。
- [x] 权限校验逻辑覆盖所有 CRUD 方法。
- [x] 错误处理（如 NotFoundException）已包含。

---

## 5.7 下一步行动

1. **立即执行**: 开始 T6 编码阶段，首先更新 DTO。
