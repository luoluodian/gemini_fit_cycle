# P-2: 计划 CRUD 接口 - T6 变更清单

> **任务 ID**: P-2  
> **任务状态**: 已完成核心 CRUD 接口编码

---

## 6.1 代码变更详情

### 后端 (fit_cycle_app)

#### 1. DTO 更新 (`src/dtos/`)
- [x] **CreateDietPlanDto**: 支持 `type`, `cycleDays`, `cycleCount`, `carbCycleConfig` 等所有 P-1 实体字段。
- [x] **UpdateDietPlanDto**: 所有字段设为可选，并支持修改 `status`。

#### 2. 控制层完善 (`src/modules/diet-plans/diet-plans.controller.ts`)
- [x] **路由规范化**: 统一前缀为 `/diet-plans`。
- [x] **列表筛选**: 增加了对 `status` 查询参数的支持。
- [x] **安全保障**: 全局应用 `JwtAuthGuard`，并从 `req.user.userId` 提取用户身份。
- [x] **端点补全**: 新增 `GET /diet-plans/recommended` 接口。

#### 3. 服务层实现 (`src/modules/diet-plans/diet-plans.service.ts`)
- [x] **CRUD 闭环**: 实现了完整的查询、创建、更新、删除逻辑。
- [x] **权限深度校验**: 
    - 列表查询限制在当前 `userId` 下。
    - 详情查询检查 `isTemplate` 或归属权。
    - 更新/删除强制检查 `userId` 匹配。
- [x] **默认状态**: 新建计划强制设为 `DRAFT` 状态。

---

## 6.2 待办事项 (Next Steps)

1. **进入 T7 测试**: 通过 `curl` 或测试脚本验证接口可用性。
2. **开发 P-3**: 模板管理接口（日模板/餐单关联）。
3. **开发 P-4**: 激活逻辑（单一 ACTIVE 约束）。
