# U-4: 用户信息接口 - T7 测试报告

> **任务 ID**: U-4
> **测试时间**: 2026-01-31
> **测试环境**: 本地 MacOS, Node v22, SQLite (In-Memory)

## 1. 测试概览

| 测试套件 | 状态 | 覆盖模块 | 关键验证点 |
| :--- | :--- | :--- | :--- |
| `auth.e2e-spec.ts` | **PASS** | Auth, User | 微信登录流程，Token 签发，用户自动创建 |
| `user.e2e-spec.ts` | **PASS** | User, DB | User 实体 CRUD，HealthProfile 关联，SQLite 兼容性 |
| `app.e2e-spec.ts` | **FAIL** | App | 根路由访问 (已知问题：路由不匹配) |

## 2. 关键测试用例执行

### 2.1 用户创建与查找 (`user.e2e-spec.ts`)
- **场景**: 创建一个新 User 对象并保存。
- **结果**: 成功。
- **意义**: 验证了 Entity 定义在 SQLite 环境下的正确性，特别是主键和外键约束。

### 2.2 微信登录 (`auth.e2e-spec.ts`)
- **场景**: 模拟微信登录请求 (`POST /auth/wechatAuth`)。
- **结果**: 成功 (201 Created)。
- **响应**: 包含 `accessToken`, `refreshToken`, `user` 对象。
- **意义**: 验证了 `AuthService` 与 `UserService` 的集成，以及 DTO 转换逻辑 (`UserTransformer`) 能正确处理分离后的数据结构。

## 3. 遇到的问题与解决方案

### 3.1 SQLite `AUTOINCREMENT` 错误
- **现象**: `QueryFailedError: SQLITE_ERROR: AUTOINCREMENT is only allowed on an INTEGER PRIMARY KEY`
- **原因**: Entity 中定义了 `@PrimaryGeneratedColumn({ type: 'bigint' })`，TypeORM 生成的 SQL 在 SQLite 中非法。
- **解决**: 移除 `type: 'bigint'`，让 TypeORM 根据驱动自动选择类型。

### 3.2 依赖注入失败
- **现象**: `Nest can't resolve dependencies of the UserService`
- **原因**: `UserModule` 未导入 `HealthProfile` 实体。
- **解决**: 在 `UserModule` 的 `TypeOrmModule.forFeature` 中添加 `HealthProfile`。

### 3.3 数据列缺失
- **现象**: `Unknown column 'avatarUrl'`
- **原因**: 测试环境意外连接到了 Schema 未更新的本地 MySQL，或 SQLite 同步失败。
- **解决**: 强制所有 E2E 测试使用 `overrideModule(DatabaseModule)` 连接到 `sqlite::memory:`，确保环境隔离。

## 4. 结论
核心业务逻辑（用户管理、健康档案关联）已验证通过，代码符合规约。
