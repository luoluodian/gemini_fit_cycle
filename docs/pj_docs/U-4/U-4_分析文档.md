# U-4: 用户信息接口 - T5 分析文档

> **任务 ID**: U-4
> **任务名称**: 用户信息接口
> **优先级**: P0
> **垂直拆分**: 后端 API / 业务逻辑
> **预估工时**: 2h
> **复杂度**: 中
> **分析时间**: 2026-01-31
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `users` (`fit_cycle_app/src/database/entity/user.entity.ts`): 主表。
- [x] `health_profiles` (关联表): U-4 的核心是聚合 User 和 HealthProfile 的数据。

### 涉及公共组件
- [x] `UserController` (`fit_cycle_app/src/modules/user/user.controller.ts`): API 入口。
- [x] `UserService` (`fit_cycle_app/src/modules/user/user.service.ts`): 核心业务逻辑。
- [x] `UserResponseDto` (`fit_cycle_app/src/dtos/user.dto.ts`): 响应 DTO。
- [x] `UserTransformer` (`fit_cycle_app/src/common/transformers/user.transformer.ts`): 数据转换。

### 涉及跨模块 Service
- [ ] 无

### 所有关联模块
- `UserModule`, `AuthModule` (JWT Guard).

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/database/entity/user.entity.ts`:
    - 需删除 `heightCm`, `weightKg`, `dateOfBirth`, `genderId`, `activityLevelId`, `goalTypeId` 等字段，因为它们已迁移至 `health_profiles` 表。
- [x] `fit_cycle_app/src/database/entity/health-profile.entity.ts`:
    - 需**创建**此文件，定义 HealthProfile 实体。
- [x] `fit_cycle_app/src/modules/user/user.service.ts`:
    - `findById` 和 `updateMe` 需要重构，以支持联表查询和更新 `health_profiles`。
- [x] `fit_cycle_app/src/common/transformers/user.transformer.ts`:
    - 需更新 `toResponse` 方法，从 `user.healthProfile` 中获取健康数据。
- [x] `fit_cycle_app/src/database/entities.module.ts`:
    - 需注册 `HealthProfile` 实体。

### 对现有功能的影响
- **有影响**: 任何依赖 `user.heightCm` 等旧字段的代码都会报错（如 E2E 测试）。本次任务是修复这些“断裂”的关键步骤。

### 必须参考的文件路径
- `docs/pj_docs/04_接口与数据规约.md`: "1.1 用户域"。

### 潜在的破坏性变更
- **破坏性变更**: 删除了 User 实体的字段，所有未迁移的代码都将失效。

---

## 5.3 技术落地计划

### 1. 文件创建清单
- [x] `fit_cycle_app/src/database/entity/health-profile.entity.ts`: 
  - 类名: `HealthProfile`
  - 字段: `id`, `userId`, `gender`, `height`, `weight`, `birthday` 等。

### 2. 代码审计与修正点

#### 后端方法 (`UserEntity`)
- **修正目标**: 移除所有健康相关字段，添加 `@OneToOne(() => HealthProfile)` 关联。

#### 后端方法 (`UserService.findById`)
- **现状**: `this.userRepository.findOne({ where: { id } })`。
- **修正目标**: 增加 `relations: ['healthProfile']`。

#### 后端方法 (`UserService.updateMe`)
- **现状**: 直接 `this.userRepository.update(id, dto)`。
- **修正目标**: 
  - 分离 DTO 中的 `User` 字段（nickname, avatar）和 `HealthProfile` 字段。
  - 使用事务或分别更新两张表。
  - 如果 `HealthProfile` 不存在，则创建。

#### 后端方法 (`UserTransformer`)
- **修正目标**: 映射逻辑从 `user.heightCm` 改为 `user.healthProfile?.height`。

### 3. 数据流向
```
Client -> PUT /user/info (DTO) 
-> UserController -> UserService 
-> 拆分数据 -> UserRepo.save() & HealthProfileRepo.save() 
-> UserTransformer -> Client
```

### 5. 依赖任务检查
- [x] 依赖任务 `S-1` 已完成 (数据库表结构就绪)。

---

## 5.4 风险点清单

### 技术风险
- [x] **数据迁移**: 这是一个新系统，假设没有旧数据需要迁移。如果是生产环境，需要编写 SQL 迁移脚本。
- [x] **空指针风险**: `user.healthProfile` 可能为 null，Transformer 中需做安全访问。

---

## 5.5 预期交付物

### 代码交付物
- `health-profile.entity.ts`
- 更新后的 `user.entity.ts`, `user.service.ts`, `user.transformer.ts`。

### 文档交付物
- `docs/pj_docs/U-4/U-4_分析文档.md`

---

## 5.6 自检清单

- [x] 所有关联模块已识别
- [x] 所有影响范围已评估
- [x] 技术方案可行且清晰
- [x] 数据流向已明确

---

## 5.7 下一步行动

1. **立即执行**: 
   - 创建 `HealthProfile` 实体。
   - 重构 `User` 实体。
   - 更新 `UserService` 和 `UserTransformer`。
   - 修复 `user.e2e-spec.ts`。
2. **需要澄清**: 无。
