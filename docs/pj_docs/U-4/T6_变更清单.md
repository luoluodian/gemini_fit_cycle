# U-4: 用户信息接口 - T6 变更清单

> **任务 ID**: U-4
> **执行时间**: 2026-01-31
> **执行人**: AI Assistant

## 1. 变更文件列表

| 文件路径 | 变更类型 | 说明 |
| :--- | :--- | :--- |
| `fit_cycle_app/src/database/entity/health-profile.entity.ts` | **新增** | 创建健康档案实体，分离用户身体数据 |
| `fit_cycle_app/src/database/entity/user.entity.ts` | **修改** | 移除冗余字段，建立与 HealthProfile 的 OneToOne 关联 |
| `fit_cycle_app/src/modules/user/user.service.ts` | **修改** | 重构 `findOrCreate` 和 `updateMe`，支持双表事务更新 |
| `fit_cycle_app/src/common/transformers/user.transformer.ts` | **修改** | 适配新的数据结构，从关联的 healthProfile 中读取数据 |
| `fit_cycle_app/src/database/entities.module.ts` | **修改** | 注册 HealthProfile 实体 |
| `fit_cycle_app/src/modules/user/user.module.ts` | **修改** | 导入 HealthProfile 实体，解决依赖注入问题 |
| `fit_cycle_app/test/user.e2e-spec.ts` | **修改** | 修复测试用例，适配新的实体结构和 SQLite 环境 |
| `fit_cycle_app/test/auth.e2e-spec.ts` | **修改** | 配置 SQLite 内存数据库 override，隔离测试环境 |

## 2. 关键变更详情

### 2.1 实体拆分 (Entity Splitting)
- **User**: 仅保留 `openid`, `nickname`, `avatar_url`, `email`, `phone`, `refresh_token`。
- **HealthProfile**: 承载 `gender`, `height`, `weight`, `birthday`, `activity_level`, `bmr`, `tdee`。
- **关联**: `User` @OneToOne `HealthProfile` (Cascade: true)。

### 2.2 服务逻辑 (Service Logic)
- **findOrCreateByOpenid**:
  - 创建新用户时，同步创建一个空的 `HealthProfile` 记录，确保数据完整性。
- **updateMe**:
  - 使用 `dataSource.transaction` 保证 `User` 和 `HealthProfile` 的原子性更新。
  - 自动计算 `BMR` 和 `TDEE`（当必要数据齐全时）。

### 2.3 测试兼容性 (Testing Compatibility)
- **SQLite 适配**:
  - 移除 `HealthProfile` 主键的 `type: 'bigint'`，允许 TypeORM 自动适配 SQLite 的 `integer`。
  - 将 `gender` 字段从 `enum` 改为 `varchar`，规避 SQLite 不支持 enum 的限制。
- **E2E 配置**:
  - 在所有 E2E 测试中强制使用 `sqlite::memory:` 并 override `DatabaseModule`，避免连接本地 MySQL 导致环境污染。

## 3. 遗留问题
- `app.e2e-spec.ts` 依然失败 (404 Not Found)，原因是测试请求的根路径 `/` 与实际 Controller 路由不匹配。这属于历史遗留问题，未在本次任务范围内修复。
