# P-9 创建向导 Step 3 - 日模板编辑 分析报告

> **任务 ID**: P-9  
> **任务名称**: 创建向导 Step 3 - 日模板编辑  
> **优先级**: P0  
> **垂直拆分**: 前端页面 + 组件 + 逻辑  
> **预估工时**: 6h  
> **复杂度**: 高  
> **分析时间**: 2026-02-04 15:30  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共组件
- [x] `BaseNavBar` (`src/components/common/BaseNavBar.vue`): 页面顶部导航
- [x] `BaseScrollView` (`src/components/common/BaseScrollView.vue`): 页面主体滚动容器
- [x] `GlassCard` (`src/components/common/GlassCard.vue`): 视觉容器
- [x] `FoodSelectionModal` (`src/components/common/FoodSelectionModal.vue`): 复用现有组件或新建 `FoodSelectorModal.vue` (P-19)

### 关联模块
- `PlanStore`: 读取和更新 `draft.templates` 中的具体某一天数据。
- `FoodService`: 提供食物搜索和分类查询能力。

### UI 结构分析 (参考 `html/edit-template.html`)
- **页面容器**: 100vh 锁定高度，Flex 纵向布局。
- **顶部**: 模板名称输入框（限制 6 字），显示当前配置进度或碳循环阶段标识。
- **目标概览**: 
  - **碳循环模式**: 显示高/中/低碳标识，及当日 P/C/F 目标与当前摄入量的对比进度条。
  - **普通模式**: 显示四个营养素的目标值卡片。
- **餐次列表**: 
  - 默认展示 早、中、晚、加餐 四个区块。
  - 每个区块内展示已添加的食物列表（名称、热量、三大营养素）。
  - 每个区块有“添加食物”按钮。
  - **高级功能**: 支持自定义添加餐次（如训练后加餐）。
- **底部**: “取消”和“保存模板”按钮。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `src/pages/edit-template/index.vue`: 全新实现。
- [x] `src/stores/plan.ts`: 可能需要增加 `updateTemplate(index, data)` action。

### 对现有功能的影响
- **无破坏性影响**: 这是一个新增页面，作为 `plan-templates` 的子页面存在。

### 必须参考的文件路径
- `html/edit-template.html`: 核心交互逻辑。
- `html/food-selector-embedded.html`: 食物选择器交互。

---

## 5.3 技术落地计划

### 1. 文件创建清单

#### 前端页面
- [ ] `src/pages/edit-template/index.vue`: 主页面。
- [ ] `src/components/plan-creator/MealSection.vue`: 餐次区块组件（负责展示该餐次的食物列表）。
- [ ] `src/components/plan-creator/NutritionProgress.vue`: 营养目标进度条组件。

### 2. 数据结构与状态管理

**Template 数据结构回顾**:
```typescript
interface Template {
  tempId: string;
  name?: string; // 用户自定义名称
  targetCalories: number;
  protein: number;
  fat: number;
  carbs: number;
  isConfigured: boolean;
  carbType?: "high" | "medium" | "low";
  meals: {
    breakfast: FoodItem[];
    lunch: FoodItem[];
    dinner: FoodItem[];
    snacks: FoodItem[];
    [key: string]: FoodItem[]; // 支持动态餐次
  };
  mealOrder: string[]; // ['breakfast', 'lunch', 'dinner', 'snacks']
}

interface FoodItem {
  id: string; // 或 foodId
  name: string;
  quantity: number;
  unit: string;
  calories: number;
  protein: number;
  fat: number;
  carbs: number;
}
```

### 3. UI 交互流程

1. **进入页面**: 
   - 从 `planStore` 获取 `currentDayIndex`。
   - 读取 `draft.templates[currentDayIndex]`。
   - 初始化本地响应式状态 `currentTemplate`（深拷贝，避免直接修改 Store，直到点击保存）。

2. **添加食物**:
   - 点击某餐次的“添加”按钮 -> 打开 `FoodSelectorModal`。
   - 选择食物 -> 输入数量 -> 确认。
   - 将食物对象 push 到 `currentTemplate.meals[mealType]`。
   - 自动重新计算 `currentNutrition`（当前已摄入总量）。

3. **实时反馈**:
   - `NutritionProgress` 组件监听 `currentNutrition` 和 `targetNutrition`，实时更新进度条颜色（低: 蓝/黄, 达标: 绿, 超标: 红）。

4. **保存**:
   - 校验名称长度。
   - 调用 `planStore.updateTemplate(index, currentTemplate)`。
   - 返回上一页。

---

## 5.4 风险点清单

### 性能风险
- **风险**: 食物列表过长时，计算属性过于复杂可能导致卡顿。
- **对策**: 仅在 `meals` 变动时重新计算总摄入量，不做深层高频监听。

### 交互风险
- **风险**: 软键盘弹起遮挡底部操作栏或输入框。
- **对策**: 使用 `BaseScrollView` 的键盘适配能力。

---

## 5.5 预期交付物

- 完整的 `edit-template` 页面，支持碳循环和普通模式的差异化展示。
- 能够添加、删除食物，并实时看到营养素变化。
- 数据正确回写到 `planStore`。

---

## 5.7 下一步行动

1. **立即执行**: 创建 `src/pages/edit-template/index.vue` 及相关组件。
2. **依赖检查**: 需要先确认 `FoodSelectionModal` (P-19) 是否可用，或在此任务中一并实现简化版。
   - *注*: 为了闭环，本任务将包含一个**嵌入式**或**简化版**的食物选择逻辑，后续 P-19 再进行增强。

