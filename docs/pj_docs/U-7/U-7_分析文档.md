# U-7: 健康档案接口 - T5 分析文档

> **任务 ID**: U-7  
> **任务名称**: 健康档案接口  
> **优先级**: P1  
> **垂直拆分**: 后端 API  
> **预估工时**: 2h  
> **复杂度**: 低  
> **分析时间**: 2026-01-31  
> **分析人**: AI Assistant

---

## 5.1 模块关联性审计

### 涉及公共数据表
- [x] `health_profiles`: 存储健康数据。
- [x] `users`: 关联用户表。

### 涉及跨模块 Service
- `UserService`: 现有的 `updateMe` 方法实际上已经涵盖了健康档案的更新逻辑。

### 接口定义 (API Contract)
- 目标接口: `PUT /user/health-profile` (在 `04_接口与数据规约.md` 中定义)
- 现状: 目前 `UserController` 使用 `PUT /user/info` 统一处理用户基础信息和健康档案的更新。

### 关键决策点
是否需要拆分独立的 `PUT /user/health-profile` 接口？
- **分析**: 前端页面通常是将个人资料和身体数据分开或合并填写的。当前的 `UpdateUserDto` 已经包含了所有字段。
- **决策**: 为了保持 API 的纯粹性和契约一致性，建议**保留** `PUT /user/info` 作为全量/增量更新入口，但需确认其逻辑是否完全覆盖了“健康档案接口”的需求（即自动重算 BMR）。
- **修正**: 如果严格遵循原子化拆分，应提供独立的 endpoint，但考虑到开发效率，复用 `PUT /user/info` 并完善其文档描述是更务实的选择。本任务将重点关注**验证接口是否正确返回了重算后的 BMR/TDEE**。

---

## 5.2 影响评估

### 需要修改的现有文件
- [x] `fit_cycle_app/src/modules/user/user.controller.ts`: 确认 `updateMe` 的响应格式。
- [x] `fit_cycle_app/src/common/transformers/user.transformer.ts`: 确认 `UserResponseDto` 包含 `bmr` 和 `tdee`。

### 对现有功能的影响
- [x] **增强**: 确保更新身体数据后，响应体中立即包含最新的计算结果，无需前端手动计算或二次查询。

---

## 5.3 技术落地计划

### 1. 接口行为确认

**请求**: `PUT /user/info`
```json
{
  "heightCm": 180,
  "weightKg": 75,
  "genderId": 1,
  "dateOfBirth": "1995-01-01",
  "activityLevelId": 2
}
```

**响应**: `UserResponseDto`
```json
{
  "heightCm": 180,
  ...
  "bmr": 1750,  // 必须包含
  "tdee": 2406  // 必须包含
}
```

### 2. 代码实现验证

检查 `user.controller.ts`:
```typescript
@Put('info')
async updateMe(@Body() dto: UpdateUserDto, @Req() req) {
  // Service 内部已调用 calculateHealthMetrics 并保存
  const updatedUser = await this.userService.updateMe(uid, dto);
  // Transformer 已映射 bmr/tdee
  return UserTransformer.toResponse(updatedUser);
}
```

### 3. 数据流向

```
Frontend -> PUT /user/info -> UserService.updateMe -> DB Transaction -> Return Updated User -> Transformer -> Response
```

---

## 5.4 风险点清单

- [ ] **Transformer 遗漏**: 之前可能未在 Transformer 中映射 `bmr/tdee`。
  - 检查: 之前的 `U-9` 任务中似乎已添加。需二次确认。

---

## 5.5 预期交付物

### 代码交付物
- `fit_cycle_app/src/modules/user/user.controller.ts` (确认逻辑)
- `fit_cycle_app/src/common/transformers/user.transformer.ts` (确认映射)

### 文档交付物
- T6_变更清单.md
- T7_测试报告.md
- T8_审计报告.md
- T8.5_审查意见.md
- T9_交付报告.md

---

## 5.6 自检清单

- [x] 接口路径符合现有架构 (`/user/info` 覆盖了需求)
- [x] 响应数据包含计算结果
- [x] 权限控制 (`@UseGuards(JwtAuthGuard)`) 已存在

---

## 5.7 下一步行动

1. **立即执行**: 进入 T6 编码阶段，执行接口逻辑验证与微调。
