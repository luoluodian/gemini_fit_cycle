# T7 è‡ªåŠ¨åŒ–è”è°ƒæµç¨‹ - AI æ™ºèƒ½ä½“æ‰§è¡ŒæŒ‡å—

> **ç‰ˆæœ¬**: v1.0  
> **é€‚ç”¨äº**: ä»»åŠ¡æ¸…å• v4.2+  
> **æ ¸å¿ƒèƒ½åŠ›**: è‡ªåŠ¨å¯åŠ¨æœåŠ¡ã€è‡ªåŠ¨è”è°ƒã€è‡ªåŠ¨è§£å†³é—®é¢˜

---

## ğŸ¤– AI æ™ºèƒ½ä½“è‡ªåŠ¨åŒ–èƒ½åŠ›

æœ¬æµç¨‹èµ‹äºˆ AI æ™ºèƒ½ä½“ä»¥ä¸‹èƒ½åŠ›ï¼š

1. âœ… **è‡ªåŠ¨å¯åŠ¨æœåŠ¡** - æ£€æµ‹å¹¶å¯åŠ¨å‰åç«¯æœåŠ¡
2. âœ… **è‡ªåŠ¨å¥åº·æ£€æŸ¥** - éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. âœ… **è‡ªåŠ¨è”è°ƒæµ‹è¯•** - æ‰§è¡Œæ¥å£è°ƒç”¨å’ŒéªŒè¯
4. âœ… **è‡ªåŠ¨é—®é¢˜è¯Šæ–­** - åˆ†æé”™è¯¯æ—¥å¿—å’Œå“åº”
5. âœ… **è‡ªåŠ¨é—®é¢˜ä¿®å¤** - æ ¹æ®é—®é¢˜ç±»å‹è‡ªåŠ¨ä¿®å¤
6. âœ… **è‡ªåŠ¨é‡è¯•éªŒè¯** - ä¿®å¤åè‡ªåŠ¨é‡æ–°æµ‹è¯•

---

## ğŸ”„ å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  é˜¶æ®µ 0: ç¯å¢ƒæ£€æŸ¥                            â”‚
â”‚  æ£€æŸ¥æœåŠ¡çŠ¶æ€ â†’ æ£€æŸ¥ç«¯å£å ç”¨ â†’ æ£€æŸ¥ä¾èµ–å®‰è£…                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  é˜¶æ®µ 1: å¯åŠ¨æœåŠ¡                            â”‚
â”‚  å¯åŠ¨åç«¯æœåŠ¡ â†’ å¥åº·æ£€æŸ¥ â†’ å¯åŠ¨å‰ç«¯æœåŠ¡ â†’ å¥åº·æ£€æŸ¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  é˜¶æ®µ 2: æ¥å£è”è°ƒæµ‹è¯•                        â”‚
â”‚  æ‰§è¡Œæ¥å£è°ƒç”¨ â†’ éªŒè¯å“åº” â†’ è®°å½•ç»“æœ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æµ‹è¯•é€šè¿‡ï¼Ÿ      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    âœ… æ˜¯      â”‚      âŒ å¦
                    â†“          â†“
            ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š    é—®é¢˜è¯Šæ–­
                              â†“
                        è‡ªåŠ¨ä¿®å¤ä»£ç 
                              â†“
                        é‡å¯æœåŠ¡å¹¶é‡è¯•
                              â†“
                        éªŒè¯ä¿®å¤æ•ˆæœ
```

---

## ğŸ“‹ é˜¶æ®µ 0: ç¯å¢ƒæ£€æŸ¥

### 0.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
lsof -i :3000 || echo "åç«¯æœåŠ¡æœªè¿è¡Œ"

# æ£€æŸ¥å‰ç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
lsof -i :10086 || echo "å‰ç«¯æœåŠ¡æœªè¿è¡Œ"

# æ£€æŸ¥æ•°æ®åº“æœåŠ¡
lsof -i :3306 || echo "MySQL æœªè¿è¡Œ"
```

### 0.2 æ£€æŸ¥ä¾èµ–å®‰è£…

```bash
# æ£€æŸ¥åç«¯ä¾èµ–
cd fit_cycle_app && npm list --depth=0

# æ£€æŸ¥å‰ç«¯ä¾èµ–
cd fit_cycle_web && npm list --depth=0
```

### 0.3 æ£€æŸ¥ç¯å¢ƒå˜é‡

```bash
# æ£€æŸ¥åç«¯ç¯å¢ƒå˜é‡
cat fit_cycle_app/.env

# æ£€æŸ¥å‰ç«¯ç¯å¢ƒå˜é‡
cat fit_cycle_web/.env.development
```

---

## ğŸš€ é˜¶æ®µ 1: å¯åŠ¨æœåŠ¡

### 1.1 å¯åŠ¨åç«¯æœåŠ¡

```bash
# è¿›å…¥åç«¯ç›®å½•
cd fit_cycle_app

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆåå°è¿è¡Œï¼‰
npm run start:dev > ../logs/backend.log 2>&1 &

# è®°å½•è¿›ç¨‹ ID
BACKEND_PID=$!
echo "åç«¯æœåŠ¡ PID: $BACKEND_PID"

# ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰
echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
sleep 30
```

### 1.2 åç«¯å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
if lsof -i :3000 > /dev/null; then
    echo "âœ… åç«¯æœåŠ¡å·²å¯åŠ¨ (ç«¯å£ 3000)"
else
    echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
    # æŸ¥çœ‹é”™è¯¯æ—¥å¿—
    tail -n 50 ../logs/backend.log
    exit 1
fi

# å¥åº·æ£€æŸ¥æ¥å£
curl -f http://localhost:3000/health || {
    echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
    tail -n 50 ../logs/backend.log
    exit 1
}

echo "âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
```

### 1.3 å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd fit_cycle_web

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆåå°è¿è¡Œï¼‰
npm run dev:weapp > ../logs/frontend.log 2>&1 &

# è®°å½•è¿›ç¨‹ ID
FRONTEND_PID=$!
echo "å‰ç«¯æœåŠ¡ PID: $FRONTEND_PID"

# ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰
echo "ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨..."
sleep 30
```

### 1.4 å‰ç«¯å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
if lsof -i :10086 > /dev/null; then
    echo "âœ… å‰ç«¯æœåŠ¡å·²å¯åŠ¨ (ç«¯å£ 10086)"
else
    echo "âŒ å‰ç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
    # æŸ¥çœ‹é”™è¯¯æ—¥å¿—
    tail -n 50 ../logs/frontend.log
    exit 1
fi

echo "âœ… å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
```

---

## ğŸ”— é˜¶æ®µ 2: æ¥å£è”è°ƒæµ‹è¯•

### 2.1 æ‰§è¡Œæ¥å£è°ƒç”¨

```bash
# æµ‹è¯•ç™»å½•æ¥å£
echo "æµ‹è¯•æ¥å£: POST /api/auth/login"

RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code": "test_wx_code_123"}')

# åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

echo "çŠ¶æ€ç : $HTTP_CODE"
echo "å“åº”ä½“: $HTTP_BODY"
```

### 2.2 éªŒè¯å“åº”

```bash
# éªŒè¯çŠ¶æ€ç 
if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
    echo "âœ… çŠ¶æ€ç æ­£ç¡®"
else
    echo "âŒ çŠ¶æ€ç é”™è¯¯: $HTTP_CODE"
    # è§¦å‘é—®é¢˜è¯Šæ–­
fi

# éªŒè¯å“åº”æ ¼å¼
if echo "$HTTP_BODY" | jq -e '.code' > /dev/null 2>&1; then
    echo "âœ… å“åº”æ ¼å¼æ­£ç¡®ï¼ˆåŒ…å« code å­—æ®µï¼‰"
else
    echo "âŒ å“åº”æ ¼å¼é”™è¯¯ï¼ˆç¼ºå°‘ code å­—æ®µï¼‰"
    # è§¦å‘é—®é¢˜è¯Šæ–­
fi

# éªŒè¯ä¸šåŠ¡çŠ¶æ€ç 
BUSINESS_CODE=$(echo "$HTTP_BODY" | jq -r '.code')
if [ "$BUSINESS_CODE" -eq 0 ]; then
    echo "âœ… ä¸šåŠ¡çŠ¶æ€ç æ­£ç¡®"
else
    echo "âŒ ä¸šåŠ¡çŠ¶æ€ç é”™è¯¯: $BUSINESS_CODE"
    MESSAGE=$(echo "$HTTP_BODY" | jq -r '.message')
    echo "é”™è¯¯ä¿¡æ¯: $MESSAGE"
    # è§¦å‘é—®é¢˜è¯Šæ–­
fi

# éªŒè¯æ•°æ®ç»“æ„
if echo "$HTTP_BODY" | jq -e '.data.access_token' > /dev/null 2>&1; then
    echo "âœ… æ•°æ®ç»“æ„æ­£ç¡®ï¼ˆåŒ…å« access_tokenï¼‰"
else
    echo "âŒ æ•°æ®ç»“æ„é”™è¯¯ï¼ˆç¼ºå°‘ access_tokenï¼‰"
    # è§¦å‘é—®é¢˜è¯Šæ–­
fi
```

---

## ğŸ” é˜¶æ®µ 3: é—®é¢˜è¯Šæ–­

### 3.1 é—®é¢˜åˆ†ç±»

æ ¹æ®é”™è¯¯ç±»å‹è‡ªåŠ¨åˆ†ç±»ï¼š

```bash
# åˆ†æé”™è¯¯ç±»å‹
analyze_error() {
    local http_code=$1
    local response_body=$2
    local backend_log=$3
    
    # 1. æœåŠ¡æœªå¯åŠ¨
    if [ -z "$http_code" ]; then
        echo "ERROR_TYPE: SERVICE_NOT_RUNNING"
        return
    fi
    
    # 2. CORS é”™è¯¯
    if echo "$response_body" | grep -i "cors" > /dev/null; then
        echo "ERROR_TYPE: CORS_ERROR"
        return
    fi
    
    # 3. 404 é”™è¯¯ï¼ˆè·¯ç”±ä¸å­˜åœ¨ï¼‰
    if [ "$http_code" -eq 404 ]; then
        echo "ERROR_TYPE: ROUTE_NOT_FOUND"
        return
    fi
    
    # 4. 500 é”™è¯¯ï¼ˆæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼‰
    if [ "$http_code" -eq 500 ]; then
        echo "ERROR_TYPE: INTERNAL_SERVER_ERROR"
        # åˆ†æåç«¯æ—¥å¿—
        if grep -i "database" "$backend_log" > /dev/null; then
            echo "ERROR_SUBTYPE: DATABASE_ERROR"
        elif grep -i "undefined" "$backend_log" > /dev/null; then
            echo "ERROR_SUBTYPE: UNDEFINED_ERROR"
        fi
        return
    fi
    
    # 5. 401 é”™è¯¯ï¼ˆè®¤è¯å¤±è´¥ï¼‰
    if [ "$http_code" -eq 401 ]; then
        echo "ERROR_TYPE: AUTH_ERROR"
        return
    fi
    
    # 6. å“åº”æ ¼å¼é”™è¯¯
    if ! echo "$response_body" | jq -e '.code' > /dev/null 2>&1; then
        echo "ERROR_TYPE: RESPONSE_FORMAT_ERROR"
        return
    fi
    
    # 7. ä¸šåŠ¡é€»è¾‘é”™è¯¯
    local business_code=$(echo "$response_body" | jq -r '.code')
    if [ "$business_code" -ne 0 ]; then
        echo "ERROR_TYPE: BUSINESS_LOGIC_ERROR"
        echo "BUSINESS_CODE: $business_code"
        return
    fi
}
```

### 3.2 æ—¥å¿—åˆ†æ

```bash
# åˆ†æåç«¯æ—¥å¿—
analyze_backend_log() {
    local log_file=$1
    
    echo "ã€åç«¯æ—¥å¿—åˆ†æã€‘"
    
    # æå–æœ€è¿‘çš„é”™è¯¯
    echo "æœ€è¿‘çš„é”™è¯¯:"
    grep -i "error" "$log_file" | tail -n 10
    
    # æå–å †æ ˆè·Ÿè¸ª
    echo "å †æ ˆè·Ÿè¸ª:"
    grep -A 10 "Error:" "$log_file" | tail -n 20
    
    # æå–æ•°æ®åº“é”™è¯¯
    echo "æ•°æ®åº“é”™è¯¯:"
    grep -i "database\|mysql\|sql" "$log_file" | tail -n 10
    
    # æå–æœªå®šä¹‰é”™è¯¯
    echo "æœªå®šä¹‰é”™è¯¯:"
    grep -i "undefined\|null" "$log_file" | tail -n 10
}
```

---

## ğŸ”§ é˜¶æ®µ 4: è‡ªåŠ¨ä¿®å¤

### 4.1 CORS é”™è¯¯ä¿®å¤

```typescript
// é—®é¢˜ï¼šCORS é…ç½®ç¼ºå¤±æˆ–ä¸æ­£ç¡®
// è‡ªåŠ¨ä¿®å¤ï¼šæ›´æ–° main.ts

// æ£€æŸ¥å½“å‰é…ç½®
const mainContent = fs.readFileSync('fit_cycle_app/src/main.ts', 'utf-8');

if (!mainContent.includes('app.enableCors')) {
    // æ·»åŠ  CORS é…ç½®
    const corsConfig = `
  // CORS é…ç½®
  app.enableCors({
    origin: ['http://localhost:10086', 'http://127.0.0.1:10086'],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
  });
`;
    
    // åœ¨ app.listen ä¹‹å‰æ’å…¥
    const updatedContent = mainContent.replace(
        'await app.listen',
        corsConfig + '\n  await app.listen'
    );
    
    fs.writeFileSync('fit_cycle_app/src/main.ts', updatedContent);
    
    console.log('âœ… å·²è‡ªåŠ¨ä¿®å¤ CORS é…ç½®');
    return 'FIXED';
}
```

### 4.2 è·¯ç”±ä¸å­˜åœ¨ä¿®å¤

```typescript
// é—®é¢˜ï¼šController æœªæ³¨å†Œæˆ–è·¯ç”±è·¯å¾„é”™è¯¯
// è‡ªåŠ¨ä¿®å¤ï¼šæ£€æŸ¥å¹¶ä¿®å¤è·¯ç”±é…ç½®

// 1. æ£€æŸ¥ Controller æ˜¯å¦å­˜åœ¨
const controllerPath = 'fit_cycle_app/src/modules/auth/auth.controller.ts';
if (!fs.existsSync(controllerPath)) {
    console.log('âŒ Controller æ–‡ä»¶ä¸å­˜åœ¨');
    return 'NEED_MANUAL_FIX';
}

// 2. æ£€æŸ¥ Controller æ˜¯å¦æ³¨å†Œåˆ° Module
const moduleContent = fs.readFileSync('fit_cycle_app/src/modules/auth/auth.module.ts', 'utf-8');
if (!moduleContent.includes('AuthController')) {
    // è‡ªåŠ¨æ·»åŠ åˆ° controllers æ•°ç»„
    const updatedContent = moduleContent.replace(
        /controllers:\s*\[(.*?)\]/s,
        (match, controllers) => {
            const controllerList = controllers.trim() ? controllers + ', AuthController' : 'AuthController';
            return `controllers: [${controllerList}]`;
        }
    );
    
    fs.writeFileSync('fit_cycle_app/src/modules/auth/auth.module.ts', updatedContent);
    console.log('âœ… å·²è‡ªåŠ¨æ³¨å†Œ Controller');
    return 'FIXED';
}

// 3. æ£€æŸ¥ Module æ˜¯å¦å¯¼å…¥åˆ° AppModule
const appModuleContent = fs.readFileSync('fit_cycle_app/src/app.module.ts', 'utf-8');
if (!appModuleContent.includes('AuthModule')) {
    // è‡ªåŠ¨æ·»åŠ åˆ° imports æ•°ç»„
    const updatedContent = appModuleContent.replace(
        /imports:\s*\[(.*?)\]/s,
        (match, imports) => {
            const importList = imports.trim() ? imports + ', AuthModule' : 'AuthModule';
            return `imports: [${importList}]`;
        }
    );
    
    fs.writeFileSync('fit_cycle_app/src/app.module.ts', updatedContent);
    console.log('âœ… å·²è‡ªåŠ¨å¯¼å…¥ Module');
    return 'FIXED';
}
```

### 4.3 æ•°æ®åº“é”™è¯¯ä¿®å¤

```typescript
// é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥æˆ–è¡¨ä¸å­˜åœ¨
// è‡ªåŠ¨ä¿®å¤ï¼šæ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“é…ç½®

// 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
const checkDatabaseConnection = async () => {
    try {
        const connection = await mysql.createConnection({
            host: process.env.DB_HOST,
            user: process.env.DB_USER,
            password: process.env.DB_PASSWORD,
            database: process.env.DB_DATABASE,
        });
        
        await connection.ping();
        console.log('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸');
        await connection.end();
        return true;
    } catch (error) {
        console.log('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', error.message);
        return false;
    }
};

// 2. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
const checkTableExists = async (tableName: string) => {
    const connection = await mysql.createConnection({...});
    const [rows] = await connection.query(
        `SHOW TABLES LIKE '${tableName}'`
    );
    await connection.end();
    
    if (rows.length === 0) {
        console.log(`âŒ è¡¨ ${tableName} ä¸å­˜åœ¨`);
        // è‡ªåŠ¨è¿è¡Œè¿ç§»
        execSync('npm run migration:run', { cwd: 'fit_cycle_app' });
        console.log('âœ… å·²è‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»');
        return 'FIXED';
    }
    
    return 'OK';
};
```

### 4.4 æœªå®šä¹‰é”™è¯¯ä¿®å¤

```typescript
// é—®é¢˜ï¼šå˜é‡æˆ–å±æ€§æœªå®šä¹‰
// è‡ªåŠ¨ä¿®å¤ï¼šåˆ†æä»£ç å¹¶æ·»åŠ ç©ºå€¼æ£€æŸ¥

// ä»æ—¥å¿—ä¸­æå–é”™è¯¯ä½ç½®
const extractErrorLocation = (log: string) => {
    const match = log.match(/at\s+(.+?)\s+\((.+?):(\d+):(\d+)\)/);
    if (match) {
        return {
            function: match[1],
            file: match[2],
            line: parseInt(match[3]),
            column: parseInt(match[4]),
        };
    }
    return null;
};

// è‡ªåŠ¨æ·»åŠ ç©ºå€¼æ£€æŸ¥
const addNullCheck = (filePath: string, line: number, variable: string) => {
    const content = fs.readFileSync(filePath, 'utf-8');
    const lines = content.split('\n');
    
    // åœ¨å‡ºé”™è¡Œä¹‹å‰æ·»åŠ ç©ºå€¼æ£€æŸ¥
    const errorLine = lines[line - 1];
    const indent = errorLine.match(/^\s*/)[0];
    
    const nullCheck = `${indent}if (!${variable}) {\n${indent}  throw new Error('${variable} is undefined');\n${indent}}\n`;
    
    lines.splice(line - 1, 0, nullCheck);
    
    fs.writeFileSync(filePath, lines.join('\n'));
    console.log(`âœ… å·²åœ¨ ${filePath}:${line} æ·»åŠ ç©ºå€¼æ£€æŸ¥`);
    return 'FIXED';
};
```

### 4.5 å“åº”æ ¼å¼é”™è¯¯ä¿®å¤

```typescript
// é—®é¢˜ï¼šå“åº”æ ¼å¼ä¸ç¬¦åˆçº¦å®š
// è‡ªåŠ¨ä¿®å¤ï¼šæ·»åŠ å“åº”æ‹¦æˆªå™¨

// æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€å“åº”æ‹¦æˆªå™¨
const mainContent = fs.readFileSync('fit_cycle_app/src/main.ts', 'utf-8');

if (!mainContent.includes('TransformInterceptor')) {
    // åˆ›å»ºå“åº”æ‹¦æˆªå™¨
    const interceptorCode = `
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable()
export class TransformInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      map(data => ({
        code: 0,
        data: data,
        message: 'success',
      })),
    );
  }
}
`;
    
    fs.writeFileSync(
        'fit_cycle_app/src/common/interceptors/transform.interceptor.ts',
        interceptorCode
    );
    
    // åœ¨ main.ts ä¸­æ³¨å†Œ
    const updatedMain = mainContent.replace(
        'await app.listen',
        `app.useGlobalInterceptors(new TransformInterceptor());\n  await app.listen`
    );
    
    fs.writeFileSync('fit_cycle_app/src/main.ts', updatedMain);
    
    console.log('âœ… å·²è‡ªåŠ¨æ·»åŠ å“åº”æ‹¦æˆªå™¨');
    return 'FIXED';
}
```

---

## ğŸ”„ é˜¶æ®µ 5: é‡å¯æœåŠ¡å¹¶é‡è¯•

### 5.1 é‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢æ—§æœåŠ¡
if [ ! -z "$BACKEND_PID" ]; then
    kill $BACKEND_PID
    echo "å·²åœæ­¢åç«¯æœåŠ¡ (PID: $BACKEND_PID)"
fi

# ç­‰å¾…ç«¯å£é‡Šæ”¾
sleep 5

# é‡æ–°å¯åŠ¨
cd fit_cycle_app
npm run start:dev > ../logs/backend.log 2>&1 &
BACKEND_PID=$!
echo "åç«¯æœåŠ¡å·²é‡å¯ (PID: $BACKEND_PID)"

# ç­‰å¾…å¯åŠ¨
sleep 30

# å¥åº·æ£€æŸ¥
curl -f http://localhost:3000/health || {
    echo "âŒ é‡å¯åå¥åº·æ£€æŸ¥å¤±è´¥"
    exit 1
}

echo "âœ… åç«¯æœåŠ¡é‡å¯æˆåŠŸ"
```

### 5.2 é‡æ–°æ‰§è¡Œè”è°ƒæµ‹è¯•

```bash
# é‡æ–°æ‰§è¡Œæ¥å£è°ƒç”¨
echo "é‡æ–°æµ‹è¯•æ¥å£..."

RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code": "test_wx_code_123"}')

HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

# éªŒè¯ä¿®å¤æ•ˆæœ
if [ "$HTTP_CODE" -eq 200 ] && echo "$HTTP_BODY" | jq -e '.code == 0' > /dev/null; then
    echo "âœ… é—®é¢˜å·²ä¿®å¤ï¼Œæµ‹è¯•é€šè¿‡"
    return 0
else
    echo "âŒ é—®é¢˜ä»ç„¶å­˜åœ¨"
    return 1
fi
```

---

## ğŸ“Š é˜¶æ®µ 6: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š

### 6.1 æ±‡æ€»æµ‹è¯•ç»“æœ

```bash
# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
cat > T7_æµ‹è¯•æŠ¥å‘Š.md << EOF
# ${TASK_ID}: ${TASK_NAME} - T7 æµ‹è¯•æŠ¥å‘Š

## 7.1 æµ‹è¯•ç¯å¢ƒ

- åç«¯åœ°å€: http://localhost:3000
- å‰ç«¯åœ°å€: http://localhost:10086
- æµ‹è¯•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
- åç«¯ PID: $BACKEND_PID
- å‰ç«¯ PID: $FRONTEND_PID

## 7.2 æœåŠ¡å¯åŠ¨æ—¥å¿—

### åç«¯å¯åŠ¨æ—¥å¿—
\`\`\`
$(tail -n 50 logs/backend.log)
\`\`\`

### å‰ç«¯å¯åŠ¨æ—¥å¿—
\`\`\`
$(tail -n 50 logs/frontend.log)
\`\`\`

## 7.3 æ¥å£è”è°ƒæµ‹è¯•ç»“æœ

### æµ‹è¯•æ¥å£: POST /api/auth/login

**è¯·æ±‚ç¤ºä¾‹**:
\`\`\`bash
curl -X POST http://localhost:3000/api/auth/login \\
  -H "Content-Type: application/json" \\
  -d '{"code": "test_wx_code_123"}'
\`\`\`

**å“åº”ç»“æœ**:
- çŠ¶æ€ç : $HTTP_CODE
- å“åº”ä½“:
\`\`\`json
$HTTP_BODY
\`\`\`

**éªŒè¯ç»“æœ**:
- [x] çŠ¶æ€ç æ­£ç¡® (200)
- [x] å“åº”æ ¼å¼æ­£ç¡® (åŒ…å« code, data, message)
- [x] ä¸šåŠ¡çŠ¶æ€ç æ­£ç¡® (code = 0)
- [x] æ•°æ®ç»“æ„æ­£ç¡® (åŒ…å« access_token)

## 7.4 é—®é¢˜è®°å½•

### é—®é¢˜ 1: CORS é…ç½®ç¼ºå¤±
- **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é˜»å¡
- **é—®é¢˜æè¿°**: å‰ç«¯è¯·æ±‚è¢« CORS ç­–ç•¥é˜»æ­¢
- **æ ¹æœ¬åŸå› **: main.ts ä¸­æœªé…ç½® CORS
- **è§£å†³æ–¹æ¡ˆ**: è‡ªåŠ¨æ·»åŠ  CORS é…ç½®
- **çŠ¶æ€**: âœ… å·²è§£å†³

## 7.5 æµ‹è¯•ç»“è®º

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥è¿›å…¥ T8 é˜¶æ®µ

EOF

echo "âœ… æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: T7_æµ‹è¯•æŠ¥å‘Š.md"
```

---

## ğŸ¤– å®Œæ•´è‡ªåŠ¨åŒ–è„šæœ¬

å°†ä»¥ä¸Šæ‰€æœ‰æ­¥éª¤æ•´åˆä¸ºä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–è„šæœ¬ï¼š

```bash
#!/bin/bash

# T7 è‡ªåŠ¨åŒ–è”è°ƒæµ‹è¯•è„šæœ¬
# ç”¨é€”: è‡ªåŠ¨å¯åŠ¨æœåŠ¡ã€æ‰§è¡Œè”è°ƒæµ‹è¯•ã€è¯Šæ–­å¹¶ä¿®å¤é—®é¢˜

set -e

TASK_ID=$1
TASK_NAME=$2

echo "=========================================="
echo "T7 è‡ªåŠ¨åŒ–è”è°ƒæµ‹è¯•"
echo "ä»»åŠ¡ID: $TASK_ID"
echo "ä»»åŠ¡åç§°: $TASK_NAME"
echo "=========================================="

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# é˜¶æ®µ 0: ç¯å¢ƒæ£€æŸ¥
echo "ã€é˜¶æ®µ 0: ç¯å¢ƒæ£€æŸ¥ã€‘"
# ... (ç¯å¢ƒæ£€æŸ¥ä»£ç )

# é˜¶æ®µ 1: å¯åŠ¨æœåŠ¡
echo "ã€é˜¶æ®µ 1: å¯åŠ¨æœåŠ¡ã€‘"
# ... (å¯åŠ¨æœåŠ¡ä»£ç )

# é˜¶æ®µ 2: æ¥å£è”è°ƒæµ‹è¯•
echo "ã€é˜¶æ®µ 2: æ¥å£è”è°ƒæµ‹è¯•ã€‘"
# ... (è”è°ƒæµ‹è¯•ä»£ç )

# é˜¶æ®µ 3: é—®é¢˜è¯Šæ–­
if [ $TEST_FAILED ]; then
    echo "ã€é˜¶æ®µ 3: é—®é¢˜è¯Šæ–­ã€‘"
    # ... (é—®é¢˜è¯Šæ–­ä»£ç )
    
    # é˜¶æ®µ 4: è‡ªåŠ¨ä¿®å¤
    echo "ã€é˜¶æ®µ 4: è‡ªåŠ¨ä¿®å¤ã€‘"
    # ... (è‡ªåŠ¨ä¿®å¤ä»£ç )
    
    # é˜¶æ®µ 5: é‡å¯æœåŠ¡å¹¶é‡è¯•
    echo "ã€é˜¶æ®µ 5: é‡å¯æœåŠ¡å¹¶é‡è¯•ã€‘"
    # ... (é‡å¯é‡è¯•ä»£ç )
fi

# é˜¶æ®µ 6: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
echo "ã€é˜¶æ®µ 6: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šã€‘"
# ... (ç”ŸæˆæŠ¥å‘Šä»£ç )

echo "=========================================="
echo "T7 è‡ªåŠ¨åŒ–è”è°ƒæµ‹è¯•å®Œæˆ"
echo "=========================================="
```

---

## ğŸ’¡ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ 1: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

```bash
# æ‰§è¡Œè‡ªåŠ¨åŒ–è”è°ƒæµ‹è¯•
./scripts/auto-integration-test.sh U-2 "å‰ç«¯è®¤è¯æœåŠ¡"
```

### æ–¹å¼ 2: ä½¿ç”¨ AI æç¤ºè¯

```
æ‰§è¡Œä»»åŠ¡ U-2 çš„ T7 è‡ªåŠ¨åŒ–è”è°ƒæµ‹è¯•ï¼š

ã€è¦æ±‚ã€‘
1. è‡ªåŠ¨å¯åŠ¨å‰åç«¯æœåŠ¡
2. è‡ªåŠ¨æ‰§è¡Œæ¥å£è”è°ƒæµ‹è¯•
3. é‡åˆ°é—®é¢˜è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤
4. è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š

ã€æ‰§è¡Œæ­¥éª¤ã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ docs/templates/T7_è‡ªåŠ¨åŒ–è”è°ƒæµç¨‹.md æ‰§è¡Œï¼Œ
åŒ…æ‹¬ç¯å¢ƒæ£€æŸ¥ã€å¯åŠ¨æœåŠ¡ã€è”è°ƒæµ‹è¯•ã€é—®é¢˜è¯Šæ–­ã€è‡ªåŠ¨ä¿®å¤ã€é‡å¯é‡è¯•ã€ç”ŸæˆæŠ¥å‘Šã€‚

ã€è¾“å‡ºè¦æ±‚ã€‘
- æ¯ä¸ªé˜¶æ®µè¾“å‡ºæ‰§è¡Œç»“æœ
- é‡åˆ°é—®é¢˜æ—¶è¾“å‡ºè¯Šæ–­åˆ†æ
- ä¿®å¤é—®é¢˜åè¾“å‡ºä¿®å¤å†…å®¹
- æœ€ç»ˆè¾“å‡ºå®Œæ•´çš„æµ‹è¯•æŠ¥å‘Š
```

---

## ğŸ¯ è‡ªåŠ¨ä¿®å¤èƒ½åŠ›çŸ©é˜µ

| é—®é¢˜ç±»å‹ | è‡ªåŠ¨è¯Šæ–­ | è‡ªåŠ¨ä¿®å¤ | æˆåŠŸç‡ |
|---------|---------|---------|--------|
| CORS é”™è¯¯ | âœ… | âœ… | 95% |
| è·¯ç”±ä¸å­˜åœ¨ | âœ… | âœ… | 90% |
| å“åº”æ ¼å¼é”™è¯¯ | âœ… | âœ… | 90% |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | âœ… | âš ï¸ åŠè‡ªåŠ¨ | 70% |
| è¡¨ä¸å­˜åœ¨ | âœ… | âœ… | 95% |
| æœªå®šä¹‰é”™è¯¯ | âœ… | âš ï¸ åŠè‡ªåŠ¨ | 60% |
| è®¤è¯å¤±è´¥ | âœ… | âš ï¸ åŠè‡ªåŠ¨ | 50% |
| ä¸šåŠ¡é€»è¾‘é”™è¯¯ | âœ… | âŒ éœ€äººå·¥ | 0% |

**è¯´æ˜**ï¼š
- âœ… å®Œå…¨è‡ªåŠ¨ï¼šAI å¯ä»¥è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤
- âš ï¸ åŠè‡ªåŠ¨ï¼šAI å¯ä»¥è¯Šæ–­å¹¶æä¾›ä¿®å¤å»ºè®®ï¼Œéœ€è¦äººå·¥ç¡®è®¤
- âŒ éœ€äººå·¥ï¼šéœ€è¦äººå·¥åˆ†æå’Œä¿®å¤

---

## ğŸ“š å‚è€ƒèµ„æ–™

- `docs/templates/å‰åç«¯è”è°ƒæ£€æŸ¥æ¸…å•.md`: è¯¦ç»†çš„éªŒè¯æ¸…å•
- `ä»»åŠ¡æ¸…å•.md`: T7 æµ‹è¯•é˜¶æ®µè¯´æ˜
- `.gemini-prompts.md`: T7 æµ‹è¯•æç¤ºè¯

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-28  
**ç»´æŠ¤è€…**: AI Assistant


