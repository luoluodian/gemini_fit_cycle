# T7 自动化联调 - Gemini CLI 快速开始指南

> **版本**: v1.0  
> **日期**: 2026-01-28  
> **适用工具**: Gemini CLI

---

## 🎯 核心理念

使用 Gemini CLI 时，AI 智能体可以**直接执行命令、读取文件、修改代码**，无需编写脚本！

---

## 🚀 快速开始

### 步骤 1: 复制提示词

打开文件：`docs/templates/T7_Gemini_CLI_自动化提示词.md`

复制完整的提示词模板。

### 步骤 2: 替换占位符

将以下占位符替换为实际值：
- `{task_id}` → 例如：`U-2`
- `{task_name}` → 例如：`前端认证服务`
- `{task_type}` → `后端` 或 `前端`

### 步骤 3: 在 Gemini CLI 中执行

```bash
gemini "执行任务 U-2 的 T7 自动化联调测试，
任务名称: 前端认证服务，
任务类型: 前端，
请参考 docs/templates/T7_Gemini_CLI_自动化提示词.md 完整执行"
```

---

## 📋 完整执行流程

AI 智能体会自动执行以下 9 个阶段：

### 阶段 0: 环境检查 ✅
- 检查当前目录
- 检查服务状态（端口 3000）
- 检查项目结构
- 检查依赖安装

### 阶段 1: 启动服务 ✅
- 创建日志目录
- 启动后端服务（后台运行）
- 等待服务启动（30秒）
- 健康检查

### 阶段 2: 读取接口规约 ✅
- 读取 T5 分析文档
- 读取接口规约文档
- 构造测试数据

### 阶段 3: 执行接口测试 ✅
- 执行 curl 请求
- 分离响应体和状态码
- 格式化 JSON 输出

### 阶段 4: 响应验证 ✅
- 验证状态码（200/201）
- 验证响应格式（JSON）
- 验证响应结构（code, data, message）
- 验证业务状态码（code = 0）
- 验证数据结构

### 阶段 5: 问题诊断 ⭐
如果验证失败：
- 分析错误类型
- 查看后端日志
- 搜索特定错误
- 诊断根本原因

### 阶段 6: 自动修复 ⭐
根据问题类型自动修复：
- CORS 错误 → 添加 CORS 配置
- Controller 未注册 → 注册到 Module
- Module 未导入 → 导入到 AppModule
- 响应格式错误 → 添加响应拦截器

### 阶段 7: 重启服务并重试 ✅
- 停止旧服务
- 清空日志
- 重新启动服务
- 重新执行测试
- 验证修复效果

### 阶段 8: 生成测试报告 ✅
- 创建报告目录
- 生成 T7_测试报告.md
- 更新看板状态

### 阶段 9: 清理与总结 ✅
- 询问是否停止服务
- 输出完整总结

---

## 💡 使用示例

### 示例 1: 后端接口测试

```bash
gemini "执行任务 U-1 的 T7 自动化联调测试：

任务信息:
- 任务ID: U-1
- 任务名称: 微信登录认证接口
- 任务类型: 后端

请按照 docs/templates/T7_Gemini_CLI_自动化提示词.md 完整执行，
包括环境检查、启动服务、执行测试、验证响应、问题诊断、自动修复、
重启重试、生成报告。

要求:
- 每个阶段输出执行结果
- 遇到问题自动诊断和修复
- 所有操作记录到报告"
```

### 示例 2: 前端联调测试

```bash
gemini "执行任务 U-2 的 T7 自动化联调测试：

任务信息:
- 任务ID: U-2
- 任务名称: 前端认证服务
- 任务类型: 前端

前提条件:
- 后端接口 U-1 已完成

请按照 docs/templates/T7_Gemini_CLI_自动化提示词.md 完整执行，
重点验证:
1. 接口调用是否成功
2. Token 是否正确返回
3. 响应格式是否符合契约
4. 错误处理是否正确

如果发现问题，自动修复并重新测试。"
```

---

## 🤖 AI 自动修复能力

| 问题类型 | 自动修复 | 成功率 |
|---------|---------|--------|
| CORS 错误 | ✅ 自动添加配置 | 95% |
| 路由不存在 | ✅ 自动注册 Controller | 90% |
| 响应格式错误 | ✅ 自动添加拦截器 | 90% |
| Controller 未注册 | ✅ 自动添加到 Module | 95% |
| Module 未导入 | ✅ 自动导入到 AppModule | 95% |
| 表不存在 | ✅ 自动运行迁移 | 85% |
| 数据库连接失败 | ⚠️ 提供修复建议 | 70% |
| 空值引用 | ⚠️ 提供修复建议 | 60% |
| 业务逻辑错误 | ❌ 需人工修复 | 0% |

---

## 📊 预期输出

### 成功场景输出示例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【T7 自动化联调测试总结】

任务: U-1 - 微信登录认证接口

✅ 测试通过: 5/5
❌ 测试失败: 0/5
🔧 自动修复: 0 项

验证结果:
✅ 状态码正确: 200
✅ 响应格式正确: JSON
✅ 响应结构正确: 包含 code, data, message
✅ 业务状态码正确: code = 0
✅ 数据结构正确: 包含 access_token

测试报告: docs/pj_docs/tasks/U-1/T7_测试报告.md
后端日志: logs/backend_U-1.log

下一步:
✅ 所有测试通过，可以执行 T8 审计阶段

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 失败并自动修复场景输出示例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【T7 自动化联调测试总结】

任务: U-1 - 微信登录认证接口

✅ 测试通过: 5/5
❌ 测试失败: 0/5（修复后通过）
🔧 自动修复: 2 项

问题列表:
1. CORS 配置缺失 - ✅ 已修复
2. Controller 未注册 - ✅ 已修复

修复记录:
1. 添加 CORS 配置到 main.ts - ✅ 成功
   文件: fit_cycle_app/src/main.ts
   内容: 添加 app.enableCors({...})
   
2. 注册 AuthController 到 AuthModule - ✅ 成功
   文件: fit_cycle_app/src/modules/auth/auth.module.ts
   内容: controllers: [AuthController]

修复前: 404 Not Found
修复后: 200 OK

测试报告: docs/pj_docs/tasks/U-1/T7_测试报告.md
后端日志: logs/backend_U-1.log

下一步:
✅ 所有测试通过，可以执行 T8 审计阶段

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔧 关键命令速查

### 服务管理
```bash
# 检查端口占用
lsof -i :3000

# 停止服务
lsof -ti :3000 | xargs kill -9

# 启动服务（后台）
cd fit_cycle_app && npm run start:dev > ../logs/backend.log 2>&1 &

# 查看日志
tail -f logs/backend.log
```

### 接口测试
```bash
# 测试接口
curl -s -w "\n%{http_code}" -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code": "test_wx_code_123"}'

# 格式化 JSON
echo '<json>' | jq .

# 提取字段
echo '<json>' | jq -r '.code'
```

### 日志分析
```bash
# 查看最近日志
tail -n 100 logs/backend.log

# 搜索错误
grep -i "error" logs/backend.log | tail -20

# 搜索特定关键词
grep -i "undefined\|null" logs/backend.log | tail -20
```

---

## 💡 最佳实践

### ✅ 推荐做法

1. **首次使用**
   - 完整阅读提示词模板
   - 理解每个阶段的作用
   - 观察 AI 的执行过程

2. **日常使用**
   - 直接使用完整提示词
   - 让 AI 自动处理常见问题
   - 专注于业务逻辑开发

3. **问题调试**
   - 查看 AI 输出的诊断分析
   - 查看后端日志文件
   - 必要时人工介入修复

### ❌ 避免做法

1. ❌ 不要跳过环境检查
2. ❌ 不要忽略 AI 的输出信息
3. ❌ 不要在未理解问题的情况下盲目修复
4. ❌ 不要忽略测试报告中的警告

---

## 📚 相关文档

### 核心文档
- **完整提示词**: `docs/templates/T7_Gemini_CLI_自动化提示词.md`
- **联调检查清单**: `docs/templates/前后端联调检查清单.md`
- **任务清单**: `任务清单.md`

### 参考文档
- **接口规约**: `docs/pj_docs/04_接口与数据规约.md`
- **架构设计**: `docs/pj_docs/03_系统架构设计方案.md`

---

## 🎉 总结

使用 Gemini CLI 进行 T7 自动化联调测试的优势：

1. ✅ **完全自动化** - 无需编写脚本
2. ✅ **智能诊断** - 自动分析问题
3. ✅ **自动修复** - 常见问题自动修复
4. ✅ **详细日志** - 完整的执行记录
5. ✅ **高成功率** - 70%+ 的问题可自动修复

**立即开始**: 复制提示词，替换占位符，在 Gemini CLI 中执行！🚀

---

**版本**: v1.0  
**最后更新**: 2026-01-28  
**维护者**: AI Assistant

