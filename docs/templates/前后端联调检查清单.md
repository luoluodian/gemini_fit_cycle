# 前后端联调检查清单

> **用途**: 确保前后端接口对接正确，数据流转正常  
> **使用时机**: 前端任务 T7 测试阶段 或 独立的 T7.5 联调阶段

---

## 📋 联调前准备

### 后端准备
- [ ] 后端服务已启动并可访问
- [ ] 数据库已初始化测试数据
- [ ] API 文档已更新（Swagger/接口规约文档）
- [ ] CORS 已正确配置
- [ ] 认证机制已就绪（如需要）

### 前端准备
- [ ] 已配置后端 API 地址（环境变量）
- [ ] 已实现对应的 Service 方法
- [ ] 已配置请求/响应拦截器
- [ ] 已准备测试账号（如需要）

---

## 🔗 接口契约验证

### 1. 请求验证

#### 1.1 请求路径
- [ ] 前端请求路径与后端路由一致
- [ ] 路径参数格式正确（如 `/user/:id`）
- [ ] 查询参数命名一致

**验证方法**：
```typescript
// 前端 Service
export const getUserProfile = (userId: string) => {
  return request.get(`/api/user/${userId}`); // ✅ 检查路径
};
```

```typescript
// 后端 Controller
@Get(':id')
async getUserProfile(@Param('id') id: string) { // ✅ 检查路径参数
  // ...
}
```

#### 1.2 请求方法
- [ ] HTTP 方法一致（GET/POST/PUT/DELETE）
- [ ] RESTful 规范符合约定

#### 1.3 请求头
- [ ] Content-Type 正确（通常为 `application/json`）
- [ ] Authorization 头正确（如需要）
- [ ] 自定义头部一致

**验证方法**：
```typescript
// 检查浏览器 Network 面板
// Request Headers:
// Content-Type: application/json
// Authorization: Bearer <token>
```

#### 1.4 请求体（Body）
- [ ] 字段名称一致（注意大小写）
- [ ] 字段类型一致（string/number/boolean/object/array）
- [ ] 必填字段都已传递
- [ ] 嵌套对象结构一致

**验证方法**：
```typescript
// 前端发送
const loginData = {
  code: 'wx_code_123',
  userInfo: {
    nickName: '张三',
    avatarUrl: 'https://...'
  }
};

// 后端 DTO
class WechatAuthDto {
  @IsString()
  code: string;

  @ValidateNested()
  userInfo: UserInfoDto;
}
```

---

### 2. 响应验证

#### 2.1 响应状态码
- [ ] 成功场景返回 200/201
- [ ] 客户端错误返回 400/401/403/404
- [ ] 服务器错误返回 500

#### 2.2 响应格式
- [ ] 响应格式符合约定（通常为统一响应体）
- [ ] 成功响应包含 `code`, `data`, `message`
- [ ] 错误响应包含 `code`, `message`

**验证方法**：
```typescript
// 约定的响应格式
interface ApiResponse<T> {
  code: number;
  data: T;
  message: string;
}

// 成功响应示例
{
  "code": 0,
  "data": {
    "userId": "123",
    "userName": "张三"
  },
  "message": "success"
}

// 错误响应示例
{
  "code": 40001,
  "message": "用户不存在"
}
```

#### 2.3 响应数据结构
- [ ] 字段名称一致
- [ ] 字段类型一致
- [ ] 必需字段都存在
- [ ] 可选字段处理正确（null/undefined）
- [ ] 数组数据结构正确
- [ ] 嵌套对象结构正确

**验证方法**：
```typescript
// 前端期望的数据结构
interface UserProfile {
  userId: string;
  userName: string;
  avatar?: string;
  createdAt: string;
}

// 后端返回的数据（检查是否匹配）
{
  "userId": "123",
  "userName": "张三",
  "avatar": "https://...",
  "createdAt": "2026-01-28T10:00:00Z"
}
```

#### 2.4 日期时间格式
- [ ] 日期格式一致（ISO 8601 推荐）
- [ ] 时区处理正确
- [ ] 前端能正确解析

---

## 🔐 认证与鉴权验证

### 3.1 Token 流程
- [ ] 登录成功后返回 `access_token` 和 `refresh_token`
- [ ] Token 正确存储（localStorage/sessionStorage）
- [ ] 请求拦截器正确添加 `Authorization` 头
- [ ] Token 过期后能自动刷新
- [ ] 刷新失败后跳转登录页

**验证方法**：
```typescript
// 1. 登录后检查 Storage
localStorage.getItem('access_token'); // ✅ 应该存在

// 2. 检查后续请求的 Header
// Network 面板查看:
// Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

// 3. 模拟 Token 过期（修改为无效 Token）
localStorage.setItem('access_token', 'invalid_token');
// 发起请求，应该触发刷新逻辑或跳转登录
```

### 3.2 权限控制
- [ ] 无权限访问返回 403
- [ ] 前端正确处理权限错误
- [ ] 路由守卫正确拦截

---

## 📊 数据流转验证

### 4.1 CRUD 操作
- [ ] **Create**: 创建成功后返回新数据（包含 ID）
- [ ] **Read**: 查询返回正确数据
- [ ] **Update**: 更新成功后返回最新数据
- [ ] **Delete**: 删除成功后返回确认信息

### 4.2 数据持久化
- [ ] 创建的数据能在数据库中查到
- [ ] 更新的数据已正确保存
- [ ] 删除的数据已从数据库移除
- [ ] 关联数据正确更新（如外键）

**验证方法**：
```sql
-- 在数据库中验证
SELECT * FROM users WHERE id = '123';
SELECT * FROM diet_logs WHERE user_id = '123';
```

### 4.3 分页查询
- [ ] 分页参数正确传递（page, pageSize）
- [ ] 返回总数（total）正确
- [ ] 返回数据条数符合 pageSize
- [ ] 前端分页组件正确显示

---

## ⚠️ 错误处理验证

### 5.1 客户端错误（4xx）
- [ ] 400 Bad Request: 参数错误时返回，前端显示错误提示
- [ ] 401 Unauthorized: 未登录时返回，前端跳转登录页
- [ ] 403 Forbidden: 无权限时返回，前端显示权限提示
- [ ] 404 Not Found: 资源不存在时返回，前端显示友好提示

### 5.2 服务器错误（5xx）
- [ ] 500 Internal Server Error: 前端显示通用错误提示
- [ ] 前端不会因为后端错误而崩溃

### 5.3 网络错误
- [ ] 请求超时: 前端显示超时提示
- [ ] 网络断开: 前端显示网络错误提示

**验证方法**：
```typescript
// 响应拦截器中处理错误
instance.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response) {
      // 服务器返回错误状态码
      const { status, data } = error.response;
      switch (status) {
        case 401:
          // ✅ 跳转登录页
          Taro.reLaunch({ url: '/pages/login/index' });
          break;
        case 403:
          // ✅ 显示权限提示
          Taro.showToast({ title: '无权限访问', icon: 'none' });
          break;
        // ...
      }
    } else if (error.request) {
      // ✅ 网络错误
      Taro.showToast({ title: '网络错误', icon: 'none' });
    }
    return Promise.reject(error);
  }
);
```

---

## 🧪 测试场景清单

### 6.1 正常流程测试
- [ ] 完整业务流程能走通
- [ ] 数据正确显示在界面上
- [ ] 用户操作得到正确反馈

### 6.2 边界条件测试
- [ ] 空数据列表显示正确
- [ ] 单条数据显示正确
- [ ] 大量数据（100+）显示正确
- [ ] 特殊字符处理正确

### 6.3 并发测试
- [ ] 快速连续点击不会重复提交
- [ ] 多个请求并发不会出错

---

## 📝 联调问题记录模板

```markdown
## 联调问题记录

### 问题 1: [简短描述]
- **发现时间**: 2026-01-28 10:30
- **严重程度**: 🔴 阻塞 / 🟡 重要 / 🟢 轻微
- **问题描述**: [详细描述]
- **前端表现**: [前端看到的现象]
- **后端日志**: [后端错误日志]
- **根本原因**: [分析后的原因]
- **解决方案**: [如何修复]
- **责任方**: 前端 / 后端 / 双方
- **状态**: ✅ 已解决 / 🏃 处理中 / 📅 待处理

### 问题 2: ...
```

---

## ✅ 联调完成标准

### 最低标准（必须满足）
- [ ] 所有接口调用成功（状态码 200/201）
- [ ] 核心业务流程能走通
- [ ] 数据能正确保存和读取
- [ ] 错误场景有友好提示

### 理想标准（建议满足）
- [ ] 所有边界条件都已测试
- [ ] 所有错误场景都已处理
- [ ] 性能指标符合要求（响应时间 < 1s）
- [ ] 无明显的用户体验问题

---

## 🛠️ 常用调试工具

### 浏览器工具
- **Network 面板**: 查看请求/响应详情
- **Console 面板**: 查看前端日志
- **Application 面板**: 查看 Storage 数据

### API 测试工具
- **Postman**: 独立测试后端接口
- **curl**: 命令行测试接口
- **Swagger UI**: 在线 API 文档和测试

### 抓包工具
- **Charles**: Mac/Windows 抓包工具
- **Fiddler**: Windows 抓包工具
- **Whistle**: 跨平台代理工具

---

## 📚 参考资料

- `docs/pj_docs/04_接口与数据规约.md`: 接口契约定义
- `fit_cycle_web/src/services/http/interceptors.ts`: 请求/响应拦截器
- `fit_cycle_app/src/common/filters/`: 后端异常过滤器

---

**版本**: v1.0  
**最后更新**: 2026-01-28  
**维护者**: AI Assistant

